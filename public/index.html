<!DOCTYPE html>
<html lang="en">
<head>
  <title>chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* â”€â”€ THEMES â”€â”€ */
    :root {
      --bg-outer:       #000080;
      --bg-window:      #c0c0c0;
      --bg-titlebar:    #000080;
      --bg-sidebar:     #000060;
      --bg-sidebar-hdr: #000040;
      --bg-messages:    #ffffff;
      --bg-input:       #ffffff;
      --bg-bottom:      #c0c0c0;
      --bg-users-panel: #c0c0c0;
      --border-main:    white #808080 #808080 white;
      --border-inset:   #808080;
      --text-main:      #000000;
      --text-titlebar:  #ffffff;
      --text-sidebar:   #c0c0ff;
      --text-sidebar-hdr: #aad4ff;
      --text-system:    #808080;
      --text-action:    #555555;
      --room-active-bg: #0000c0;
      --room-hover-bg:  #0000a0;
      --poll-bg:        #f0f0ff;
      --poll-border:    #000080;
      --poll-bar:       #000080;
      --poll-question:  #000080;
      --link-preview-bg: #f0f4ff;
      --link-preview-border: #c0c8e0;
      --link-preview-accent: #000080;
      --link-title-color: #000080;
      --typing-color:   #808080;
      --btn-bg:         #c0c0c0;
      --btn-border:     white #808080 #808080 white;
      --auth-bg:        #c0c0c0;
      --auth-tab-active-bg: #000080;
      --auth-input-bg:  #ffffff;
    }

    body.theme-dark {
      --bg-outer:       #0a0a0a;
      --bg-window:      #1a1a1a;
      --bg-titlebar:    #111111;
      --bg-sidebar:     #0d0d0d;
      --bg-sidebar-hdr: #080808;
      --bg-messages:    #141414;
      --bg-input:       #1e1e1e;
      --bg-bottom:      #1a1a1a;
      --bg-users-panel: #1a1a1a;
      --border-main:    #444 #111 #111 #444;
      --border-inset:   #333;
      --text-main:      #d0d0d0;
      --text-titlebar:  #e0e0e0;
      --text-sidebar:   #9090c0;
      --text-sidebar-hdr: #7090b0;
      --text-system:    #555;
      --text-action:    #777;
      --room-active-bg: #252535;
      --room-hover-bg:  #1e1e2e;
      --poll-bg:        #1e1e2e;
      --poll-border:    #4444aa;
      --poll-bar:       #4444aa;
      --poll-question:  #8888cc;
      --link-preview-bg: #1e1e28;
      --link-preview-border: #333355;
      --link-preview-accent: #4444aa;
      --link-title-color: #8888cc;
      --typing-color:   #555;
      --btn-bg:         #222;
      --btn-border:     #444 #111 #111 #444;
      --auth-bg:        #1a1a1a;
      --auth-tab-active-bg: #111;
      --auth-input-bg:  #222;
    }

    body.theme-hacker {
      --bg-outer:       #000000;
      --bg-window:      #0a0a0a;
      --bg-titlebar:    #001400;
      --bg-sidebar:     #001000;
      --bg-sidebar-hdr: #000800;
      --bg-messages:    #020802;
      --bg-input:       #001400;
      --bg-bottom:      #0a0a0a;
      --bg-users-panel: #0a0a0a;
      --border-main:    #00aa00 #003300 #003300 #00aa00;
      --border-inset:   #004400;
      --text-main:      #00cc00;
      --text-titlebar:  #00ff00;
      --text-sidebar:   #007700;
      --text-sidebar-hdr: #00aa00;
      --text-system:    #005500;
      --text-action:    #007700;
      --room-active-bg: #001f00;
      --room-hover-bg:  #001500;
      --poll-bg:        #001a00;
      --poll-border:    #007700;
      --poll-bar:       #00aa00;
      --poll-question:  #00cc00;
      --link-preview-bg: #001500;
      --link-preview-border: #005500;
      --link-preview-accent: #00aa00;
      --link-title-color: #00cc00;
      --typing-color:   #005500;
      --btn-bg:         #001400;
      --btn-border:     #00aa00 #003300 #003300 #00aa00;
      --auth-bg:        #0a0a0a;
      --auth-tab-active-bg: #001400;
      --auth-input-bg:  #001400;
    }

    body.theme-rose {
      --bg-outer:       #3d1a2e;
      --bg-window:      #f5e8ee;
      --bg-titlebar:    #7a2d52;
      --bg-sidebar:     #5c1f3d;
      --bg-sidebar-hdr: #3d1428;
      --bg-messages:    #fff5f8;
      --bg-input:       #fff0f5;
      --bg-bottom:      #f5e8ee;
      --bg-users-panel: #f5e8ee;
      --border-main:    #f0c0d8 #8a3060 #8a3060 #f0c0d8;
      --border-inset:   #c090a8;
      --text-main:      #3a1428;
      --text-titlebar:  #ffe0ee;
      --text-sidebar:   #f0b0cc;
      --text-sidebar-hdr: #f8d0e4;
      --text-system:    #b08090;
      --text-action:    #805060;
      --room-active-bg: #7a2d52;
      --room-hover-bg:  #5c1f3d;
      --poll-bg:        #fff0f8;
      --poll-border:    #cc5588;
      --poll-bar:       #cc5588;
      --poll-question:  #993366;
      --link-preview-bg: #fff5f9;
      --link-preview-border: #e8b0c8;
      --link-preview-accent: #cc5588;
      --link-title-color: #993366;
      --typing-color:   #c090a8;
      --btn-bg:         #f5e8ee;
      --btn-border:     #f0c0d8 #8a3060 #8a3060 #f0c0d8;
      --auth-bg:        #f5e8ee;
      --auth-tab-active-bg: #7a2d52;
      --auth-input-bg:  #fff5f8;
    }

    body {
      background-color: var(--bg-outer);
      font-family: 'VT323', monospace;
      font-size: 18px;
      color: var(--text-main);
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
    }

    /* â”€â”€ AUTH SCREEN â”€â”€ */
    #auth-screen {
      background: var(--auth-bg);
      color: var(--text-main);
      border: 3px solid;
      border-color: var(--border-main);
      width: 90%;
      max-width: 380px;
    }

    .auth-tabs {
      display: flex;
      border-bottom: 2px solid var(--border-inset);
    }

    .auth-tab {
      flex: 1;
      padding: 8px;
      background: #a0a0a0;
      border: none;
      font-family: 'VT323', monospace;
      font-size: 18px;
      cursor: pointer;
      border-right: 1px solid var(--border-inset);
      color: #444;
    }

    .auth-tab:last-child { border-right: none; }
    .auth-tab.active { background: var(--auth-tab-active-bg); color: white; }

    .auth-titlebar {
      background: var(--bg-titlebar);
      color: var(--text-titlebar);
      padding: 6px 10px;
      font-size: 18px;
      letter-spacing: 1px;
    }

    .auth-body { padding: 20px; }

    .auth-panel { display: none; }
    .auth-panel.active { display: block; }

    .auth-panel p { margin-bottom: 10px; font-size: 16px; }

    .auth-panel input {
      width: 100%;
      padding: 6px 8px;
      margin: 6px 0;
      font-family: 'VT323', monospace;
      font-size: 20px;
      border: 2px inset var(--border-inset);
      background: var(--auth-input-bg);
      color: var(--text-main);
    }

    .auth-panel button.primary {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      background: var(--bg-titlebar);
      color: var(--text-titlebar);
      border: 2px solid;
      border-color: var(--border-main);
      cursor: pointer;
      letter-spacing: 1px;
    }

    .auth-error {
      margin-top: 10px;
      color: #cc0000;
      font-size: 16px;
      min-height: 20px;
    }

    /* â”€â”€ COLOR PICKER â”€â”€ */
    .color-picker-label {
      display: block;
      font-size: 15px;
      margin: 8px 0 4px;
    }

    .color-swatches {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 6px;
    }

    .color-swatch {
      width: 24px;
      height: 24px;
      border: 2px solid transparent;
      cursor: pointer;
      border-radius: 2px;
    }

    .color-swatch.selected {
      border-color: black;
      outline: 1px solid white;
    }

    /* â”€â”€ CHAT SCREEN â”€â”€ */
    #chat-screen {
      display: none;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background: var(--bg-window);
      border: none;
      overflow: hidden;
      transition: background-color 0.2s;
    }

    @media (min-width: 700px) {
      #chat-screen {
        width: 760px;
        height: 90vh;
        border: 3px solid;
        border-color: var(--border-main);
      }
    }

    /* â”€â”€ LAYOUT â”€â”€ */
    #chat-layout {
      display: flex;
      flex: 1;
      height: calc(100% - 40px);
      overflow: hidden;
    }

    /* â”€â”€ ROOMS SIDEBAR â”€â”€ */
    #rooms-sidebar {
      width: 110px;
      background: var(--bg-sidebar);
      color: var(--text-sidebar);
      display: flex;
      flex-direction: column;
      border-right: 2px solid var(--border-inset);
      flex-shrink: 0;
    }

    #rooms-sidebar h3 {
      font-size: 14px;
      padding: 6px 8px;
      background: var(--bg-sidebar-hdr);
      border-bottom: 1px solid var(--border-inset);
      letter-spacing: 1px;
      color: var(--text-sidebar-hdr);
    }

    .room-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 8px;
      font-family: 'VT323', monospace;
      font-size: 16px;
      background: none;
      border: none;
      color: var(--text-sidebar);
      cursor: pointer;
      border-bottom: 1px solid var(--bg-sidebar-hdr);
    }

    .room-btn:hover { background: var(--room-hover-bg); }
    .room-btn.active { background: var(--room-active-bg); color: white; font-weight: bold; }
    .room-btn .room-unread {
      float: right;
      background: #cc0000;
      color: white;
      font-size: 12px;
      padding: 0 4px;
      border-radius: 2px;
      min-width: 16px;
      text-align: center;
    }

    /* â”€â”€ MAIN AREA â”€â”€ */
    #main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ TITLEBAR â”€â”€ */
    #titlebar {
      background: var(--bg-titlebar);
      color: var(--text-titlebar);
      padding: 0 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      letter-spacing: 1px;
      flex-shrink: 0;
      height: 40px;
      gap: 8px;
    }

    #titlebar-title {
      font-size: 18px;
      letter-spacing: 2px;
      flex-shrink: 0;
    }

    #titlebar-right {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: auto;
    }

    #logged-in-as {
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 4px;
    }

    /* â”€â”€ ICON BUTTONS â”€â”€ */
    .icon-btn {
      font-family: 'VT323', monospace;
      font-size: 16px;
      background: var(--btn-bg);
      color: var(--text-main);
      border: 2px solid;
      border-color: var(--btn-border);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      padding: 0;
      line-height: 1;
      position: relative;
    }

    .icon-btn:active { border-color: var(--border-inset) white white var(--border-inset); }

    .icon-btn.on { background: #006600; color: white; border-color: #0a0 #030 #030 #0a0; }
    .icon-btn.danger { background: #800000; color: white; border-color: #ff8080 #400000 #400000 #ff8080; }
    .icon-btn.danger:active { border-color: #400000 #ff8080 #ff8080 #400000; }

    /* Tooltip */
    .icon-btn[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: -26px;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      color: #fff;
      font-size: 12px;
      padding: 2px 6px;
      white-space: nowrap;
      z-index: 100;
      pointer-events: none;
      border: 1px solid #555;
    }

    /* user count stays wider */
    #user-count-btn {
      width: auto;
      padding: 0 8px;
      font-size: 14px;
    }

    /* â”€â”€ ONLINE USERS PANEL â”€â”€ */
    #users-panel {
      display: none;
      flex-wrap: wrap;
      gap: 4px 16px;
      padding: 6px 8px;
      background: var(--bg-users-panel);
      border-bottom: 2px inset var(--border-inset);
      font-size: 15px;
      color: var(--text-main);
      flex-shrink: 0;
    }

    #users-panel.visible { display: flex; }

    .user-entry .uname { font-weight: bold; }
    .user-entry .utime { color: var(--text-system); font-size: 13px; margin-left: 4px; }
    .user-entry .uidle { color: #aa6600; font-size: 13px; margin-left: 2px; }

    /* â”€â”€ MESSAGES â”€â”€ */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: var(--bg-messages);
      border: 2px inset var(--border-inset);
      margin: 8px 8px 0 8px;
      font-size: 18px;
      line-height: 1.6;
      -webkit-overflow-scrolling: touch;
      color: var(--text-main);
      transition: background-color 0.2s, color 0.2s;
    }

    .msg-action { color: var(--text-action); font-style: italic; }
    .msg-action .msg-user { color: var(--text-action); }
    .msg-system { color: var(--text-system); font-style: italic; }
    .msg-dm-row { background: #fff0f8; padding: 0 4px; border-left: 3px solid #cc0088; }
    .msg-dm-label { color: #cc0088; font-size: 15px; margin-right: 4px; }
    .msg-text { color: var(--text-main); }
    .msg-own .msg-user { opacity: 0.8; }
    .msg-kicked { color: #cc0000; font-style: italic; }

    body.theme-dark .msg-dm-row { background: #1a0a14; border-left-color: #aa0066; }
    body.theme-hacker .msg-dm-row { background: #001200; border-left-color: #00aa44; }
    body.theme-hacker .msg-dm-label { color: #00aa44; }
    body.theme-rose .msg-dm-row { background: #ffe8f4; border-left-color: #cc5588; }

    /* â”€â”€ TIMESTAMP (hover) â”€â”€ */
    .msg-row {
      position: relative;
      padding: 2px 0;
    }
    .msg-row:hover .msg-ts { display: inline; }
    .msg-ts {
      display: none;
      font-size: 12px;
      color: var(--text-system);
      margin-left: 8px;
    }

    /* â”€â”€ LINK PREVIEW â”€â”€ */
    .link-preview {
      display: inline-block;
      margin: 4px 0 2px 12px;
      padding: 6px 10px;
      background: var(--link-preview-bg);
      border: 1px solid var(--link-preview-border);
      border-left: 3px solid var(--link-preview-accent);
      font-size: 15px;
      max-width: 420px;
      color: var(--text-main);
    }

    .link-preview img {
      max-width: 100%;
      max-height: 80px;
      display: block;
      margin-bottom: 4px;
    }

    .link-preview .lp-title { font-weight: bold; color: var(--link-title-color); }
    .link-preview .lp-desc { color: var(--text-system); font-size: 13px; }

    /* â”€â”€ POLL â”€â”€ */
    .poll-card {
      background: var(--poll-bg);
      border: 2px solid var(--poll-border);
      margin: 6px 0;
      padding: 8px 12px;
      font-size: 16px;
      color: var(--text-main);
    }

    .poll-card.poll-concluded {
      opacity: 0.75;
      border-color: var(--border-inset);
      background: var(--bg-messages);
    }

    .poll-question { font-weight: bold; color: var(--poll-question); margin-bottom: 6px; font-size: 17px; }

    .poll-option {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 3px 0;
      cursor: pointer;
    }

    .poll-option:hover .poll-opt-label { text-decoration: underline; }
    .poll-option.voted .poll-opt-label { color: var(--poll-question); font-weight: bold; }
    .poll-option.concluded { cursor: default; pointer-events: none; }

    .poll-bar-wrap {
      flex: 1;
      height: 14px;
      background: var(--border-inset);
      border: 1px solid var(--border-inset);
      overflow: hidden;
    }

    .poll-bar {
      height: 100%;
      background: var(--poll-bar);
      transition: width 0.3s;
    }

    .poll-card.poll-concluded .poll-bar { background: var(--border-inset); }
    .poll-option.winner .poll-bar { background: #007700; }
    .poll-option.winner .poll-opt-label { color: #007700; font-weight: bold; }

    .poll-pct { font-size: 13px; color: var(--text-system); width: 36px; text-align: right; }
    .poll-opt-label { min-width: 80px; }
    .poll-meta { font-size: 13px; color: var(--text-system); margin-top: 4px; }
    .poll-timer { color: #cc6600; font-size: 13px; }
    .poll-timer.urgent { color: #cc0000; font-weight: bold; }

    /* â”€â”€ TYPING INDICATOR â”€â”€ */
    #typing-bar {
      min-height: 22px;
      padding: 2px 10px;
      margin: 0 8px;
      font-size: 14px;
      color: var(--typing-color);
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }

    .dots span {
      display: inline-block;
      width: 4px;
      height: 4px;
      background: var(--typing-color);
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .dots span:nth-child(2) { animation-delay: .2s; }
    .dots span:nth-child(3) { animation-delay: .4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: .4; }
      40%            { transform: translateY(-4px); opacity: 1; }
    }

    #bottom {
      display: flex;
      gap: 6px;
      padding: 8px;
      flex-shrink: 0;
      background: var(--bg-bottom);
    }

    #input {
      flex: 1;
      padding: 8px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      border: 2px inset var(--border-inset);
      min-width: 0;
      color: var(--text-main);
      background: var(--bg-input);
    }

    #send-btn {
      padding: 8px 16px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      background: var(--btn-bg);
      color: var(--text-main);
      border: 2px solid;
      border-color: var(--btn-border);
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    #send-btn:active { border-color: var(--border-inset) white white var(--border-inset); }

    /* â”€â”€ DM FLASH â”€â”€ */
    .dm-flash { animation: flash 0.4s 3; }
    @keyframes flash {
      0%, 100% { background: #fff0f8; }
      50% { background: #ffccee; }
    }

    /* â”€â”€ SETTINGS MODAL â”€â”€ */
    #settings-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    #settings-overlay.open { display: flex; }

    #settings-modal {
      background: var(--bg-window);
      border: 3px solid;
      border-color: var(--border-main);
      width: 90%;
      max-width: 360px;
      font-family: 'VT323', monospace;
      color: var(--text-main);
    }

    #settings-titlebar {
      background: var(--bg-titlebar);
      color: var(--text-titlebar);
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      letter-spacing: 1px;
    }

    #settings-close-btn {
      font-family: 'VT323', monospace;
      font-size: 16px;
      background: #800000;
      color: white;
      border: 2px solid;
      border-color: #ff8080 #400000 #400000 #ff8080;
      width: 22px;
      height: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
    }

    #settings-body {
      padding: 16px;
    }

    .settings-section {
      margin-bottom: 16px;
    }

    .settings-label {
      font-size: 16px;
      margin-bottom: 6px;
      display: block;
      color: var(--text-main);
      letter-spacing: 1px;
    }

    /* â”€â”€ THEME PICKER â”€â”€ */
    .theme-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .theme-btn {
      font-family: 'VT323', monospace;
      font-size: 16px;
      padding: 8px 6px;
      border: 2px solid;
      cursor: pointer;
      letter-spacing: 1px;
      transition: opacity 0.1s;
      text-align: center;
    }

    .theme-btn.theme-opt-classic {
      background: #000080; color: white;
      border-color: #6060c0 #000040 #000040 #6060c0;
    }
    .theme-btn.theme-opt-dark {
      background: #1a1a1a; color: #d0d0d0;
      border-color: #444 #111 #111 #444;
    }
    .theme-btn.theme-opt-hacker {
      background: #001400; color: #00cc00;
      border-color: #00aa00 #003300 #003300 #00aa00;
    }
    .theme-btn.theme-opt-rose {
      background: #7a2d52; color: #ffe0ee;
      border-color: #f0a0c0 #3d1428 #3d1428 #f0a0c0;
    }

    .theme-btn.selected {
      outline: 2px solid white;
      outline-offset: 1px;
    }

    .theme-btn:active { opacity: 0.7; }

    /* â”€â”€ SETTINGS COLOR PICKER â”€â”€ */
    #settings-color-swatches {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .settings-save-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .settings-btn {
      flex: 1;
      padding: 8px;
      font-family: 'VT323', monospace;
      font-size: 18px;
      background: var(--bg-titlebar);
      color: var(--text-titlebar);
      border: 2px solid;
      border-color: var(--border-main);
      cursor: pointer;
      letter-spacing: 1px;
    }

    .settings-status {
      font-size: 14px;
      color: #007700;
      min-height: 18px;
      margin-top: 6px;
      text-align: center;
    }

    body.theme-hacker .settings-status { color: #00cc00; }
  </style>
</head>
<body>

  <!-- Auth Screen -->
  <div id="auth-screen">
    <div class="auth-titlebar">
      chatroom
      <span style="font-size:13px;opacity:0.5;float:right;line-height:1.8">v1.0</span>
    </div>
    <div style="background:#a8a8a8;color:#333;font-size:13px;padding:6px 10px;border-bottom:1px solid #808080;font-family:'VT323',monospace;">
      âš  This chatroom is for invited users only. Be respectful at all times.
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">Login</button>
      <button class="auth-tab" onclick="switchTab('register')">Register</button>
    </div>
    <div class="auth-body">
      <!-- Login -->
      <div id="login-panel" class="auth-panel active">
        <p>Sign in to your account:</p>
        <input id="login-username" type="text" placeholder="Username..." maxlength="20" autocomplete="username" />
        <input id="login-password" type="password" placeholder="Password..." autocomplete="current-password" />
        <button class="primary" onclick="doLogin()">Login</button>
        <div class="auth-error" id="login-error"></div>
      </div>
      <!-- Register -->
      <div id="register-panel" class="auth-panel">
        <p>Create a new account:</p>
        <input id="reg-username" type="text" placeholder="Username (3-20 chars)..." maxlength="20" autocomplete="username" />
        <input id="reg-password" type="password" placeholder="Password (min 6 chars)..." autocomplete="new-password" />
        <input id="reg-password2" type="password" placeholder="Confirm password..." autocomplete="new-password" />
        <span class="color-picker-label">Pick your name colour:</span>
        <div class="color-swatches" id="color-swatches"></div>
        <input type="hidden" id="reg-color" value="#000080" />
        <button class="primary" onclick="doRegister()">Create Account</button>
        <div class="auth-error" id="register-error"></div>
      </div>
    </div>
  </div>

  <!-- Chat Screen -->
  <div id="chat-screen">
    <div id="titlebar">
      <span id="titlebar-title">chatroom</span>
      <div id="titlebar-right">
        <span id="logged-in-as"></span>
        <button id="user-count-btn" class="icon-btn" onclick="toggleUsers()" title="Online users">ğŸ‘¤ 0</button>
        <button id="sound-btn" class="icon-btn on" onclick="toggleSound()" title="Toggle SFX">ğŸ”Š</button>
        <button id="settings-btn" class="icon-btn" onclick="openSettings()" title="Settings">âš™</button>
        <button id="logout-btn" class="icon-btn danger" onclick="doLogout()" title="Exit">âœ•</button>
      </div>
    </div>

    <div id="chat-layout">
      <div id="rooms-sidebar">
        <h3>ROOMS</h3>
        <div id="rooms-list"></div>
      </div>

      <div id="main-area">
        <div id="users-panel"></div>
        <ul id="messages"></ul>
        <div id="typing-bar"></div>
        <div id="bottom">
          <input id="input" placeholder="Type a message, /me, /msg, /poll..." autocomplete="off" />
          <button id="send-btn" onclick="send()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-overlay">
    <div id="settings-modal">
      <div id="settings-titlebar">
        <span>âš™ Settings</span>
        <button id="settings-close-btn" onclick="closeSettings()">âœ•</button>
      </div>
      <div id="settings-body">

        <div class="settings-section">
          <span class="settings-label">Theme</span>
          <div class="theme-options">
            <button class="theme-btn theme-opt-classic selected" data-theme="classic" onclick="selectTheme('classic')">Classic</button>
            <button class="theme-btn theme-opt-dark" data-theme="dark" onclick="selectTheme('dark')">Dark</button>
            <button class="theme-btn theme-opt-hacker" data-theme="hacker" onclick="selectTheme('hacker')">Hacker</button>
            <button class="theme-btn theme-opt-rose" data-theme="rose" onclick="selectTheme('rose')">Rose</button>
          </div>
        </div>

        <div class="settings-section">
          <span class="settings-label">Username Colour</span>
          <div id="settings-color-swatches"></div>
        </div>

        <div class="settings-save-row">
          <button class="settings-btn" onclick="saveSettings()">Save</button>
        </div>
        <div class="settings-status" id="settings-status"></div>

      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // â”€â”€ WEB AUDIO SOUNDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let soundEnabled = true;
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let actx = null;

    function getActx() {
      if (!actx) actx = new AudioContext();
      return actx;
    }

    function playTone(freq, type, duration, vol = 0.15, delay = 0) {
      if (!soundEnabled) return;
      try {
        const ctx = getActx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime + delay);
        gain.gain.setValueAtTime(vol, ctx.currentTime + delay);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + duration);
        osc.start(ctx.currentTime + delay);
        osc.stop(ctx.currentTime + delay + duration + 0.01);
      } catch {}
    }

    function soundMessage() { playTone(880, 'square', 0.06, 0.1); }
    function soundJoin() {
      playTone(523, 'sine', 0.15, 0.12);
      playTone(659, 'sine', 0.15, 0.12, 0.12);
      playTone(784, 'sine', 0.2, 0.14, 0.24);
    }
    function soundLeave() {
      playTone(784, 'sine', 0.12, 0.1);
      playTone(523, 'sine', 0.2, 0.1, 0.14);
    }
    function soundDM() {
      playTone(1046, 'square', 0.08, 0.1);
      playTone(1318, 'square', 0.12, 0.12, 0.1);
    }
    function soundPollEnd() {
      playTone(659, 'sine', 0.1, 0.12);
      playTone(784, 'sine', 0.1, 0.12, 0.1);
      playTone(1046, 'sine', 0.3, 0.15, 0.2);
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('sound-btn');
      btn.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
      btn.classList.toggle('on', soundEnabled);
      btn.title = soundEnabled ? 'Toggle SFX' : 'Toggle SFX (off)';
    }

    // â”€â”€ COLORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const COLORS = [
      '#000080','#800000','#008000','#800080','#008080',
      '#0000cc','#cc0000','#007700','#aa00aa','#007777',
      '#cc6600','#006699','#990000','#009900','#660099',
    ];

    let selectedColor = '#000080';
    let selectedSettingsColor = '#000080';
    let selectedTheme = 'classic';

    function buildColorSwatches() {
      const wrap = document.getElementById('color-swatches');
      COLORS.forEach(c => {
        const div = document.createElement('div');
        div.className = 'color-swatch' + (c === selectedColor ? ' selected' : '');
        div.style.background = c;
        div.title = c;
        div.onclick = () => {
          selectedColor = c;
          document.getElementById('reg-color').value = c;
          wrap.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
          div.classList.add('selected');
        };
        wrap.appendChild(div);
      });
    }

    function buildSettingsColorSwatches(currentColor) {
      selectedSettingsColor = currentColor;
      const wrap = document.getElementById('settings-color-swatches');
      wrap.innerHTML = '';
      COLORS.forEach(c => {
        const div = document.createElement('div');
        div.className = 'color-swatch' + (c === currentColor ? ' selected' : '');
        div.style.background = c;
        div.title = c;
        div.onclick = () => {
          selectedSettingsColor = c;
          wrap.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
          div.classList.add('selected');
        };
        wrap.appendChild(div);
      });
    }

    buildColorSwatches();

    // â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyTheme(theme) {
      document.body.className = document.body.className
        .replace(/theme-\w+/g, '')
        .trim();
      if (theme !== 'classic') {
        document.body.classList.add('theme-' + theme);
      }
      selectedTheme = theme;
      // Update selected state on theme buttons
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.theme === theme);
      });
    }

    function selectTheme(theme) {
      applyTheme(theme);
    }

    // â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openSettings() {
      buildSettingsColorSwatches(myColor);
      applyThemeButtonState(selectedTheme);
      document.getElementById('settings-status').textContent = '';
      document.getElementById('settings-overlay').classList.add('open');
    }

    function closeSettings() {
      document.getElementById('settings-overlay').classList.remove('open');
    }

    function applyThemeButtonState(theme) {
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.theme === theme);
      });
    }

    async function saveSettings() {
      const statusEl = document.getElementById('settings-status');
      statusEl.textContent = 'Saving...';
      statusEl.style.color = 'inherit';

      try {
        const res = await fetch('/settings', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ color: selectedSettingsColor, theme: selectedTheme }),
        });
        const data = await res.json();
        if (!res.ok) { statusEl.textContent = data.error; statusEl.style.color = '#cc0000'; return; }

        // Apply color change locally
        myColor = selectedSettingsColor;
        document.getElementById('logged-in-as').innerHTML =
          `<span style="color:${myColor};text-shadow:0 0 2px rgba(255,255,255,0.5)">${myUsername}</span>`;

        statusEl.textContent = 'Saved!';
        statusEl.style.color = '#007700';
        setTimeout(() => { statusEl.textContent = ''; }, 2000);
      } catch {
        statusEl.textContent = 'Error saving.';
        statusEl.style.color = '#cc0000';
      }
    }

    // Close modal on overlay click
    document.getElementById('settings-overlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('settings-overlay')) closeSettings();
    });

    // Escape key closes modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeSettings();
    });

    // â”€â”€ SOCKET & STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const socket = io({ autoConnect: false });
    let myUsername = null;
    let myColor = '#000080';
    let currentRoom = 'general';
    let usersVisible = false;
    let isTyping = false;
    let typingTimer;
    const unreadCounts = {};
    const polls = {};

    // â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchTab(tab) {
      document.querySelectorAll('.auth-tab').forEach((t, i) => {
        t.classList.toggle('active', (i === 0) === (tab === 'login'));
      });
      document.getElementById('login-panel').classList.toggle('active', tab === 'login');
      document.getElementById('register-panel').classList.toggle('active', tab === 'register');
    }

    // â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function doLogin() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errEl = document.getElementById('login-error');
      errEl.textContent = '';
      if (!username || !password) { errEl.textContent = 'Please fill in all fields.'; return; }
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok) { errEl.textContent = data.error; return; }
      enterChat(data.username, data.color || '#000080', data.theme || 'classic', data.token);
    }

    async function doRegister() {
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const password2 = document.getElementById('reg-password2').value;
      const color = document.getElementById('reg-color').value;
      const errEl = document.getElementById('register-error');
      errEl.textContent = '';
      if (!username || !password || !password2) { errEl.textContent = 'Please fill in all fields.'; return; }
      if (password !== password2) { errEl.textContent = 'Passwords do not match.'; return; }
      const res = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, color })
      });
      const data = await res.json();
      if (!res.ok) { errEl.textContent = data.error; return; }
      enterChat(data.username, data.color || '#000080', data.theme || 'classic', data.token);
    }

    async function doLogout() {
      await fetch('/logout', { method: 'POST' });
      socket.disconnect();
      location.reload();
    }

    // â”€â”€ ENTER CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function enterChat(username, color, theme, token) {
      myUsername = username;
      myColor = color || '#000080';

      // Apply saved theme
      applyTheme(theme || 'classic');

      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'block';
      document.getElementById('logged-in-as').innerHTML =
        `<span style="color:${myColor};text-shadow:0 0 2px rgba(255,255,255,0.5)">${username}</span>`;
      document.getElementById('input').focus();

      socket.connect();
      socket.once('connect', () => { socket.emit('join', token); });
    }

    // â”€â”€ ROOMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRooms(rooms) {
      const list = document.getElementById('rooms-list');
      list.innerHTML = '';
      rooms.forEach(room => {
        const btn = document.createElement('button');
        btn.className = 'room-btn' + (room === currentRoom ? ' active' : '');
        btn.dataset.room = room;
        btn.innerHTML = `#${room}`;
        if (unreadCounts[room]) {
          btn.innerHTML += `<span class="room-unread">${unreadCounts[room]}</span>`;
        }
        btn.onclick = () => switchRoom(room);
        list.appendChild(btn);
      });
    }

    function switchRoom(room) {
      if (room === currentRoom) return;
      document.getElementById('messages').innerHTML = '';
      currentRoom = room;
      socket.emit('switch room', room);
      unreadCounts[room] = 0;
    }

    // â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function send() {
      const input = document.getElementById('input');
      const text = input.value.trim();
      if (!text) return;
      socket.emit('chat message', text);
      input.value = '';
      stopTyping();
    }

    // â”€â”€ TYPING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('input').addEventListener('input', () => {
      socket.emit('activity');
      if (!isTyping) { isTyping = true; socket.emit('typing start'); }
      clearTimeout(typingTimer);
      typingTimer = setTimeout(stopTyping, 2000);
    });

    function stopTyping() {
      if (!isTyping) return;
      isTyping = false;
      clearTimeout(typingTimer);
      socket.emit('typing stop');
    }

    // â”€â”€ USERS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleUsers() {
      usersVisible = !usersVisible;
      document.getElementById('users-panel').classList.toggle('visible', usersVisible);
    }

    // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function formatDuration(ms) {
      const total = Math.floor(ms / 1000);
      const d = Math.floor(total / 86400), h = Math.floor((total % 86400) / 3600);
      const m = Math.floor((total % 3600) / 60), s = total % 60;
      if (d > 0) return d + "D " + h + "HR " + m + "M";
      if (h > 0) return h + "HR " + m + "M";
      if (m > 0) return m + "M " + s + "S";
      return s + "S";
    }

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function addMessage(html, extraClass = '', timestamp = null) {
      const messages = document.getElementById('messages');
      const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
      const li = document.createElement('li');
      li.style.listStyle = 'none';
      li.className = 'msg-row' + (extraClass ? ' ' + extraClass : '');
      const ts = timestamp ? `<span class="msg-ts">${formatTime(timestamp)}</span>` : '';
      li.innerHTML = html + ts;
      messages.appendChild(li);
      if (atBottom) messages.scrollTop = messages.scrollHeight;
      return li;
    }

    function addDmMessage(data) {
      const messages = document.getElementById('messages');
      const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
      const li = document.createElement('li');
      li.style.listStyle = 'none';
      li.className = 'msg-row msg-dm-row' + (!data.noFlash && !data.self ? ' dm-flash' : '');
      const label = data.self
        ? `<span class="msg-dm-label">â†’ DM to ${data.to}:</span>`
        : `<span class="msg-dm-label">DM from ${data.from}:</span>`;
      li.innerHTML = label + `<span class="msg-text">${data.text}</span>`;
      messages.appendChild(li);
      if (atBottom) messages.scrollTop = messages.scrollHeight;
      if (!data.noFlash && !data.self) soundDM();
    }

    // â”€â”€ POLLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPoll(poll) {
      polls[poll.id] = poll;
      const existing = document.getElementById(`poll-${poll.id}`);
      if (existing) {
        existing.innerHTML = buildPollHtml(poll);
        return;
      }
      const messages = document.getElementById('messages');
      const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
      const li = document.createElement('li');
      li.style.listStyle = 'none';
      li.id = `poll-${poll.id}`;
      li.className = 'msg-row';
      li.innerHTML = buildPollHtml(poll);
      messages.appendChild(li);
      if (atBottom) messages.scrollTop = messages.scrollHeight;
    }

    function buildPollHtml(poll) {
      const totalVotes = Object.keys(poll.votes || {}).length;
      const myVote = (poll.votes || {})[myUsername];
      const concluded = poll.concluded;

      let topCount = 0;
      if (concluded && totalVotes > 0) {
        const tally = {};
        poll.options.forEach(o => tally[o] = 0);
        Object.values(poll.votes || {}).forEach(v => { if (tally[v] !== undefined) tally[v]++; });
        topCount = Math.max(...Object.values(tally));
      }

      const optionsHtml = poll.options.map(opt => {
        const count = Object.values(poll.votes || {}).filter(v => v === opt).length;
        const pct = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
        const isVoted = myVote === opt;
        const isWinner = concluded && totalVotes > 0 && count === topCount;
        const classes = [
          'poll-option',
          isVoted ? 'voted' : '',
          concluded ? 'concluded' : '',
          isWinner ? 'winner' : '',
        ].filter(Boolean).join(' ');

        return `<div class="${classes}" onclick="${concluded ? '' : `castVote(${poll.id}, '${opt.replace(/'/g, "\\'")}')`}">
          <span class="poll-opt-label">${isWinner ? 'ğŸ† ' : ''}${opt}</span>
          <div class="poll-bar-wrap"><div class="poll-bar" style="width:${pct}%"></div></div>
          <span class="poll-pct">${pct}%</span>
          <span style="font-size:13px;color:var(--text-system)">${count}</span>
        </div>`;
      }).join('');

      let timerHtml = '';
      if (!concluded && poll.endsAt) {
        timerHtml = `<span class="poll-timer" data-ends="${new Date(poll.endsAt).getTime()}">...</span>`;
      } else if (concluded) {
        timerHtml = `<span style="color:var(--text-system)">concluded</span>`;
      }

      return `<div class="poll-card${concluded ? ' poll-concluded' : ''}">
        <div class="poll-question">ğŸ“Š ${poll.question}</div>
        ${optionsHtml}
        <div class="poll-meta">by ${poll.creator} Â· ${totalVotes} vote${totalVotes !== 1 ? 's' : ''} Â· ${timerHtml}</div>
      </div>`;
    }

    function castVote(pollId, option) {
      socket.emit('poll vote', { pollId, option });
    }

    // â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHistory(history) {
      const messages = document.getElementById('messages');
      messages.innerHTML = '';
      if (history.length === 0) return;
      addMessage(`<span class="msg-system">â”€â”€ message history â”€â”€</span>`);
      history.forEach(row => {
        const ts = new Date(row.created_at).getTime();
        if (row.type === 'action') {
          addMessage(
            `<span class="msg-action">*** <span class="msg-user" style="color:${row.color}">${row.sender}</span> ${row.text} ***</span>`,
            '', ts
          );
        } else if (row.type === 'dm') {
          const isSelf = row.sender === myUsername;
          addDmMessage({
            from: row.sender,
            to: row.recipient,
            text: row.text,
            self: isSelf,
            noFlash: true,
          });
        } else {
          const isOwn = row.sender === myUsername;
          addMessage(
            `<span class="msg-user" style="color:${row.color}">${row.sender}:</span> <span class="msg-text">${row.text}</span>`,
            isOwn ? 'msg-own' : '', ts
          );
        }
      });
      addMessage(`<span class="msg-system">â”€â”€ live â”€â”€</span>`);
      messages.scrollTop = messages.scrollHeight;
    }

    // â”€â”€ SOCKET EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('rooms list', (rooms) => { renderRooms(rooms); });

    socket.on('room changed', (room) => {
      currentRoom = room;
      renderRooms([...document.querySelectorAll('.room-btn')].map(b => b.dataset.room));
    });

    socket.on('history', (history) => { renderHistory(history); });

    socket.on('chat message', ({ user, color, text, type, timestamp }) => {
      const isOwn = user === myUsername;
      if (type === 'action') {
        addMessage(
          `<span class="msg-action">*** <span class="msg-user" style="color:${color}">${user}</span> ${text} ***</span>`,
          '', timestamp
        );
      } else {
        addMessage(
          `<span class="msg-user" style="color:${color}">${user}:</span> <span class="msg-text">${text}</span>`,
          isOwn ? 'msg-own' : '', timestamp || Date.now()
        );
      }
      if (!isOwn) soundMessage();
    });

    socket.on('system message', (msg) => {
      const isJoin = /has joined/.test(msg);
      const isLeave = /has left/.test(msg);
      addMessage(`<span class="msg-system">*** ${msg} ***</span>`);
      if (isJoin) soundJoin();
      else if (isLeave) soundLeave();
    });

    socket.on('dm', (data) => { addDmMessage(data); });

    socket.on('link preview', ({ url, title, image, description }) => {
      const messages = document.getElementById('messages');
      const rows = messages.querySelectorAll('.msg-row');
      let target = null;
      for (let i = rows.length - 1; i >= 0; i--) {
        if (rows[i].textContent.includes(url.slice(8, 40))) { target = rows[i]; break; }
      }
      const previewEl = document.createElement('div');
      previewEl.className = 'link-preview';
      let html = '';
      if (image) html += `<img src="${image}" alt="" onerror="this.style.display='none'">`;
      if (title) html += `<div class="lp-title">${title}</div>`;
      if (description) html += `<div class="lp-desc">${description}</div>`;
      previewEl.innerHTML = html;
      const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
      if (target) {
        target.appendChild(previewEl);
      } else {
        const li = document.createElement('li');
        li.style.listStyle = 'none';
        li.appendChild(previewEl);
        messages.appendChild(li);
      }
      if (atBottom) messages.scrollTop = messages.scrollHeight;
    });

    socket.on('poll update', (poll) => { renderPoll(poll); });

    socket.on('poll concluded', ({ pollId }) => {
      if (polls[pollId]) {
        polls[pollId].concluded = true;
        const el = document.getElementById(`poll-${pollId}`);
        if (el) el.innerHTML = buildPollHtml(polls[pollId]);
        soundPollEnd();
      }
    });

    socket.on('user list', (list) => {
      document.getElementById('user-count-btn').textContent = `ğŸ‘¤ ${list.length}`;
      const panel = document.getElementById('users-panel');
      panel.innerHTML = '';
      list.forEach(({ username, color, joinedAt, idle }) => {
        const entry = document.createElement('span');
        entry.className = 'user-entry';
        entry.dataset.joinedAt = joinedAt;
        entry.innerHTML =
          `<span class="uname" style="color:${color}">${username}</span>` +
          (idle ? `<span class="uidle">â¸</span>` : '') +
          `<span class="utime">${formatDuration(Date.now() - joinedAt)}</span>`;
        panel.appendChild(entry);
      });
    });

    socket.on('typing', ({ text }) => {
      const bar = document.getElementById('typing-bar');
      bar.innerHTML = text
        ? text + ' <span class="dots"><span></span><span></span><span></span></span>'
        : '';
    });

    socket.on('kicked', (reason) => {
      addMessage(`<span class="msg-kicked">âš  ${reason || 'You were signed in from another device.'}</span>`);
      document.getElementById('input').disabled = true;
      document.getElementById('send-btn').disabled = true;
      socket.disconnect();
    });

    // â”€â”€ TICKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    setInterval(() => {
      document.querySelectorAll('.user-entry').forEach(entry => {
        const joinedAt = parseInt(entry.dataset.joinedAt, 10);
        const span = entry.querySelector('.utime');
        if (span) span.textContent = formatDuration(Date.now() - joinedAt);
      });
    }, 1000);

    setInterval(() => {
      document.querySelectorAll('.poll-timer').forEach(el => {
        const ends = parseInt(el.dataset.ends, 10);
        const left = Math.max(0, Math.ceil((ends - Date.now()) / 1000));
        if (left === 0) {
          el.textContent = 'ending...';
          el.classList.add('urgent');
        } else {
          const m = Math.floor(left / 60), s = left % 60;
          el.textContent = m > 0 ? `${m}m ${s}s left` : `${s}s left`;
          el.classList.toggle('urgent', left <= 30);
        }
      });
    }, 1000);

    let activityThrottle = 0;
    document.addEventListener('keydown', () => {
      const now = Date.now();
      if (now - activityThrottle > 30000) { activityThrottle = now; socket.emit('activity'); }
    });

    // â”€â”€ KEY BINDINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') send();
    });
    ['login-username', 'login-password'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
    });
    ['reg-username', 'reg-password', 'reg-password2'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doRegister(); });
    });

    // â”€â”€ AUTO-LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    fetch('/me').then(async res => {
      if (res.ok) {
        const data = await res.json();
        enterChat(data.username, data.color, data.theme || 'classic', data.token);
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <title>chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: #000080;
      font-family: 'VT323', monospace;
      font-size: 18px;
      color: white;
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* â”€â”€ AUTH SCREEN â”€â”€ */
    #auth-screen {
      background: #c0c0c0;
      color: black;
      border: 3px solid;
      border-color: white #808080 #808080 white;
      width: 90%;
      max-width: 380px;
    }

    .auth-tabs {
      display: flex;
      border-bottom: 2px solid #808080;
    }

    .auth-tab {
      flex: 1;
      padding: 8px;
      background: #a0a0a0;
      border: none;
      font-family: 'VT323', monospace;
      font-size: 18px;
      cursor: pointer;
      border-right: 1px solid #808080;
      color: #444;
    }

    .auth-tab:last-child { border-right: none; }
    .auth-tab.active { background: #000080; color: white; }

    .auth-titlebar {
      background: #000080;
      color: white;
      padding: 6px 10px;
      font-size: 18px;
      letter-spacing: 1px;
    }

    .auth-body { padding: 20px; }

    .auth-panel { display: none; }
    .auth-panel.active { display: block; }

    .auth-panel p { margin-bottom: 10px; font-size: 16px; }

    .auth-panel input {
      width: 100%;
      padding: 6px 8px;
      margin: 6px 0;
      font-family: 'VT323', monospace;
      font-size: 20px;
      border: 2px inset #808080;
      background: white;
    }

    .auth-panel button.primary {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      background: #000080;
      color: white;
      border: 2px solid;
      border-color: #6060c0 #000040 #000040 #6060c0;
      cursor: pointer;
      letter-spacing: 1px;
    }

    .auth-panel button.primary:active {
      border-color: #000040 #6060c0 #6060c0 #000040;
    }

    .auth-error {
      margin-top: 10px;
      color: #cc0000;
      font-size: 16px;
      min-height: 20px;
    }

    /* â”€â”€ COLOR PICKER â”€â”€ */
    .color-picker-label {
      display: block;
      font-size: 15px;
      margin: 8px 0 4px;
    }

    .color-swatches {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 6px;
    }

    .color-swatch {
      width: 24px;
      height: 24px;
      border: 2px solid transparent;
      cursor: pointer;
      border-radius: 2px;
    }

    .color-swatch.selected {
      border-color: black;
      outline: 1px solid white;
    }

    /* â”€â”€ CHAT SCREEN â”€â”€ */
    #chat-screen {
      display: none;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background: #c0c0c0;
      border: none;
      overflow: hidden;
    }

    @media (min-width: 700px) {
      #chat-screen {
        width: 760px;
        height: 90vh;
        border: 3px solid;
        border-color: white #808080 #808080 white;
      }
    }

    /* â”€â”€ LAYOUT â”€â”€ */
    #chat-layout {
      display: flex;
      flex: 1;
      height: calc(100% - 40px);
      overflow: hidden;
    }

    /* â”€â”€ ROOMS SIDEBAR â”€â”€ */
    #rooms-sidebar {
      width: 110px;
      background: #000060;
      color: white;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #808080;
      flex-shrink: 0;
    }

    #rooms-sidebar h3 {
      font-size: 14px;
      padding: 6px 8px;
      background: #000040;
      border-bottom: 1px solid #4040a0;
      letter-spacing: 1px;
      color: #aad4ff;
    }

    .room-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 6px 8px;
      font-family: 'VT323', monospace;
      font-size: 16px;
      background: none;
      border: none;
      color: #c0c0ff;
      cursor: pointer;
      border-bottom: 1px solid #000040;
    }

    .room-btn:hover { background: #0000a0; }
    .room-btn.active { background: #0000c0; color: white; font-weight: bold; }
    .room-btn .room-unread {
      float: right;
      background: #cc0000;
      color: white;
      font-size: 12px;
      padding: 0 4px;
      border-radius: 2px;
      min-width: 16px;
      text-align: center;
    }

    /* â”€â”€ MAIN AREA â”€â”€ */
    #main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ TITLEBAR â”€â”€ */
    #titlebar {
      background: #000080;
      color: white;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      letter-spacing: 1px;
      flex-shrink: 0;
      gap: 8px;
      height: 40px;
    }

    #titlebar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    #logged-in-as {
      font-size: 14px;
      color: #aad4ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #user-count-btn {
      font-family: 'VT323', monospace;
      font-size: 15px;
      background: #008080;
      color: white;
      padding: 2px 8px;
      border: 1px solid;
      border-color: #80c0c0 #004040 #004040 #80c0c0;
      white-space: nowrap;
      flex-shrink: 0;
      cursor: pointer;
    }

    #user-count-btn:active { border-color: #004040 #80c0c0 #80c0c0 #004040; }

    #sound-btn {
      font-family: 'VT323', monospace;
      font-size: 14px;
      background: #404040;
      color: white;
      border: 1px solid;
      border-color: #888 #333 #333 #888;
      padding: 2px 8px;
      cursor: pointer;
      flex-shrink: 0;
    }

    #sound-btn.on { background: #006600; border-color: #0a0 #030 #030 #0a0; }

    #logout-btn {
      font-family: 'VT323', monospace;
      font-size: 14px;
      background: #800000;
      color: white;
      border: 1px solid;
      border-color: #ff8080 #400000 #400000 #ff8080;
      padding: 2px 8px;
      cursor: pointer;
      flex-shrink: 0;
    }

    /* â”€â”€ ONLINE USERS PANEL â”€â”€ */
    #users-panel {
      display: none;
      flex-wrap: wrap;
      gap: 4px 16px;
      padding: 6px 8px;
      background: #c0c0c0;
      border-bottom: 2px inset #808080;
      font-size: 15px;
      color: black;
      flex-shrink: 0;
    }

    #users-panel.visible { display: flex; }

    .user-entry .uname { font-weight: bold; }
    .user-entry .utime { color: #808080; font-size: 13px; margin-left: 4px; }
    .user-entry .uidle { color: #aa6600; font-size: 13px; margin-left: 2px; }

    /* â”€â”€ MESSAGES â”€â”€ */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: white;
      border: 2px inset #808080;
      margin: 8px 8px 0 8px;
      font-size: 18px;
      line-height: 1.6;
      -webkit-overflow-scrolling: touch;
      color: black;
    }

    .msg-action { color: #555; font-style: italic; }
    .msg-action .msg-user { color: #555; }
    .msg-system { color: #808080; font-style: italic; }
    .msg-dm-row { background: #fff0f8; padding: 0 4px; border-left: 3px solid #cc0088; }
    .msg-dm-label { color: #cc0088; font-size: 15px; margin-right: 4px; }
    .msg-text { color: black; }
    .msg-own .msg-user { opacity: 0.8; }
    .msg-kicked { color: #cc0000; font-style: italic; }

    /* â”€â”€ TIMESTAMP (hover) â”€â”€ */
    .msg-row {
      position: relative;
      padding: 2px 0;
    }
    .msg-row:hover .msg-ts { display: inline; }
    .msg-ts {
      display: none;
      font-size: 12px;
      color: #aaa;
      margin-left: 8px;
    }

    /* â”€â”€ LINK PREVIEW â”€â”€ */
    .link-preview {
      display: inline-block;
      margin: 4px 0 2px 12px;
      padding: 6px 10px;
      background: #f0f4ff;
      border: 1px solid #c0c8e0;
      border-left: 3px solid #000080;
      font-size: 15px;
      max-width: 420px;
      color: #222;
    }

    .link-preview img {
      max-width: 100%;
      max-height: 80px;
      display: block;
      margin-bottom: 4px;
    }

    .link-preview .lp-title { font-weight: bold; color: #000080; }
    .link-preview .lp-desc { color: #555; font-size: 13px; }

    /* â”€â”€ POLL â”€â”€ */
    .poll-card {
      background: #f0f0ff;
      border: 2px solid #000080;
      margin: 6px 0;
      padding: 8px 12px;
      font-size: 16px;
      color: black;
    }

    .poll-card.poll-concluded {
      opacity: 0.75;
      border-color: #aaa;
      background: #f4f4f4;
    }

    .poll-question { font-weight: bold; color: #000080; margin-bottom: 6px; font-size: 17px; }
    .poll-card.poll-concluded .poll-question { color: #666; }

    .poll-option {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 3px 0;
      cursor: pointer;
    }

    .poll-option:hover .poll-opt-label { text-decoration: underline; }
    .poll-option.voted .poll-opt-label { color: #000080; font-weight: bold; }
    .poll-option.concluded { cursor: default; pointer-events: none; }

    .poll-bar-wrap {
      flex: 1;
      height: 14px;
      background: #d0d0d0;
      border: 1px solid #aaa;
      overflow: hidden;
    }

    .poll-bar {
      height: 100%;
      background: #000080;
      transition: width 0.3s;
    }

    .poll-card.poll-concluded .poll-bar { background: #808080; }
    .poll-option.winner .poll-bar { background: #007700; }
    .poll-option.winner .poll-opt-label { color: #007700; font-weight: bold; }

    .poll-pct { font-size: 13px; color: #555; width: 36px; text-align: right; }
    .poll-opt-label { min-width: 80px; }
    .poll-meta { font-size: 13px; color: #888; margin-top: 4px; }
    .poll-timer { color: #cc6600; font-size: 13px; }
    .poll-timer.urgent { color: #cc0000; font-weight: bold; }

    /* â”€â”€ TYPING INDICATOR â”€â”€ */
    #typing-bar {
      min-height: 22px;
      padding: 2px 10px;
      margin: 0 8px;
      font-size: 14px;
      color: #808080;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
    }

    .dots span {
      display: inline-block;
      width: 4px;
      height: 4px;
      background: #808080;
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .dots span:nth-child(2) { animation-delay: .2s; }
    .dots span:nth-child(3) { animation-delay: .4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: .4; }
      40%            { transform: translateY(-4px); opacity: 1; }
    }

    #bottom {
      display: flex;
      gap: 6px;
      padding: 8px;
      flex-shrink: 0;
    }

    #input {
      flex: 1;
      padding: 8px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      border: 2px inset #808080;
      min-width: 0;
      color: black;
    }

    #send-btn {
      padding: 8px 16px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      background: #c0c0c0;
      border: 2px solid;
      border-color: white #808080 #808080 white;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    #send-btn:active { border-color: #808080 white white #808080; }

    /* â”€â”€ DM FLASH â”€â”€ */
    .dm-flash { animation: flash 0.4s 3; }
    @keyframes flash {
      0%, 100% { background: #fff0f8; }
      50% { background: #ffccee; }
    }
  </style>
</head>
<body>

  <!-- Auth Screen -->
  <div id="auth-screen">
    <div class="auth-titlebar">chatroom</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">Login</button>
      <button class="auth-tab" onclick="switchTab('register')">Register</button>
    </div>
    <div class="auth-body">

      <!-- Login -->
      <div id="login-panel" class="auth-panel active">
        <p>Sign in to your account:</p>
        <input id="login-username" type="text" placeholder="Username..." maxlength="20" autocomplete="username" />
        <input id="login-password" type="password" placeholder="Password..." autocomplete="current-password" />
        <button class="primary" onclick="doLogin()">Login</button>
        <div class="auth-error" id="login-error"></div>
      </div>

      <!-- Register -->
      <div id="register-panel" class="auth-panel">
        <p>Create a new account:</p>
        <input id="reg-username" type="text" placeholder="Username (3-20 chars)..." maxlength="20" autocomplete="username" />
        <input id="reg-password" type="password" placeholder="Password (min 6 chars)..." autocomplete="new-password" />
        <input id="reg-password2" type="password" placeholder="Confirm password..." autocomplete="new-password" />
        <span class="color-picker-label">Pick your name colour:</span>
        <div class="color-swatches" id="color-swatches"></div>
        <input type="hidden" id="reg-color" value="#000080" />
        <button class="primary" onclick="doRegister()">Create Account</button>
        <div class="auth-error" id="register-error"></div>
      </div>

    </div>
  </div>

  <!-- Chat Screen -->
  <div id="chat-screen">
    <div id="titlebar">
      <div id="titlebar-left">
        <span>chatroom</span>
        <span id="logged-in-as"></span>
      </div>
      <div style="display:flex;align-items:center;gap:5px;flex-shrink:0;">
        <button id="user-count-btn" onclick="toggleUsers()">ğŸ‘¤ 0 online</button>
        <button id="sound-btn" class="on" onclick="toggleSound()" title="Toggle sounds">ğŸ”Š SFX</button>
        <button id="logout-btn" onclick="doLogout()">exit</button>
      </div>
    </div>

    <div id="chat-layout">
      <div id="rooms-sidebar">
        <h3>ROOMS</h3>
        <div id="rooms-list"></div>
      </div>

      <div id="main-area">
        <div id="users-panel"></div>
        <ul id="messages"></ul>
        <div id="typing-bar"></div>
        <div id="bottom">
          <input id="input" placeholder="Type a message, /me, /msg, /poll..." autocomplete="off" />
          <button id="send-btn" onclick="send()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // â”€â”€ WEB AUDIO SOUNDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let soundEnabled = true;
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let actx = null;

    function getActx() {
      if (!actx) actx = new AudioContext();
      return actx;
    }

    function playTone(freq, type, duration, vol = 0.15, delay = 0) {
      if (!soundEnabled) return;
      try {
        const ctx = getActx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime + delay);
        gain.gain.setValueAtTime(vol, ctx.currentTime + delay);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + duration);
        osc.start(ctx.currentTime + delay);
        osc.stop(ctx.currentTime + delay + duration + 0.01);
      } catch {}
    }

    function soundMessage() { playTone(880, 'square', 0.06, 0.1); }
    function soundJoin() {
      playTone(523, 'sine', 0.15, 0.12);
      playTone(659, 'sine', 0.15, 0.12, 0.12);
      playTone(784, 'sine', 0.2, 0.14, 0.24);
    }
    function soundLeave() {
      playTone(784, 'sine', 0.12, 0.1);
      playTone(523, 'sine', 0.2, 0.1, 0.14);
    }
    function soundDM() {
      playTone(1046, 'square', 0.08, 0.1);
      playTone(1318, 'square', 0.12, 0.12, 0.1);
    }
    function soundPollEnd() {
      playTone(659, 'sine', 0.1, 0.12);
      playTone(784, 'sine', 0.1, 0.12, 0.1);
      playTone(1046, 'sine', 0.3, 0.15, 0.2);
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('sound-btn');
      btn.textContent = soundEnabled ? 'ğŸ”Š SFX' : 'ğŸ”‡ SFX';
      btn.classList.toggle('on', soundEnabled);
    }

    // â”€â”€ COLORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const COLORS = [
      '#000080','#800000','#008000','#800080','#008080',
      '#0000cc','#cc0000','#007700','#aa00aa','#007777',
      '#cc6600','#006699','#990000','#009900','#660099',
    ];

    let selectedColor = '#000080';

    function buildColorSwatches() {
      const wrap = document.getElementById('color-swatches');
      COLORS.forEach(c => {
        const div = document.createElement('div');
        div.className = 'color-swatch' + (c === selectedColor ? ' selected' : '');
        div.style.background = c;
        div.title = c;
        div.onclick = () => {
          selectedColor = c;
          document.getElementById('reg-color').value = c;
          wrap.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
          div.classList.add('selected');
        };
        wrap.appendChild(div);
      });
    }
    buildColorSwatches();

    // â”€â”€ SOCKET & STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const socket = io({ autoConnect: false });
    let myUsername = null;
    let myColor = '#000080';
    let currentRoom = 'general';
    let usersVisible = false;
    let isTyping = false;
    let typingTimer;
    const unreadCounts = {};
    const polls = {};

    // â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchTab(tab) {
      document.querySelectorAll('.auth-tab').forEach((t, i) => {
        t.classList.toggle('active', (i === 0) === (tab === 'login'));
      });
      document.getElementById('login-panel').classList.toggle('active', tab === 'login');
      document.getElementById('register-panel').classList.toggle('active', tab === 'register');
    }

    // â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function doLogin() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errEl = document.getElementById('login-error');
      errEl.textContent = '';
      if (!username || !password) { errEl.textContent = 'Please fill in all fields.'; return; }
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok) { errEl.textContent = data.error; return; }
      enterChat(data.username, data.color || '#000080', data.token);
    }

    async function doRegister() {
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const password2 = document.getElementById('reg-password2').value;
      const color = document.getElementById('reg-color').value;
      const errEl = document.getElementById('register-error');
      errEl.textContent = '';
      if (!username || !password || !password2) { errEl.textContent = 'Please fill in all fields.'; return; }
      if (password !== password2) { errEl.textContent = 'Passwords do not match.'; return; }
      const res = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password, color })
      });
      const data = await res.json();
      if (!res.ok) { errEl.textContent = data.error; return; }
      enterChat(data.username, data.color || '#000080', data.token);
    }

    async function doLogout() {
      await fetch('/logout', { method: 'POST' });
      socket.disconnect();
      location.reload();
    }

    // â”€â”€ ENTER CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function enterChat(username, color, token) {
      myUsername = username;
      myColor = color || '#000080';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'block';
      document.getElementById('logged-in-as').innerHTML =
        `[<span style="color:${myColor};text-shadow:0 0 2px rgba(255,255,255,0.7)">${username}</span>]`;
      document.getElementById('input').focus();

      socket.connect();
      socket.once('connect', () => { socket.emit('join', token); });
    }

    // â”€â”€ ROOMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRooms(rooms) {
      const list = document.getElementById('rooms-list');
      list.innerHTML = '';
      rooms.forEach(room => {
        const btn = document.createElement('button');
        btn.className = 'room-btn' + (room === currentRoom ? ' active' : '');
        btn.dataset.room = room;
        btn.innerHTML = `#${room}`;
        if (unreadCounts[room]) {
          btn.innerHTML += `<span class="room-unread">${unreadCounts[room]}</span>`;
        }
        btn.onclick = () => switchRoom(room);
        list.appendChild(btn);
      });
    }

    function switchRoom(room) {
      if (room === currentRoom) return;
      document.getElementById('messages').innerHTML = '';
      currentRoom = room;
      socket.emit('switch room', room);
      unreadCounts[room] = 0;
    }

    // â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function send() {
      const input = document.getElementById('input');
      const text = input.value.trim();
      if (!text) return;
      socket.emit('chat message', text);
      input.value = '';
      stopTyping();
    }

    // â”€â”€ TYPING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('input').addEventListener('input', () => {
      socket.emit('activity');
      if (!isTyping) { isTyping = true; socket.emit('typing start'); }
      clearTimeout(typingTimer);
      typingTimer = setTimeout(stopTyping, 2000);
    });

    function stopTyping() {
      if (!isTyping) return;
      isTyping = false;
      clearTimeout(typingTimer);
      socket.emit('typing stop');
    }

    // â”€â”€ USERS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleUsers() {
      usersVisible = !usersVisible;
      document.getElementById('users-panel').classList.toggle('visible', usersVisible);
    }

    // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function formatDuration(ms) {
      const total = Math.floor(ms / 1000);
      const d = Math.floor(total / 86400), h = Math.floor((total % 86400) / 3600);
      const m = Math.floor((total % 3600) / 60), s = total % 60;
      if (d > 0) return d + "D " + h + "HR " + m + "M";
      if (h > 0) return h + "HR " + m + "M";
      if (m > 0) return m + "M " + s + "S";
      return s + "S";
    }

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function addMessage(html, extraClass = '', timestamp = null) {
      const messages = document.getElementById('messages');
      const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
      const li = document.createElement('li');
      li.style.listStyle = 'none';
      li.className = 'msg-row' + (extraClass ? ' ' + extraClass : '');
      const ts = timestamp ? `<span class="msg-ts">${formatTime(timestamp)}</span>` : '';
      li.innerHTML = html + ts;
      messages.appendChild(li);
      if (atBottom) messages.scrollTop = messages.scrollHeight;
      return li;
    }

    function addDmMessage(data) {
      const messages = document.getElementById('messages');
      const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
      const li = document.createElement('li');
      li.style.listStyle = 'none';
      li.className = 'msg-row msg-dm-row' + (!data.noFlash && !data.self ? ' dm-flash' : '');
      const label = data.self
        ? `<span class="msg-dm-label">â†’ DM to ${data.to}:</span>`
        : `<span class="msg-dm-label">DM from ${data.from}:</span>`;
      li.innerHTML = label + `<span class="msg-text">${data.text}</span>`;
      messages.appendChild(li);
      if (atBottom) messages.scrollTop = messages.scrollHeight;
      if (!data.noFlash && !data.self) soundDM();
    }

    // â”€â”€ POLLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPoll(poll) {
      polls[poll.id] = poll;
      const existing = document.getElementById(`poll-${poll.id}`);
      if (existing) {
        existing.innerHTML = buildPollHtml(poll);
        return;
      }
      const messages = document.getElementById('messages');
      const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
      const li = document.createElement('li');
      li.style.listStyle = 'none';
      li.id = `poll-${poll.id}`;
      li.className = 'msg-row';
      li.innerHTML = buildPollHtml(poll);
      messages.appendChild(li);
      if (atBottom) messages.scrollTop = messages.scrollHeight;
    }

    function buildPollHtml(poll) {
      const totalVotes = Object.keys(poll.votes || {}).length;
      const myVote = (poll.votes || {})[myUsername];
      const concluded = poll.concluded;

      // Find winner count for highlighting
      let topCount = 0;
      if (concluded && totalVotes > 0) {
        const tally = {};
        poll.options.forEach(o => tally[o] = 0);
        Object.values(poll.votes || {}).forEach(v => { if (tally[v] !== undefined) tally[v]++; });
        topCount = Math.max(...Object.values(tally));
      }

      const optionsHtml = poll.options.map(opt => {
        const count = Object.values(poll.votes || {}).filter(v => v === opt).length;
        const pct = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
        const isVoted = myVote === opt;
        const isWinner = concluded && totalVotes > 0 && count === topCount;
        const classes = [
          'poll-option',
          isVoted ? 'voted' : '',
          concluded ? 'concluded' : '',
          isWinner ? 'winner' : '',
        ].filter(Boolean).join(' ');

        return `<div class="${classes}" onclick="${concluded ? '' : `castVote(${poll.id}, '${opt.replace(/'/g, "\\'")}')`}">
          <span class="poll-opt-label">${isWinner ? 'ğŸ† ' : ''}${opt}</span>
          <div class="poll-bar-wrap"><div class="poll-bar" style="width:${pct}%"></div></div>
          <span class="poll-pct">${pct}%</span>
          <span style="font-size:13px;color:#555">${count}</span>
        </div>`;
      }).join('');

      let timerHtml = '';
      if (!concluded && poll.endsAt) {
        timerHtml = `<span class="poll-timer" data-ends="${new Date(poll.endsAt).getTime()}">...</span>`;
      } else if (concluded) {
        timerHtml = `<span style="color:#888">concluded</span>`;
      }

      return `<div class="poll-card${concluded ? ' poll-concluded' : ''}">
        <div class="poll-question">ğŸ“Š ${poll.question}</div>
        ${optionsHtml}
        <div class="poll-meta">by ${poll.creator} Â· ${totalVotes} vote${totalVotes !== 1 ? 's' : ''} Â· ${timerHtml}</div>
      </div>`;
    }

    function castVote(pollId, option) {
      socket.emit('poll vote', { pollId, option });
    }

    // â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHistory(history) {
      const messages = document.getElementById('messages');
      messages.innerHTML = '';
      if (history.length === 0) return;
      addMessage(`<span class="msg-system">â”€â”€ message history â”€â”€</span>`);
      history.forEach(row => {
        const ts = new Date(row.created_at).getTime();
        if (row.type === 'action') {
          addMessage(
            `<span class="msg-action">*** <span class="msg-user" style="color:${row.color}">${row.sender}</span> ${row.text} ***</span>`,
            '', ts
          );
        } else if (row.type === 'dm') {
          const isSelf = row.sender === myUsername;
          addDmMessage({
            from: row.sender,
            to: row.recipient,
            text: row.text,
            self: isSelf,
            noFlash: true,
          });
        } else {
          const isOwn = row.sender === myUsername;
          addMessage(
            `<span class="msg-user" style="color:${row.color}">${row.sender}:</span> <span class="msg-text">${row.text}</span>`,
            isOwn ? 'msg-own' : '', ts
          );
        }
      });
      addMessage(`<span class="msg-system">â”€â”€ live â”€â”€</span>`);
      messages.scrollTop = messages.scrollHeight;
    }

    // â”€â”€ SOCKET EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    socket.on('rooms list', (rooms) => {
      renderRooms(rooms);
    });

    socket.on('room changed', (room) => {
      currentRoom = room;
      renderRooms([...document.querySelectorAll('.room-btn')].map(b => b.dataset.room));
    });

    socket.on('history', (history) => {
      renderHistory(history);
    });

    socket.on('chat message', ({ user, color, text, type, timestamp }) => {
      const isOwn = user === myUsername;
      if (type === 'action') {
        addMessage(
          `<span class="msg-action">*** <span class="msg-user" style="color:${color}">${user}</span> ${text} ***</span>`,
          '', timestamp
        );
      } else {
        addMessage(
          `<span class="msg-user" style="color:${color}">${user}:</span> <span class="msg-text">${text}</span>`,
          isOwn ? 'msg-own' : '', timestamp || Date.now()
        );
      }
      if (!isOwn) soundMessage();
    });

    socket.on('system message', (msg) => {
      const isJoin = /has joined/.test(msg);
      const isLeave = /has left/.test(msg);
      addMessage(`<span class="msg-system">*** ${msg} ***</span>`);
      if (isJoin) soundJoin();
      else if (isLeave) soundLeave();
    });

    socket.on('dm', (data) => {
      addDmMessage(data);
    });

    socket.on('link preview', ({ url, title, image, description }) => {
      const messages = document.getElementById('messages');
      const rows = messages.querySelectorAll('.msg-row');
      let target = null;
      for (let i = rows.length - 1; i >= 0; i--) {
        if (rows[i].textContent.includes(url.slice(8, 40))) { target = rows[i]; break; }
      }
      const previewEl = document.createElement('div');
      previewEl.className = 'link-preview';
      let html = '';
      if (image) html += `<img src="${image}" alt="" onerror="this.style.display='none'">`;
      if (title) html += `<div class="lp-title">${title}</div>`;
      if (description) html += `<div class="lp-desc">${description}</div>`;
      previewEl.innerHTML = html;
      const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
      if (target) {
        target.appendChild(previewEl);
      } else {
        const li = document.createElement('li');
        li.style.listStyle = 'none';
        li.appendChild(previewEl);
        messages.appendChild(li);
      }
      if (atBottom) messages.scrollTop = messages.scrollHeight;
    });

    socket.on('poll update', (poll) => {
      renderPoll(poll);
    });

    socket.on('poll concluded', ({ pollId }) => {
      if (polls[pollId]) {
        polls[pollId].concluded = true;
        const el = document.getElementById(`poll-${pollId}`);
        if (el) el.innerHTML = buildPollHtml(polls[pollId]);
        soundPollEnd();
      }
    });

    socket.on('user list', (list) => {
      document.getElementById('user-count-btn').textContent = `ğŸ‘¤ ${list.length} online`;
      const panel = document.getElementById('users-panel');
      panel.innerHTML = '';
      list.forEach(({ username, color, joinedAt, idle }) => {
        const entry = document.createElement('span');
        entry.className = 'user-entry';
        entry.dataset.joinedAt = joinedAt;
        entry.innerHTML =
          `<span class="uname" style="color:${color}">${username}</span>` +
          (idle ? `<span class="uidle">â¸</span>` : '') +
          `<span class="utime">${formatDuration(Date.now() - joinedAt)}</span>`;
        panel.appendChild(entry);
      });
    });

    socket.on('typing', ({ text }) => {
      const bar = document.getElementById('typing-bar');
      bar.innerHTML = text
        ? text + ' <span class="dots"><span></span><span></span><span></span></span>'
        : '';
    });

    socket.on('kicked', (reason) => {
      addMessage(`<span class="msg-kicked">âš  ${reason || 'You were signed in from another device.'}</span>`);
      document.getElementById('input').disabled = true;
      document.getElementById('send-btn').disabled = true;
      socket.disconnect();
    });

    // â”€â”€ TICKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // Time-online ticker
    setInterval(() => {
      document.querySelectorAll('.user-entry').forEach(entry => {
        const joinedAt = parseInt(entry.dataset.joinedAt, 10);
        const span = entry.querySelector('.utime');
        if (span) span.textContent = formatDuration(Date.now() - joinedAt);
      });
    }, 1000);

    // Poll countdown ticker
    setInterval(() => {
      document.querySelectorAll('.poll-timer').forEach(el => {
        const ends = parseInt(el.dataset.ends, 10);
        const left = Math.max(0, Math.ceil((ends - Date.now()) / 1000));
        if (left === 0) {
          el.textContent = 'ending...';
          el.classList.add('urgent');
        } else {
          const m = Math.floor(left / 60), s = left % 60;
          el.textContent = m > 0 ? `${m}m ${s}s left` : `${s}s left`;
          el.classList.toggle('urgent', left <= 30);
        }
      });
    }, 1000);

    // Activity emit throttle
    let activityThrottle = 0;
    document.addEventListener('keydown', () => {
      const now = Date.now();
      if (now - activityThrottle > 30000) { activityThrottle = now; socket.emit('activity'); }
    });

    // â”€â”€ KEY BINDINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') send();
    });
    ['login-username', 'login-password'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
    });
    ['reg-username', 'reg-password', 'reg-password2'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doRegister(); });
    });

    // Auto-login if session exists
    fetch('/me').then(async res => {
      if (res.ok) {
        const data = await res.json();
        enterChat(data.username, data.color, data.token);
      }
    });
  </script>
</body>
</html>
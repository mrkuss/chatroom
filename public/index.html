<!DOCTYPE html>
<html lang="en">
<head>
  <title>chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg-outer:#000080;--bg-window:#c0c0c0;--bg-titlebar:#000080;--bg-sidebar:#000060;
      --bg-sidebar-hdr:#000040;--bg-messages:#ffffff;--bg-input:#ffffff;--bg-bottom:#c0c0c0;
      --bg-users-panel:#c0c0c0;--border-main:white #808080 #808080 white;--border-inset:#808080;
      --text-main:#000000;--text-titlebar:#ffffff;--text-sidebar:#c0c0ff;--text-sidebar-hdr:#aad4ff;
      --text-system:#808080;--text-action:#555555;--room-active-bg:#0000c0;--room-hover-bg:#0000a0;
      --poll-bg:#f0f0ff;--poll-border:#000080;--poll-bar:#000080;--poll-question:#000080;
      --link-preview-bg:#f0f4ff;--link-preview-border:#c0c8e0;--link-preview-accent:#000080;
      --link-title-color:#000080;--typing-color:#808080;--btn-bg:#c0c0c0;
      --btn-border:white #808080 #808080 white;--auth-bg:#c0c0c0;--auth-tab-active-bg:#000080;--auth-input-bg:#ffffff;
    }
    body.theme-noir {
      --bg-outer:#0a0a0a;--bg-window:#1a1a1a;--bg-titlebar:#111111;--bg-sidebar:#0d0d0d;
      --bg-sidebar-hdr:#080808;--bg-messages:#141414;--bg-input:#1e1e1e;--bg-bottom:#1a1a1a;
      --bg-users-panel:#1a1a1a;--border-main:#444 #111 #111 #444;--border-inset:#333;
      --text-main:#d0d0d0;--text-titlebar:#e0e0e0;--text-sidebar:#9090c0;--text-sidebar-hdr:#7090b0;
      --text-system:#555;--text-action:#777;--room-active-bg:#252535;--room-hover-bg:#1e1e2e;
      --poll-bg:#1e1e2e;--poll-border:#4444aa;--poll-bar:#4444aa;--poll-question:#8888cc;
      --link-preview-bg:#1e1e28;--link-preview-border:#333355;--link-preview-accent:#4444aa;
      --link-title-color:#8888cc;--typing-color:#555;--btn-bg:#222;--btn-border:#444 #111 #111 #444;
      --auth-bg:#1a1a1a;--auth-tab-active-bg:#111;--auth-input-bg:#222;
    }
    body.theme-rose {
      --bg-outer:#3d1a2e;--bg-window:#f5e8ee;--bg-titlebar:#7a2d52;--bg-sidebar:#5c1f3d;
      --bg-sidebar-hdr:#3d1428;--bg-messages:#fff5f8;--bg-input:#fff0f5;--bg-bottom:#f5e8ee;
      --bg-users-panel:#f5e8ee;--border-main:#f0c0d8 #8a3060 #8a3060 #f0c0d8;--border-inset:#c090a8;
      --text-main:#3a1428;--text-titlebar:#ffe0ee;--text-sidebar:#f0b0cc;--text-sidebar-hdr:#f8d0e4;
      --text-system:#b08090;--text-action:#805060;--room-active-bg:#7a2d52;--room-hover-bg:#5c1f3d;
      --poll-bg:#fff0f8;--poll-border:#cc5588;--poll-bar:#cc5588;--poll-question:#993366;
      --link-preview-bg:#fff5f9;--link-preview-border:#e8b0c8;--link-preview-accent:#cc5588;
      --link-title-color:#993366;--typing-color:#c090a8;--btn-bg:#f5e8ee;--btn-border:#f0c0d8 #8a3060 #8a3060 #f0c0d8;
      --auth-bg:#f5e8ee;--auth-tab-active-bg:#7a2d52;--auth-input-bg:#fff5f8;
    }
    body.theme-forest {
      --bg-outer:#0d1a08;--bg-window:#1a2410;--bg-titlebar:#2a3a1a;--bg-sidebar:#111d09;
      --bg-sidebar-hdr:#0a1206;--bg-messages:#162010;--bg-input:#1a2410;--bg-bottom:#1a2410;
      --bg-users-panel:#1a2410;--border-main:#5a8a3a #1a3010 #1a3010 #5a8a3a;--border-inset:#3a5a2a;
      --text-main:#c8d8b0;--text-titlebar:#d4e8b8;--text-sidebar:#7aaa5a;--text-sidebar-hdr:#9acc7a;
      --text-system:#4a6a3a;--text-action:#7a9a5a;--room-active-bg:#2a4a1a;--room-hover-bg:#223818;
      --poll-bg:#1e2e14;--poll-border:#4a7a2a;--poll-bar:#4a7a2a;--poll-question:#8ab86a;
      --link-preview-bg:#182612;--link-preview-border:#3a5a2a;--link-preview-accent:#4a7a2a;
      --link-title-color:#8ab86a;--typing-color:#4a6a3a;--btn-bg:#1a2410;--btn-border:#5a8a3a #1a3010 #1a3010 #5a8a3a;
      --auth-bg:#1a2410;--auth-tab-active-bg:#2a3a1a;--auth-input-bg:#1a2410;
    }
    body{background-color:var(--bg-outer);font-family:'VT323',monospace;font-size:18px;color:var(--text-main);height:100vh;height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:background-color 0.2s;}
    #auth-screen{background:var(--auth-bg);color:var(--text-main);border:3px solid;border-color:var(--border-main);width:90%;max-width:380px;}
    .auth-titlebar{background:var(--bg-titlebar);color:var(--text-titlebar);padding:6px 10px;font-size:18px;letter-spacing:1px;display:flex;justify-content:space-between;align-items:center;}
    .auth-version{font-size:13px;opacity:0.5;}
    .auth-disclaimer{background:#a8a8a8;color:#333;font-size:13px;padding:6px 10px;border-bottom:1px solid #808080;}
    .auth-tabs{display:flex;border-bottom:2px solid var(--border-inset);}
    .auth-tab{flex:1;padding:8px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:18px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;}
    .auth-tab:last-child{border-right:none;}
    .auth-tab.active{background:var(--auth-tab-active-bg);color:white;}
    .auth-body{padding:20px;}
    .auth-panel{display:none;}
    .auth-panel.active{display:block;}
    .auth-panel p{margin-bottom:10px;font-size:16px;}
    .auth-panel input{width:100%;padding:6px 8px;margin:6px 0;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);background:var(--auth-input-bg);color:var(--text-main);}
    .auth-panel button.primary{width:100%;margin-top:10px;padding:8px;font-family:'VT323',monospace;font-size:20px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px;}
    .auth-error{margin-top:10px;color:#cc0000;font-size:16px;min-height:20px;}
    .auth-user-count{text-align:center;font-size:14px;color:var(--text-system);padding:8px 0 0;font-family:'VT323',monospace;}
    #chat-screen{display:none;width:100%;height:100vh;height:100dvh;background:var(--bg-window);border:none;overflow:hidden;transition:background-color 0.2s;}
    @media(min-width:700px){#chat-screen{width:760px;height:90vh;border:3px solid;border-color:var(--border-main);}}
    #chat-layout{display:flex;flex:1;height:calc(100% - 40px);overflow:hidden;}
    #rooms-sidebar{width:110px;background:var(--bg-sidebar);color:var(--text-sidebar);display:flex;flex-direction:column;border-right:2px solid var(--border-inset);flex-shrink:0;}
    #rooms-sidebar h3{font-size:14px;padding:6px 8px;background:var(--bg-sidebar-hdr);border-bottom:1px solid var(--border-inset);letter-spacing:1px;color:var(--text-sidebar-hdr);}
    .room-btn{display:block;width:100%;text-align:left;padding:6px 8px;font-family:'VT323',monospace;font-size:16px;background:none;border:none;color:var(--text-sidebar);cursor:pointer;border-bottom:1px solid var(--bg-sidebar-hdr);}
    .room-btn:hover{background:var(--room-hover-bg);}
    .room-btn.active{background:var(--room-active-bg);color:white;font-weight:bold;}
    .room-btn .room-unread{float:right;background:#cc0000;color:white;font-size:12px;padding:0 4px;border-radius:2px;}
    .room-private-icon{font-size:11px;margin-right:2px;}
    .room-code-badge{display:block;font-size:11px;color:#ffd700;letter-spacing:1px;padding:0 8px 4px;line-height:1.2;opacity:0.85;}
    body.theme-rose .room-code-badge{color:#cc5588;}
    body.theme-noir .room-code-badge{color:#8888cc;}
    body.theme-forest .room-code-badge{color:#8ab86a;}
    #main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    #titlebar{background:var(--bg-titlebar);color:var(--text-titlebar);padding:0 8px;display:flex;justify-content:space-between;align-items:center;font-size:18px;letter-spacing:1px;flex-shrink:0;height:40px;gap:8px;}
    #titlebar-title{font-size:18px;letter-spacing:2px;flex-shrink:0;}
    #titlebar-right{display:flex;align-items:center;gap:5px;margin-left:auto;}
    #logged-in-as{font-size:22px;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-right:8px;}
    #logged-in-as span{color:white!important;text-shadow:0 1px 2px rgba(0,0,0,0.12);}
    #coin-display{font-size:14px;color:#ffd700;white-space:nowrap;margin-right:4px;display:flex;align-items:center;gap:3px;}
    #coin-display #coin-amount{color:#ffd700;text-shadow:1px 1px 0 #7a6000,0 1px 3px rgba(0,0,0,0.6);}
    body.theme-noir #coin-display,body.theme-noir #coin-display #coin-amount{color:#ffcc00;text-shadow:1px 1px 0 #5a4800,0 1px 3px rgba(0,0,0,0.8);}
    body.theme-rose #coin-display{color:#ffaa44;}
    body.theme-rose #coin-display #coin-amount{color:#ffaa44;text-shadow:1px 1px 0 #7a3a00,0 1px 3px rgba(0,0,0,0.5);}
    body.theme-forest #coin-display{color:#9acc7a;}
    body.theme-forest #coin-display #coin-amount{color:#9acc7a;text-shadow:1px 1px 0 #2a4a1a,0 1px 3px rgba(0,0,0,0.8);}
    .shop-balance,.game-balance,.daily-amount{text-shadow:1px 1px 0 #7a6000,0 1px 4px rgba(0,0,0,0.5);}
    body.theme-noir .shop-balance,body.theme-noir .game-balance,body.theme-noir .daily-amount{text-shadow:1px 1px 0 #3a2800,0 1px 4px rgba(0,0,0,0.9);}
    body.theme-rose .shop-balance,body.theme-rose .game-balance,body.theme-rose .daily-amount{text-shadow:1px 1px 0 #6a2a00,0 1px 4px rgba(0,0,0,0.4);}
    body.theme-forest .shop-balance,body.theme-forest .game-balance,body.theme-forest .daily-amount{text-shadow:1px 1px 0 #1a3010,0 1px 4px rgba(0,0,0,0.7);}
    .icon-btn{font-family:'VT323',monospace;font-size:16px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;padding:0;line-height:1;position:relative;}
    .icon-btn:active{border-color:var(--border-inset) white white var(--border-inset);}
    .icon-btn.on{background:#006600;color:white;border-color:#0a0 #030 #030 #0a0;}
    .icon-btn.danger{background:#800000;color:white;border-color:#ff8080 #400000 #400000 #ff8080;}
    .icon-btn[title]:hover::after{content:attr(title);position:absolute;bottom:-26px;left:50%;transform:translateX(-50%);background:#000;color:#fff;font-size:12px;padding:2px 6px;white-space:nowrap;z-index:9999;pointer-events:none;border:1px solid #555;}
    #user-count-btn{width:auto;padding:0 8px;font-size:14px;gap:4px;}
    .pixel-icon{width:100%;height:100%;image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges;object-fit:contain;}
    .sprite{image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges;object-fit:contain;vertical-align:middle;}
    #reconnect-banner{display:none;background:#cc6600;color:white;font-size:14px;text-align:center;padding:4px 8px;flex-shrink:0;letter-spacing:1px;}
    #reconnect-banner.visible{display:block;}
    #users-panel{display:none;flex-wrap:wrap;gap:4px 16px;padding:6px 8px;background:var(--bg-users-panel);border-bottom:2px inset var(--border-inset);font-size:15px;flex-shrink:0;}
    #users-panel.visible{display:flex;}
    .user-entry .uname{font-weight:bold;cursor:pointer;text-shadow:0 1px 2px rgba(0,0,0,0.12);}
    .user-entry .uname:hover{text-decoration:underline;}
    .user-entry .utime{color:var(--text-system);font-size:13px;margin-left:4px;}
    .user-entry .uidle{color:#aa6600;font-size:13px;margin-left:2px;}
    #messages{flex:1;overflow-y:auto;padding:8px;background:var(--bg-messages);border:2px inset var(--border-inset);margin:8px 8px 0 8px;font-size:18px;line-height:1.6;-webkit-overflow-scrolling:touch;color:var(--text-main);transition:background-color 0.2s,color 0.2s;}
    .msg-action{color:var(--text-action);font-style:italic;}
    .msg-system{color:var(--text-system);font-style:italic;}
    .msg-dm-row{background:#fff0f8;padding:0 4px;border-left:3px solid #cc0088;}
    .msg-dm-label{color:#cc0088;font-size:15px;margin-right:4px;}
    .msg-text{color:var(--text-main);}
    .msg-mention{background:rgba(255,230,0,0.06);border-left:3px solid #ffcc00;padding-left:6px;}
    .msg-own .msg-user{opacity:0.8;}
    .msg-kicked{color:#cc0000;font-style:italic;}
    .msg-claim-event{color:#ffaa00;font-weight:bold;font-style:italic;animation:claimPulse 1s ease-in-out 3;}
    @keyframes claimPulse{0%,100%{opacity:1}50%{opacity:0.4}}
    body.theme-noir .msg-dm-row{background:#1a0a14;border-left-color:#aa0066;}
    body.theme-noir .msg-dm-label{color:#aa0066;}
    body.theme-rose .msg-dm-row{background:#ffe8f4;border-left-color:#cc5588;}
    body.theme-rose .msg-dm-label{color:#cc5588;}
    body.theme-forest .msg-dm-row{background:#162a10;border-left-color:#4a7a2a;}
    body.theme-forest .msg-dm-label{color:#4a7a2a;}
    .msg-row{position:relative;padding:2px 0;}
    .msg-row:hover .msg-ts{display:inline;}
    .msg-row:hover .msg-react-btn{display:inline-flex;}
    .msg-ts{display:none;font-size:12px;color:var(--text-system);margin-left:8px;}
    .msg-user{cursor:pointer;text-shadow:0 1px 2px rgba(0,0,0,0.12);}
    .msg-user:hover{text-decoration:underline;}
    .msg-react-btn{display:none;background:none;border:1px solid var(--border-inset);font-size:13px;padding:1px 5px;cursor:pointer;margin-left:6px;color:var(--text-system);font-family:'VT323',monospace;vertical-align:middle;position:relative;}
    .msg-react-btn:hover .react-picker{display:flex;}
    .react-picker{display:none;position:absolute;bottom:100%;left:0;background:var(--bg-window);border:2px solid;border-color:var(--border-main);padding:4px;gap:4px;z-index:50;white-space:nowrap;}
    .react-emoji{font-size:20px;cursor:pointer;padding:2px;border-radius:3px;}
    .react-emoji:hover{background:var(--room-hover-bg);}
    .msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;margin-left:4px;}
    .reaction-pill{font-size:14px;padding:1px 6px;background:var(--poll-bg);border:1px solid var(--poll-border);cursor:pointer;display:inline-flex;align-items:center;gap:3px;}
    .reaction-pill:hover{background:var(--room-hover-bg);}
    .reaction-pill .r-count{font-size:12px;color:var(--text-system);}
    .link-preview{display:inline-block;margin:4px 0 2px 12px;padding:6px 10px;background:var(--link-preview-bg);border:1px solid var(--link-preview-border);border-left:3px solid var(--link-preview-accent);font-size:15px;max-width:420px;color:var(--text-main);}
    .link-preview img{max-width:100%;max-height:80px;display:block;margin-bottom:4px;}
    .link-preview .lp-title{font-weight:bold;color:var(--link-title-color);}
    .link-preview .lp-desc{color:var(--text-system);font-size:13px;}
    .poll-card{background:var(--poll-bg);border:2px solid var(--poll-border);margin:6px 0;padding:8px 12px;font-size:16px;color:var(--text-main);}
    .poll-card.poll-concluded{opacity:0.75;border-color:var(--border-inset);}
    .poll-question{font-weight:bold;color:var(--poll-question);margin-bottom:6px;font-size:17px;}
    .poll-option{display:flex;align-items:center;gap:8px;margin:3px 0;cursor:pointer;user-select:none;}
    .poll-option:hover:not(.concluded) .poll-opt-label{text-decoration:underline;}
    .poll-option.voted .poll-opt-label{color:var(--poll-question);font-weight:bold;}
    .poll-option.concluded{cursor:default;pointer-events:none;}
    .poll-bar-wrap{flex:1;height:14px;background:var(--border-inset);border:1px solid var(--border-inset);overflow:hidden;}
    .poll-bar{height:100%;background:var(--poll-bar);transition:width 0.3s;}
    .poll-option.winner .poll-bar{background:#007700;}
    .poll-option.winner .poll-opt-label{color:#007700;font-weight:bold;}
    .poll-pct{font-size:13px;color:var(--text-system);width:36px;text-align:right;}
    .poll-opt-label{min-width:80px;}
    .poll-meta{font-size:13px;color:var(--text-system);margin-top:4px;}
    .poll-timer{color:#cc6600;font-size:13px;}
    .poll-timer.urgent{color:#cc0000;font-weight:bold;}
    #typing-bar{min-height:22px;padding:2px 10px;margin:0 8px;font-size:14px;color:var(--typing-color);font-style:italic;display:flex;align-items:center;gap:5px;flex-shrink:0;}
    .dots span{display:inline-block;width:4px;height:4px;background:var(--typing-color);border-radius:50%;animation:bounce 1.2s infinite;}
    .dots span:nth-child(2){animation-delay:.2s}.dots span:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.4}40%{transform:translateY(-4px);opacity:1}}
    #bottom{display:flex;gap:6px;padding:8px;flex-shrink:0;background:var(--bg-bottom);}
    #input{flex:1;padding:8px;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);min-width:0;color:var(--text-main);background:var(--bg-input);}
    #send-btn{padding:8px 16px;font-family:'VT323',monospace;font-size:20px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);cursor:pointer;white-space:nowrap;flex-shrink:0;}
    .dm-flash{animation:flash 0.4s 3;}
    @keyframes flash{0%,100%{background:#fff0f8}50%{background:#ffccee}}
    @keyframes gold{0%,100%{color:#ccaa00;text-shadow:0 0 4px rgba(255,210,0,0.5),0 0 10px rgba(255,200,0,0.3);}50%{color:#ffdd44;text-shadow:0 0 8px rgba(255,220,0,0.9),0 0 20px rgba(255,200,0,0.6);}}
    @keyframes rainbow{0%{color:#ff0000;text-shadow:0 0 6px rgba(255,0,0,0.35);}14%{color:#ff7f00;text-shadow:0 0 6px rgba(255,127,0,0.35);}28%{color:#cccc00;text-shadow:0 0 6px rgba(204,204,0,0.35);}42%{color:#00aa00;text-shadow:0 0 6px rgba(0,170,0,0.35);}56%{color:#0099ff;text-shadow:0 0 6px rgba(0,153,255,0.35);}70%{color:#6600ff;text-shadow:0 0 6px rgba(102,0,255,0.35);}85%{color:#ff00cc;text-shadow:0 0 6px rgba(255,0,204,0.35);}100%{color:#ff0000;text-shadow:0 0 6px rgba(255,0,0,0.35);}}
    @keyframes neon_red{0%,100%{color:#ff0044;text-shadow:0 0 5px #ff0044,0 0 12px rgba(255,0,68,0.55),0 0 24px rgba(255,0,68,0.25);}50%{color:#ff4477;text-shadow:0 0 8px #ff0044,0 0 20px rgba(255,0,68,0.85),0 0 36px rgba(255,0,68,0.45);}}
    @keyframes neon_purple{0%,100%{color:#cc00ff;text-shadow:0 0 5px #cc00ff,0 0 12px rgba(204,0,255,0.55),0 0 24px rgba(204,0,255,0.25);}50%{color:#dd55ff;text-shadow:0 0 8px #cc00ff,0 0 20px rgba(204,0,255,0.85),0 0 36px rgba(204,0,255,0.45);}}
    .user-gold{animation:gold 2s ease-in-out infinite;}
    .user-rainbow{animation:rainbow 3s linear infinite;}
    .user-neon_red{animation:neon_red 1.5s ease-in-out infinite;}
    .user-neon_purple{animation:neon_purple 1.5s ease-in-out infinite;}
    #roulette-number-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin:8px 0;max-height:180px;overflow-y:auto;padding:4px;}
    .roulette-num-btn{padding:4px;font-family:'VT323',monospace;font-size:14px;border:2px solid;cursor:pointer;font-weight:bold;color:#fff;border-color:var(--border-main);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:50px;line-height:1.2;}
    .roulette-num-btn.red{background:#cc0000;}
    .roulette-num-btn.black{background:#222222;}
    .roulette-num-btn.selected{outline:2px solid yellow;outline-offset:1px;box-shadow:inset 0 0 0 2px yellow;}
    #roulette-selected-info{text-align:center;font-size:14px;color:var(--text-system);margin:8px 0;min-height:20px;}

    /* ════ WINDOW SYSTEM ════
       Desktop (>=700px): draggable floating windows, no backdrop
       Mobile (<700px):   centered overlay (original behaviour)
    */
    .win-titlebar-btns{display:flex;align-items:center;gap:0;}
    .modal-minimize{font-family:'VT323',monospace;font-size:18px;line-height:1;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);width:22px;height:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;margin-right:3px;flex-shrink:0;}
    .modal-minimize:active{border-color:var(--border-inset) white white var(--border-inset);}
    .modal-close{font-family:'VT323',monospace;font-size:16px;background:#800000;color:white;border:2px solid;border-color:#ff8080 #400000 #400000 #ff8080;width:22px;height:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;line-height:1;}
    .modal-titlebar{background:var(--bg-titlebar);color:var(--text-titlebar);padding:6px 10px;display:flex;justify-content:space-between;align-items:center;font-size:18px;letter-spacing:1px;}
    .modal-body{padding:16px;}

    @media(max-width:699px){
      .modal-minimize{display:none;}
      .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;align-items:center;justify-content:center;}
      .modal-overlay.open{display:flex;}
      .modal-box{background:var(--bg-window);border:3px solid;border-color:var(--border-main);width:90%;font-family:'VT323',monospace;color:var(--text-main);}
    }
    @media(min-width:700px){
      .modal-overlay{display:none;position:fixed;background:none;z-index:500;}
      .modal-overlay.open{display:block;}
      .modal-box{background:var(--bg-window);border:3px solid;border-color:var(--border-main);font-family:'VT323',monospace;color:var(--text-main);box-shadow:4px 4px 0 rgba(0,0,0,0.45);}
      .modal-titlebar{cursor:move;user-select:none;}
      .modal-overlay.win-focused{z-index:600;}
      /* Minimised: collapse to titlebar only */
      .modal-overlay.minimized .modal-body{display:none!important;}
      .modal-overlay.minimized .win-body{display:none!important;}
      /* for announcement/patchnotes which use a plain div wrapper */
      .modal-overlay.minimized>div>.win-hideable{display:none!important;}
    }

    /* window width caps */
    #keypad-modal .modal-box{max-width:280px;}
    #room-created-modal .modal-box{max-width:300px;}
    #changepass-modal .modal-box{max-width:320px;}
    #daily-modal .modal-box{max-width:320px;}
    #profile-modal .modal-box{max-width:340px;}
    #settings-overlay .modal-box{max-width:420px;}
    #shop-overlay .modal-box{max-width:520px;}
    #games-overlay .modal-box{max-width:500px;}
    #announcement-modal .modal-box{max-width:500px;}
    #patchnotes-modal .modal-box{max-width:600px;}

    .keypad-room-name{text-align:center;font-size:17px;color:var(--text-system);margin-bottom:10px;}
    .keypad-dots{display:flex;justify-content:center;gap:8px;margin-bottom:12px;min-height:24px;}
    .keypad-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border-inset);background:transparent;transition:background 0.1s;}
    .keypad-dot.filled{background:var(--poll-bar);}
    .keypad-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px;}
    .keypad-btn{font-family:'VT323',monospace;font-size:28px;padding:10px 0;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);cursor:pointer;text-align:center;user-select:none;transition:opacity 0.07s;}
    .keypad-btn:active{border-color:var(--border-inset) white white var(--border-inset);opacity:0.7;}
    .keypad-enter{background:var(--bg-titlebar);color:var(--text-titlebar);border-color:var(--border-main);}
    .keypad-clear{background:#800000;color:white;border-color:#ff8080 #400000 #400000 #ff8080;}
    .keypad-error{text-align:center;color:#cc0000;font-size:15px;min-height:20px;margin-top:6px;}
    .room-code-display{font-size:48px;letter-spacing:12px;color:var(--poll-question);margin:10px 0;font-weight:bold;}
    .room-code-label{font-size:14px;color:var(--text-system);margin-bottom:12px;}
    .room-code-note{font-size:13px;color:var(--text-system);margin-top:8px;}
    .changepass-warning{font-size:15px;color:#cc6600;margin-bottom:10px;line-height:1.4;}
    .changepass-new-code{font-size:32px;letter-spacing:8px;text-align:center;color:var(--poll-question);margin:8px 0;}
    .changepass-row{display:flex;gap:8px;margin-top:12px;}
    .changepass-confirm-btn{flex:1;padding:8px;font-family:'VT323',monospace;font-size:18px;background:#006600;color:white;border:2px solid;border-color:#0a0 #030 #030 #0a0;cursor:pointer;letter-spacing:1px;}
    .changepass-cancel-btn{flex:1;padding:8px;font-family:'VT323',monospace;font-size:18px;background:#800000;color:white;border:2px solid;border-color:#ff8080 #400000 #400000 #ff8080;cursor:pointer;letter-spacing:1px;}
    .stab-bar{display:flex;border-bottom:2px solid var(--border-inset);margin-bottom:12px;}
    .stab{flex:1;padding:6px 4px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:15px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;text-align:center;}
    .stab:last-child{border-right:none;}
    .stab.active{background:var(--bg-titlebar);color:white;}
    .stab-panel{display:none;}
    .stab-panel.active{display:block;}
    .settings-section{margin-bottom:16px;}
    .settings-label{font-size:16px;margin-bottom:6px;display:block;letter-spacing:1px;}
    .settings-note{font-size:13px;color:var(--text-system);margin-bottom:8px;}
    .theme-options{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
    .theme-btn{font-family:'VT323',monospace;font-size:16px;padding:8px 6px;border:2px solid;cursor:pointer;letter-spacing:1px;text-align:center;}
    .theme-btn.theme-opt-classic{background:#000080;color:white;border-color:#6060c0 #000040 #000040 #6060c0;}
    .theme-btn.theme-opt-noir{background:#1a1a1a;color:#d0d0d0;border-color:#444 #111 #111 #444;}
    .theme-btn.theme-opt-rose{background:#7a2d52;color:#ffe0ee;border-color:#f0a0c0 #3d1428 #3d1428 #f0a0c0;}
    .theme-btn.theme-opt-forest{background:#2a3a1a;color:#c8d8b0;border-color:#5a8a3a #1a3010 #1a3010 #5a8a3a;}
    .theme-btn.selected{outline:2px solid white;outline-offset:1px;}
    #settings-color-swatches{display:flex;flex-direction:column;gap:0;max-height:280px;overflow-y:auto;border:2px inset var(--border-inset);background:var(--bg-messages);padding:0;}
    .color-swatch{display:flex;align-items:center;gap:12px;padding:8px 12px;cursor:pointer;border:2px solid transparent;background:var(--bg-messages);min-height:32px;}
    .color-swatch:hover{background:var(--bg-window);}
    .color-swatch.selected{background:var(--bg-titlebar);border-color:var(--text-titlebar);box-shadow:inset 0 0 0 1px var(--text-titlebar);}
    .color-preview{width:32px;height:32px;border:2px solid;border-color:var(--border-main);flex-shrink:0;}
    .color-name{flex:1;font-family:'VT323',monospace;font-size:16px;}
    .color-checkmark{color:var(--text-main);font-weight:bold;width:20px;text-align:center;font-size:18px;}
    .settings-save-row{display:flex;gap:8px;margin-top:4px;}
    .settings-btn{flex:1;padding:8px;font-family:'VT323',monospace;font-size:18px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px;}
    .settings-status{font-size:14px;color:#007700;min-height:18px;margin-top:6px;text-align:center;}
    .stat-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border-inset);font-size:16px;}
    .stat-label{color:var(--text-system);}
    .stat-value{color:var(--text-main);font-weight:bold;}
    .badge-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
    .badge-item{border:2px solid var(--border-inset);padding:6px 8px;font-size:14px;cursor:pointer;background:var(--bg-messages);}
    .badge-item.earned{border-color:#007700;background:var(--poll-bg);}
    .badge-item.active-badge{border-color:#ffd700;outline:1px solid #ffd700;}
    .badge-item.locked{opacity:0.4;cursor:default;}
    .badge-icon{width:28px;height:28px;display:block;margin-bottom:3px;}
    .badge-name{font-size:15px;font-weight:bold;color:var(--text-main);}
    .badge-desc{font-size:12px;color:var(--text-system);margin-top:2px;}
    .badge-active-label{font-size:11px;color:#ffd700;margin-top:2px;}
    .badge-set-note{font-size:13px;color:var(--text-system);margin-bottom:8px;}
    .help-section{margin-bottom:14px;}
    .help-section-title{font-size:16px;font-weight:bold;color:var(--poll-question);margin-bottom:4px;letter-spacing:1px;}
    .help-cmd{font-size:14px;padding:2px 0;border-bottom:1px dotted var(--border-inset);}
    .help-cmd code{color:var(--link-title-color);font-family:'VT323',monospace;font-size:15px;}
    .daily-icon{width:48px;height:48px;display:block;margin:0 auto 8px;}
    .daily-title{font-size:24px;color:var(--poll-question);margin-bottom:8px;}
    .daily-amount{font-size:32px;color:#ffd700;margin:8px 0;display:flex;align-items:center;justify-content:center;gap:6px;}
    .daily-claim-btn{width:100%;padding:10px;font-family:'VT323',monospace;font-size:22px;background:#007700;color:white;border:2px solid;border-color:#0a0 #030 #030 #0a0;cursor:pointer;margin-top:12px;letter-spacing:1px;}
    .profile-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
    .profile-avatar-img{width:48px;height:48px;}
    .profile-name{font-size:24px;font-weight:bold;text-shadow:0 1px 2px rgba(0,0,0,0.12);}
    .profile-badge-display{font-size:16px;margin-top:2px;color:var(--text-system);display:flex;align-items:center;gap:4px;}
    .profile-stats{margin-bottom:12px;}
    .shop-tabs{display:flex;border-bottom:2px solid var(--border-inset);}
    .shop-tab{flex:1;padding:7px 4px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:16px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;text-align:center;}
    .shop-tab:last-child{border-right:none;}
    .shop-tab.active{background:var(--bg-titlebar);color:white;}
    .shop-panel{display:none;}
    .shop-panel.active{display:block;}
    .shop-balance{font-size:16px;color:#ffd700;padding:10px 0 6px;text-align:center;display:flex;align-items:center;justify-content:center;gap:5px;}
    .shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding-bottom:8px;}
    .shop-item{border:2px solid var(--border-inset);padding:8px;background:var(--bg-messages);position:relative;font-size:14px;}
    .shop-item.owned{border-color:#007700;}
    .shop-item-swatch{width:100%;height:28px;margin-bottom:6px;border:1px solid var(--border-inset);}
    .shop-item-name{font-size:16px;font-weight:bold;}
    .shop-item-desc{font-size:12px;color:var(--text-system);margin:3px 0 6px;}
    .shop-item-price{font-size:14px;color:#ffd700;display:flex;align-items:center;gap:3px;}
    .shop-item-price.free{color:#007700;}
    .shop-item-owned-badge{position:absolute;top:4px;right:4px;font-size:11px;background:#007700;color:white;padding:1px 5px;}
    .shop-buy-btn{display:block;width:100%;margin-top:6px;padding:5px;font-family:'VT323',monospace;font-size:15px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;}
    .shop-buy-btn:disabled{opacity:0.4;cursor:not-allowed;}
    .shop-status{font-size:14px;min-height:18px;margin-top:8px;text-align:center;color:#007700;}
    .shop-status.err{color:#cc0000;}
    .games-tabs{display:flex;border-bottom:2px solid var(--border-inset);flex-wrap:wrap;}
    .games-tab{flex:1;min-width:80px;padding:6px 4px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:16px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;text-align:center;}
    .games-tab:last-child{border-right:none;}
    .games-tab.active{background:var(--bg-titlebar);color:white;}
    .game-panel{display:none;padding:16px 0 0;}
    .game-panel.active{display:block;}
    .game-balance{font-size:16px;color:#ffd700;margin-bottom:12px;text-align:center;display:flex;align-items:center;justify-content:center;gap:5px;}
    .bet-row{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
    .bet-row label{font-size:16px;flex-shrink:0;}
    .bet-input{flex:1;padding:4px 8px;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);background:var(--bg-input);color:var(--text-main);min-width:0;}
    .bet-presets{display:flex;gap:4px;}
    .bet-preset{font-family:'VT323',monospace;font-size:14px;padding:2px 8px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);cursor:pointer;}
    .game-btn{width:100%;padding:10px;font-family:'VT323',monospace;font-size:20px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px;margin-top:4px;}
    .game-btn:disabled{opacity:0.5;cursor:not-allowed;}
    .game-result{margin-top:12px;padding:10px;background:var(--bg-messages);border:2px inset var(--border-inset);font-size:16px;min-height:50px;text-align:center;}
    .result-win{color:#007700;font-size:20px;}
    .result-lose{color:#cc0000;font-size:20px;}
    .result-tie{color:#cc6600;font-size:20px;}
    .slots-reels{display:flex;gap:8px;justify-content:center;margin:12px 0;font-size:40px;}
    .slot-reel{width:60px;height:60px;background:var(--bg-messages);border:3px inset var(--border-inset);display:flex;align-items:center;justify-content:center;}
    .slot-reel.spinning{animation:spinReel 0.15s infinite;}
    @keyframes spinReel{0%{transform:translateY(-4px)}50%{transform:translateY(4px)}100%{transform:translateY(-4px)}}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .dice-display{display:flex;gap:16px;justify-content:center;align-items:center;margin:12px 0;font-size:14px;text-align:center;}
    .dice-side label{display:block;margin-bottom:4px;color:var(--text-system);}
    .dice-value{font-size:48px;min-width:60px;height:60px;background:var(--bg-messages);border:3px inset var(--border-inset);display:flex;align-items:center;justify-content:center;}
    .dice-vs{font-size:20px;color:var(--text-system);}
    .lb-row{display:flex;justify-content:space-between;align-items:center;padding:4px 8px;border-bottom:1px solid var(--border-inset);font-size:16px;}
    .lb-row:nth-child(odd){background:var(--poll-bg);}
    .lb-rank{color:var(--text-system);width:30px;}
    .lb-name{flex:1;margin:0 8px;}
    .lb-coins{color:#ffd700;display:flex;align-items:center;gap:3px;}
    .lb-header{display:flex;justify-content:space-between;padding:4px 8px;font-size:14px;color:var(--text-system);border-bottom:2px solid var(--border-inset);margin-bottom:4px;}
  </style>
</head>
<body>
<!-- Auth -->
<div id="auth-screen">
  <div class="auth-titlebar"><span>chatroom</span><span class="auth-version">v2.0</span></div>
  <div class="auth-disclaimer">a small project by mce.</div>
  <div class="auth-tabs">
    <button class="auth-tab active" onclick="sfxClick();switchTab('login')">Login</button>
    <button class="auth-tab" onclick="sfxClick();switchTab('register')">Register</button>
  </div>
  <div class="auth-body">
    <div id="login-panel" class="auth-panel active">
      <p>Sign in to your account:</p>
      <input id="login-username" type="text" placeholder="Username..." maxlength="20" autocomplete="username" />
      <input id="login-password" type="password" placeholder="Password..." autocomplete="current-password" />
      <button class="primary" onclick="sfxClick();doLogin()">Login</button>
      <div class="auth-error" id="login-error"></div>
    </div>
    <div id="register-panel" class="auth-panel">
      <p>Create a new account:</p>
      <input id="reg-username" type="text" placeholder="Username (3-20 chars)..." maxlength="20" autocomplete="username" />
      <input id="reg-password" type="password" placeholder="Password (min 6 chars)..." autocomplete="new-password" />
      <input id="reg-password2" type="password" placeholder="Confirm password..." autocomplete="new-password" />
      <button class="primary" onclick="sfxClick();doRegister()">Create Account</button>
      <div class="auth-error" id="register-error"></div>
    </div>
    <div class="auth-user-count" id="auth-user-count"></div>
  </div>
</div>

<!-- Chat -->
<div id="chat-screen">
  <div id="titlebar">
    <span id="titlebar-title">chatroom</span>
    <div id="titlebar-right">
      <span id="logged-in-as"></span>
      <span id="coin-display">
        <img class="sprite" src="/sprites/coinIcon.png" width="16" height="16" alt="coins" onerror="this.src='/sprites/placeholder.png'">
        <span id="coin-amount">0</span>
      </span>
      <button class="icon-btn" onclick="sfxClick();openShop()" title="Shop">
        <img class="pixel-icon" src="/sprites/shopButtonIcon.png" alt="Shop" onerror="this.src='/sprites/placeholder.png'">
      </button>
      <button class="icon-btn" onclick="sfxClick();openGames()" title="Games">
        <img class="pixel-icon" src="/sprites/gameButtonIcon.png" alt="Games" onerror="this.src='/sprites/placeholder.png'">
      </button>
      <button id="user-count-btn" class="icon-btn" onclick="sfxClick();toggleUsers()" title="Online users">
        <img class="pixel-icon" src="/sprites/onlineUsersButtonIcon.png" alt="Users" onerror="this.src='/sprites/placeholder.png'">
        <span id="user-count-text">0</span>
      </button>
      <button class="icon-btn" onclick="sfxClick();openSettings()" title="Settings">
        <img class="pixel-icon" src="/sprites/settingsButtonIcon.png" alt="Settings" onerror="this.src='/sprites/placeholder.png'">
      </button>
      <button class="icon-btn danger" onclick="sfxClick();doLogout()" title="Exit">
        <img class="pixel-icon" src="/sprites/closeIcon.png" alt="Exit" onerror="this.style.display='none';this.parentNode.appendChild(document.createTextNode('&#x2715;'))">
      </button>
    </div>
  </div>
  <div id="reconnect-banner">
    <img class="sprite" src="/sprites/warningIcon.png" width="14" height="14" alt="!" onerror="this.src='/sprites/placeholder.png'">
    Connection lost &mdash; reconnecting...
  </div>
  <div id="chat-layout">
    <div id="rooms-sidebar">
      <h3>ROOMS</h3>
      <div id="rooms-list"></div>
    </div>
    <div id="main-area">
      <div id="users-panel"></div>
      <ul id="messages"></ul>
      <div id="typing-bar"></div>
      <div id="bottom">
        <input id="input" placeholder="Message, '/help' for commands" autocomplete="off" />
        <button id="send-btn" onclick="sfxClick();send()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- ══ FLOATING WINDOWS ══ -->

<!-- KEYPAD -->
<div id="keypad-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span><img class="sprite" src="/sprites/lockIcon.png" width="16" height="16" alt="" onerror="this.src='/sprites/placeholder.png'"> Enter Room Code</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('keypad-modal')">_</button>
        <button class="modal-close" onclick="sfxClick();closeKeypad()">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="keypad-room-name" id="keypad-room-label"></div>
      <div class="keypad-dots" id="keypad-dots"></div>
      <div class="keypad-grid">
        <button class="keypad-btn" onclick="keypadPress('1')">1</button><button class="keypad-btn" onclick="keypadPress('2')">2</button><button class="keypad-btn" onclick="keypadPress('3')">3</button>
        <button class="keypad-btn" onclick="keypadPress('4')">4</button><button class="keypad-btn" onclick="keypadPress('5')">5</button><button class="keypad-btn" onclick="keypadPress('6')">6</button>
        <button class="keypad-btn" onclick="keypadPress('7')">7</button><button class="keypad-btn" onclick="keypadPress('8')">8</button><button class="keypad-btn" onclick="keypadPress('9')">9</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px;">
        <button class="keypad-btn keypad-clear" onclick="sfxClick();keypadClear()">&#x232B;</button>
        <button class="keypad-btn" onclick="keypadPress('0')">0</button>
        <button class="keypad-btn keypad-enter" onclick="sfxClick();keypadSubmit()">&#x21B5;</button>
      </div>
      <div class="keypad-error" id="keypad-error"></div>
    </div>
  </div>
</div>

<!-- ROOM CREATED -->
<div id="room-created-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span><img class="sprite" src="/sprites/lockIcon.png" width="16" height="16" alt="" onerror="this.src='/sprites/placeholder.png'"> Room Created</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('room-created-modal')">_</button>
        <button class="modal-close" onclick="sfxClick();closeRoomCreated()">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body" style="text-align:center;">
      <div style="font-size:17px;margin-bottom:4px;">Room <strong id="rc-room-name"></strong> is ready!</div>
      <div class="room-code-label">Share this code with anyone you want to join:</div>
      <div class="room-code-display" id="rc-room-code"></div>
      <div class="room-code-note">The code also appears under the room name in your sidebar.</div>
      <button class="settings-btn" style="margin-top:14px;width:100%" onclick="sfxClick();closeRoomCreated()">Got it</button>
    </div>
  </div>
</div>

<!-- CHANGEPASS -->
<div id="changepass-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span><img class="sprite" src="/sprites/warningIcon.png" width="16" height="16" alt="" onerror="this.src='/sprites/placeholder.png'"> Confirm Code Change</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('changepass-modal')">_</button>
        <button class="modal-close" onclick="sfxClick();closeChangepass()">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="changepass-warning">This will kick ALL current members from the room. They will need the new code to re-join.</div>
      <div style="font-size:14px;color:var(--text-system);margin-bottom:4px;">New code for <strong id="cp-room-name"></strong>:</div>
      <div class="changepass-new-code" id="cp-new-code"></div>
      <div class="changepass-row">
        <button class="changepass-confirm-btn" onclick="sfxClick();confirmChangepass()">Confirm</button>
        <button class="changepass-cancel-btn" onclick="sfxClick();closeChangepass()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- DAILY REWARD -->
<div id="daily-modal" class="modal-overlay">
  <div class="modal-box" style="text-align:center;">
    <div class="modal-titlebar">
      <span>Daily Reward</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('daily-modal')">_</button>
        <button class="modal-close" onclick="sfxClick();closeDailyModal()">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body">
      <img class="daily-icon" src="/sprites/coinIcon.png" alt="Coin" onerror="this.src='/sprites/placeholder.png'">
      <div class="daily-title">Daily Bonus Available!</div>
      <div style="font-size:15px;color:var(--text-system);margin-bottom:4px;">Claim your free coins for today</div>
      <div class="daily-amount">
        <img class="sprite" src="/sprites/coinIcon.png" width="32" height="32" alt="coin" onerror="this.src='/sprites/placeholder.png'">
        +50 coins
      </div>
      <button class="daily-claim-btn" onclick="sfxClick();claimDaily()">Claim Reward</button>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div id="profile-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span id="profile-modal-title">Profile</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('profile-modal')">_</button>
        <button class="modal-close" onclick="sfxClick();closeProfile()">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body" id="profile-modal-body">Loading...</div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settings-overlay" class="modal-overlay">
  <div class="modal-box" id="settings-modal">
    <div class="modal-titlebar">
      <span>Settings</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('settings-overlay')">_</button>
        <button class="modal-close" onclick="sfxClick();closeSettings()">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="stab-bar">
        <button class="stab active" onclick="sfxClick();switchSettingsTab('appearance')">Look</button>
        <button class="stab" onclick="sfxClick();switchSettingsTab('badges')">Badges</button>
        <button class="stab" onclick="sfxClick();switchSettingsTab('stats')">Stats</button>
        <button class="stab" onclick="sfxClick();switchSettingsTab('account')">Account</button>
        <button class="stab" onclick="sfxClick();switchSettingsTab('help')">Help</button>
      </div>
      <div id="stab-appearance" class="stab-panel active">
        <div class="settings-section">
          <span class="settings-label">Sound Effects</span>
          <button id="sound-toggle-btn" class="icon-btn on" onclick="sfxClick();toggleSound()" title="Toggle SFX">Sound On</button>
        </div>
        <div class="settings-section">
          <span class="settings-label">Theme</span>
          <div class="settings-note">Only owned themes shown. Buy more in the Shop.</div>
          <div class="theme-options" id="settings-theme-options"></div>
        </div>
        <div class="settings-section">
          <span class="settings-label">Username Colour</span>
          <div class="settings-note">Only owned colours shown.</div>
          <div id="settings-color-swatches"></div>
        </div>
        <div class="settings-save-row"><button class="settings-btn" onclick="sfxClick();saveSettings()">Save</button></div>
        <div class="settings-status" id="settings-status"></div>
      </div>
      <div id="stab-badges" class="stab-panel">
        <div class="badge-set-note">Click an earned badge to set it as your active showcase badge.</div>
        <div class="badge-grid" id="badge-grid"></div>
        <div class="settings-status" id="badge-status"></div>
      </div>
      <div id="stab-stats" class="stab-panel">
        <div id="stats-content"><div style="text-align:center;padding:20px;color:var(--text-system);">Loading...</div></div>
      </div>
      <div id="stab-account" class="stab-panel" style="padding:6px 0 0;">
        <div class="settings-section">
          <span class="settings-label">Change Password</span>
          <div class="settings-note">Provide your current password, then choose a new one.</div>
          <input id="pw-old" type="password" placeholder="Current password" style="width:100%;margin:8px 0;padding:6px;font-family:'VT323',monospace;font-size:16px;border:2px inset var(--border-inset);background:var(--auth-input-bg);color:var(--text-main);" />
          <input id="pw-new" type="password" placeholder="New password (min 6 chars)" style="width:100%;margin:8px 0;padding:6px;font-family:'VT323',monospace;font-size:16px;border:2px inset var(--border-inset);background:var(--auth-input-bg);color:var(--text-main);" />
          <input id="pw-new2" type="password" placeholder="Confirm new password" style="width:100%;margin:8px 0;padding:6px;font-family:'VT323',monospace;font-size:16px;border:2px inset var(--border-inset);background:var(--auth-input-bg);color:var(--text-main);" />
          <div class="settings-save-row"><button class="settings-btn" onclick="sfxClick();changePassword()">Change Password</button></div>
          <div class="settings-status" id="pw-status"></div>
        </div>
      </div>
      <div id="stab-help" class="stab-panel">
        <div style="max-height:340px;overflow-y:auto;">
          <div class="help-section"><div class="help-section-title">Chat</div>
            <div class="help-cmd"><code>/me action</code> &mdash; emote action</div>
            <div class="help-cmd"><code>/msg username text</code> &mdash; private DM</div>
          </div>
          <div class="help-section"><div class="help-section-title">Polls</div>
            <div class="help-cmd"><code>/poll "Question?" Yes No Maybe</code> &mdash; create a 5-min poll</div>
          </div>
          <div class="help-section"><div class="help-section-title">Duels</div>
            <div class="help-cmd"><code>/duel username amount</code> &mdash; challenge to coinflip</div>
            <div class="help-cmd"><code>/accept</code> / <code>/decline</code> &mdash; respond to a challenge</div>
          </div>
          <div class="help-section"><div class="help-section-title">Coins</div>
            <div class="help-cmd"><code>/give username amount</code> &mdash; send coins</div>
            <div class="help-cmd"><code>/claim</code> &mdash; grab free coins during events</div>
          </div>
          <div class="help-section"><div class="help-section-title">Private Rooms</div>
            <div class="help-cmd"><code>/create roomname code</code></div>
            <div class="help-cmd"><code>/joinroom roomname</code></div>
            <div class="help-cmd"><code>/kick username</code> &mdash; (owner)</div>
            <div class="help-cmd"><code>/ban username</code> / <code>/unban username</code> &mdash; (owner)</div>
            <div class="help-cmd"><code>/changepass newcode</code> &mdash; (owner)</div>
            <div class="help-cmd"><code>/deleteroom roomname</code> &mdash; (owner)</div>
            <div class="help-cmd">Codes are 1&ndash;9 digits only</div>
          </div>
          <div class="help-section"><div class="help-section-title">Reactions</div>
            <div class="help-cmd">Hover a message &rarr; click + &rarr; pick an emoji</div>
          </div>
          <div class="help-section"><div class="help-section-title">Games</div>
            <div class="help-cmd">Slots &mdash; match 3 symbols, up to 20x bet</div>
            <div class="help-cmd">Dice &mdash; beat the house, win 1.9x</div>
            <div class="help-cmd">Roulette &mdash; red/black or even/odd, 1.8x payout</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SHOP -->
<div id="shop-overlay" class="modal-overlay">
  <div class="modal-box" id="shop-modal">
    <div class="modal-titlebar">
      <span><img class="sprite" src="/sprites/shopButtonIcon.png" width="18" height="18" alt="" onerror="this.src='/sprites/placeholder.png'"> Shop</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('shop-overlay')">_</button>
        <button class="modal-close" onclick="sfxClick();closeShop()">&#x2715;</button>
      </div>
    </div>
    <div style="padding:0 16px;">
      <div class="shop-balance" id="shop-balance">
        <img class="sprite" src="/sprites/coinIcon.png" width="18" height="18" alt="coin" onerror="this.src='/sprites/placeholder.png'">
        Balance: <span id="shop-balance-amt">0</span>
      </div>
      <div class="shop-tabs">
        <button class="shop-tab active" onclick="sfxClick();switchShopTab('themes')">Themes</button>
        <button class="shop-tab" onclick="sfxClick();switchShopTab('colors')">Username Colours</button>
      </div>
    </div>
    <div style="padding:0 16px 16px;max-height:380px;overflow-y:auto;">
      <div id="shop-themes" class="shop-panel active"></div>
      <div id="shop-colors" class="shop-panel"></div>
    </div>
    <div style="padding:0 16px 12px;"><div class="shop-status" id="shop-status"></div></div>
  </div>
</div>

<!-- GAMES -->
<div id="games-overlay" class="modal-overlay">
  <div class="modal-box" id="games-modal">
    <div class="modal-titlebar">
      <span><img class="sprite" src="/sprites/gameButtonIcon.png" width="16" height="16" alt="" onerror="this.src='/sprites/placeholder.png'"> Games</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('games-overlay')">_</button>
        <button class="modal-close" onclick="sfxClick();closeGames()">&#x2715;</button>
      </div>
    </div>
    <div style="padding:0 16px;">
      <div class="games-tabs">
        <button class="games-tab active" onclick="sfxClick();switchGame('slots')"><img class="sprite" src="/sprites/slotsIcon.png" width="13" height="13" alt="" onerror="this.src='/sprites/placeholder.png'"> Slots</button>
        <button class="games-tab" onclick="sfxClick();switchGame('dice')"><img class="sprite" src="/sprites/diceIcon.png" width="13" height="13" alt="" onerror="this.src='/sprites/placeholder.png'"> Dice</button>
        <button class="games-tab" onclick="sfxClick();switchGame('roulette')"><img class="sprite" src="/sprites/rouletteIcon.png" width="13" height="13" alt="" onerror="this.src='/sprites/placeholder.png'"> Roulette</button>
        <button class="games-tab" onclick="sfxClick();switchGame('leaderboard')"><img class="sprite" src="/sprites/trophyIcon.png" width="13" height="13" alt="" onerror="this.src='/sprites/placeholder.png'"> Board</button>
      </div>
    </div>
    <div id="game-slots" class="game-panel active" style="padding:0 16px 16px;">
      <div class="game-balance" id="slots-balance"><img class="sprite" src="/sprites/coinIcon.png" width="18" height="18" alt="coin" onerror="this.src='/sprites/placeholder.png'"> Balance: <span id="slots-balance-amt">0</span></div>
      <div class="slots-reels">
        <div class="slot-reel" id="reel-0"><img class="sprite" src="/sprites/slotsIcon.png" width="40" height="40" alt="?" onerror="this.src='/sprites/placeholder.png'"></div>
        <div class="slot-reel" id="reel-1"><img class="sprite" src="/sprites/slotsIcon.png" width="40" height="40" alt="?" onerror="this.src='/sprites/placeholder.png'"></div>
        <div class="slot-reel" id="reel-2"><img class="sprite" src="/sprites/slotsIcon.png" width="40" height="40" alt="?" onerror="this.src='/sprites/placeholder.png'"></div>
      </div>
      <div class="bet-row"><label>Bet:</label><input type="number" class="bet-input" id="slots-bet" value="10" min="1" max="50000" /><div class="bet-presets"><button class="bet-preset" onclick="sfxClick();setBet('slots',10)">10</button><button class="bet-preset" onclick="sfxClick();setBet('slots',50)">50</button><button class="bet-preset" onclick="sfxClick();setBet('slots',100)">100</button></div></div>
      <button class="game-btn" id="slots-spin-btn" onclick="sfxClick();playSlots()">SPIN</button>
      <div class="game-result" id="slots-result"></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">Cherry=2x &middot; Lemon=3x &middot; Orange=4x &middot; Star=6x &middot; Diamond=8x &middot; Seven=20x</div>
    </div>
    <div id="game-dice" class="game-panel" style="padding:0 16px 16px;">
      <div class="game-balance" id="dice-balance"><img class="sprite" src="/sprites/coinIcon.png" width="18" height="18" alt="coin" onerror="this.src='/sprites/placeholder.png'"> Balance: <span id="dice-balance-amt">0</span></div>
      <div class="dice-display">
        <div class="dice-side"><label>You</label><div class="dice-value" id="dice-player">?</div></div>
        <div class="dice-vs">VS</div>
        <div class="dice-side"><label>House</label><div class="dice-value" id="dice-house">?</div></div>
      </div>
      <div class="bet-row"><label>Bet:</label><input type="number" class="bet-input" id="dice-bet" value="10" min="1" max="50000" /><div class="bet-presets"><button class="bet-preset" onclick="sfxClick();setBet('dice',10)">10</button><button class="bet-preset" onclick="sfxClick();setBet('dice',50)">50</button><button class="bet-preset" onclick="sfxClick();setBet('dice',100)">100</button></div></div>
      <button class="game-btn" id="dice-roll-btn" onclick="sfxClick();playDice()">ROLL DICE</button>
      <div class="game-result" id="dice-result"></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">Roll 2 dice vs the house. Higher total wins 1.9x &middot; Tie returns bet</div>
    </div>
    <div id="game-roulette" class="game-panel" style="padding:0 16px 16px;">
      <div class="game-balance" id="roulette-balance"><img class="sprite" src="/sprites/coinIcon.png" width="18" height="18" alt="coin" onerror="this.src='/sprites/placeholder.png'"> Balance: <span id="roulette-balance-amt">0</span></div>
      <div style="display:flex;justify-content:center;margin:16px 0;"><div style="text-align:center;"><label style="font-size:12px;color:var(--text-system);">Spin</label><div style="font-size:28px;margin-top:4px;" id="roulette-spin"><img class="sprite" src="/sprites/rouletteIcon.png" width="40" height="40" alt="Roulette" onerror="this.src='/sprites/placeholder.png'"></div></div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0;">
        <button class="game-btn" id="roulette-red-btn" onclick="sfxClick();playRoulette('red')" style="background:#cc0000;">RED</button>
        <button class="game-btn" id="roulette-black-btn" onclick="sfxClick();playRoulette('black')" style="background:#222;color:#fff;">BLACK</button>
        <button class="game-btn" onclick="sfxClick();playRoulette('even')" style="background:#0056b3;">2,4,6... EVEN</button>
        <button class="game-btn" onclick="sfxClick();playRoulette('odd')" style="background:#0056b3;">1,3,5... ODD</button>
      </div>
      <div class="bet-row"><label>Bet:</label><input type="number" class="bet-input" id="roulette-bet" value="10" min="1" max="50000" /><div class="bet-presets"><button class="bet-preset" onclick="sfxClick();setBet('roulette',10)">10</button><button class="bet-preset" onclick="sfxClick();setBet('roulette',50)">50</button><button class="bet-preset" onclick="sfxClick();setBet('roulette',100)">100</button></div></div>
      <div id="roulette-selected-info"></div>
      <div style="font-size:12px;color:var(--text-system);margin:8px 0;">Or pick a specific number (50x payout):</div>
      <div id="roulette-number-grid"></div>
      <div class="game-result" id="roulette-result"></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">Red/Black/Even/Odd = 1.8x &middot; Number = 50x. Spin 0 is green (house win)</div>
    </div>
    <div id="game-leaderboard" class="game-panel" style="padding:0 16px 16px;">
      <div class="lb-header"><span>Rank</span><span>Player</span><span>Coins</span></div>
      <div id="leaderboard-rows"><div style="text-align:center;color:var(--text-system);padding:20px;">Loading...</div></div>
      <button class="game-btn" style="margin-top:12px;" onclick="sfxClick();loadLeaderboard()">Refresh</button>
    </div>
  </div>
</div>

<!-- ANNOUNCEMENT -->
<div id="announcement-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span style="display:flex;align-items:center;gap:6px;"><img class="sprite" src="/sprites/warningIcon.png" width="16" height="16" alt="!" onerror="this.src='/sprites/placeholder.png'"> Server Announcement</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('announcement-modal')">_</button>
        <button class="modal-close" onclick="sfxClick();closeAnnouncement()">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body">
      <div id="announcement-content" style="color:var(--text-main);margin-bottom:16px;line-height:1.5;"></div>
      <button class="game-btn" onclick="sfxClick();closeAnnouncement()">Close</button>
    </div>
  </div>
</div>

<!-- PATCH NOTES -->
<div id="patchnotes-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span>Patch Notes</span>
      <div class="win-titlebar-btns">
        <button class="modal-minimize" onclick="sfxClick();winMinimize('patchnotes-modal')">_</button>
        <button class="modal-close" onclick="sfxClick();closePatchNotes()">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body" style="max-height:60vh;overflow-y:auto;">
      <div id="patchnotes-content" style="color:var(--text-main);line-height:1.6;font-size:14px;">
        <div style="margin-bottom:16px;">
          <div style="font-weight:bold;margin-bottom:8px;">Latest Updates</div>
          <ul style="margin:0;padding-left:20px;">
            <li>New Forest theme &mdash; deep greens and earthy browns</li>
            <li>Dark theme renamed to Noir</li>
            <li>Streamlined colour shop &mdash; distinct colours at 500 coins each</li>
            <li>New premium effects: Gold pulse, Rainbow glow, Neon Red, Neon Purple</li>
            <li>Colour names now styled in their own colour in shop and settings</li>
            <li>All windows are now draggable and minimisable</li>
          </ul>
        </div>
      </div>
      <button class="game-btn" onclick="sfxClick();closePatchNotes()" style="margin-top:16px;">Close</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ── SPRITE HELPER ──────────────────────────────────────────────────────────
const KNOWN_SPRITES=new Set(['coinIcon.png','shopButtonIcon.png','gameButtonIcon.png','closeIcon.png','warningIcon.png','lockIcon.png','slotsIcon.png','diceIcon.png','rouletteIcon.png','cherryIcon.png','lemonIcon.png','orangeIcon.png','starIcon.png','diamondIcon.png','sevenIcon.png','trophyIcon.png','profileAvatar.png','goldMedal.png','silverMedal.png','bronzeMedal.png','onlineUsersButtonIcon.png','settingsButtonIcon.png','placeholder.png']);
function si(file,w,h,alt){w=w||20;h=h||20;alt=alt||'';const fb=KNOWN_SPRITES.has(file)?` onerror="this.onerror=null;this.src='/sprites/placeholder.png'"` : '';return `<img class="sprite" src="/sprites/${file}" width="${w}" height="${h}" alt="${alt}"${fb}>`;}
const BADGE_SPRITES={lurker_no_more:'starIcon.png',regular:'starIcon.png',chatterbox:'starIcon.png',motormouth:'starIcon.png',legendary:'trophyIcon.png',feeling_lucky:'diceIcon.png',high_roller:'coinIcon.png',loaded:'coinIcon.png',whale:'diamondIcon.png',tycoon:'diamondIcon.png',mogul:'trophyIcon.png'};
const SHOP_COLORS={'#ccaa00':{name:'Gold',effect:'gold'},'#ff6bcb':{name:'Rainbow',effect:'rainbow'},'#ff0044':{name:'Neon Red',effect:'neon_red'},'#cc00ff':{name:'Neon Purple',effect:'neon_purple'}};
function darkenHex(hex,amount){hex=hex.replace('#','');if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');const r=Math.max(0,parseInt(hex.slice(0,2),16)-amount),g=Math.max(0,parseInt(hex.slice(2,4),16)-amount),b=Math.max(0,parseInt(hex.slice(4,6),16)-amount);return `rgb(${r},${g},${b})`;}
function setCoinAmountShadow(color){const el=document.getElementById('coin-amount');if(!el)return;const dark=darkenHex(color,80);el.style.textShadow=`1px 1px 0 ${dark}, 0 1px 4px rgba(0,0,0,0.6)`;}

// ── SOUNDS ─────────────────────────────────────────────────────────────────
let soundEnabled=true;
const _sounds={};
['click','hover','message','join','leave','dm','pollEnd','win','lose','coin','claim','keypad','spin','roll','bet','notify'].forEach(n=>{const a=new Audio(`/sounds/${n}.wav`);a.preload='auto';_sounds[n]=a;});
function playSound(name,vol){if(!soundEnabled)return;const a=_sounds[name];if(!a)return;try{a.volume=Math.min(1,Math.max(0,vol||1));a.currentTime=0;a.play().catch(()=>{});}catch(e){}}
function sfxClick(){playSound('click',0.7);}
function sfxHover(){playSound('hover',0.4);}
function soundMessage(){playSound('message',0.8);}
function soundJoin(){playSound('join',0.9);}
function soundLeave(){playSound('leave',0.8);}
function soundDM(){playSound('dm',1.0);}
function soundPollEnd(){playSound('pollEnd',0.9);}
function soundWin(){playSound('win',1.0);}
function soundLose(){playSound('lose',0.9);}
function soundCoin(){playSound('coin',0.8);}
function soundClaim(){playSound('claim',1.0);}
function soundKeypad(){playSound('keypad',0.6);}
function soundNotify(){playSound('notify',1.0);}
function toggleSound(){soundEnabled=!soundEnabled;const btn=document.getElementById('sound-toggle-btn');btn.textContent=soundEnabled?'Sound On':'Sound Off';btn.classList.toggle('on',soundEnabled);}
document.addEventListener('mouseover',e=>{const el=e.target.closest('button,.room-btn,.msg-user,.uname,.reaction-pill,.poll-option,.color-swatch,.badge-item,.shop-buy-btn,.bet-preset,.keypad-btn,.theme-btn,.stab,.shop-tab,.games-tab,.auth-tab');if(el)sfxHover();},{passive:true});

// ── STATE ──────────────────────────────────────────────────────────────────
const socket=io({autoConnect:false,reconnection:true,reconnectionAttempts:Infinity,reconnectionDelay:1000,reconnectionDelayMax:10000,timeout:20000});
let myUsername=null,myColor='#000080',myCoins=0,selectedTheme='classic';
let currentRoom='general',pendingRoom=null,usersVisible=false,isTyping=false,typingTimer;
let myToken=null;
const unreadCounts={},polls={};
let shopItems=[],selectedSettingsColor='#000080',selectedSettingsTheme='classic';
let keypadRoom=null,keypadCode='';
let pendingChangepass=null;
const ownerRoomCodes={};

// ── UTILS ──────────────────────────────────────────────────────────────────
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function fmtNum(n){const v=Number(n);return isNaN(v)?String(n):v.toLocaleString();}
function updateCoinDisplay(){document.getElementById('coin-amount').textContent=fmtNum(myCoins);document.getElementById('shop-balance-amt').textContent=fmtNum(myCoins);['slots','dice','roulette'].forEach(g=>{const el=document.getElementById(g+'-balance-amt');if(el)el.textContent=fmtNum(myCoins);});}
function formatDuration(ms){const t=Math.floor(ms/1000),d=Math.floor(t/86400),h=Math.floor((t%86400)/3600),m=Math.floor((t%3600)/60),s=t%60;if(d>0)return d+'D '+h+'HR '+m+'M';if(h>0)return h+'HR '+m+'M';if(m>0)return m+'M '+s+'S';return s+'S';}
function formatSeconds(s){if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';if(s<86400)return Math.floor(s/3600)+'h '+Math.floor((s%3600)/60)+'m';return Math.floor(s/86400)+'d '+Math.floor((s%86400)/3600)+'h';}
function formatTime(ts){return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
function formatDate(d){return new Date(d).toLocaleDateString([],{year:'numeric',month:'short',day:'numeric'});}
function applyTheme(theme){document.body.className=document.body.className.replace(/theme-\w+/g,'').trim();if(theme!=='classic')document.body.classList.add('theme-'+theme);selectedTheme=theme;}

// ═══════════════════════════════════════════════════════════════
// WINDOW MANAGER
// ═══════════════════════════════════════════════════════════════
const IS_DESKTOP=()=>window.innerWidth>=700;
let winZCounter=500;
const WIN_OFFSETS={};

// Default spawn positions (staggered so windows don't stack exactly)
const WIN_DEFAULTS={
  'settings-overlay':  {x:60, y:55},
  'shop-overlay':      {x:80, y:45},
  'games-overlay':     {x:100,y:65},
  'profile-modal':     {x:120,y:75},
  'daily-modal':       {x:200,y:110},
  'keypad-modal':      {x:220,y:90},
  'room-created-modal':{x:180,y:100},
  'changepass-modal':  {x:160,y:80},
  'announcement-modal':{x:140,y:95},
  'patchnotes-modal':  {x:120,y:55},
};

function winOpen(id){
  if(!IS_DESKTOP()) return;
  const el=document.getElementById(id);
  if(!el) return;
  // Position
  const pos=WIN_OFFSETS[id]||WIN_DEFAULTS[id]||{x:80,y:80};
  el.style.left=pos.x+'px';
  el.style.top=pos.y+'px';
  // Restore from minimized
  el.classList.remove('minimized');
  winFocus(id);
}

function winFocus(id){
  if(!IS_DESKTOP()) return;
  document.querySelectorAll('.modal-overlay').forEach(w=>w.classList.remove('win-focused'));
  const el=document.getElementById(id);
  if(!el) return;
  winZCounter++;
  el.style.zIndex=winZCounter;
  el.classList.add('win-focused');
}

function winMinimize(id){
  if(!IS_DESKTOP()) return;
  const el=document.getElementById(id);
  if(!el) return;
  el.classList.toggle('minimized');
}

// ── DRAG ──
let dragState=null;
function initDrag(overlayEl){
  const titlebar=overlayEl.querySelector('.modal-titlebar');
  if(!titlebar) return;
  titlebar.addEventListener('mousedown',e=>{
    if(e.target.closest('button')) return;
    if(!IS_DESKTOP()) return;
    winFocus(overlayEl.id);
    const rect=overlayEl.getBoundingClientRect();
    dragState={el:overlayEl,sx:e.clientX,sy:e.clientY,ex:rect.left,ey:rect.top};
    e.preventDefault();
  });
}
document.addEventListener('mousemove',e=>{
  if(!dragState) return;
  const dx=e.clientX-dragState.sx,dy=e.clientY-dragState.sy;
  let nx=dragState.ex+dx,ny=dragState.ey+dy;
  const w=dragState.el.offsetWidth,h=dragState.el.offsetHeight;
  nx=Math.max(0,Math.min(window.innerWidth-w,nx));
  ny=Math.max(0,Math.min(window.innerHeight-30,ny));
  dragState.el.style.left=nx+'px';
  dragState.el.style.top=ny+'px';
});
document.addEventListener('mouseup',()=>{
  if(!dragState) return;
  WIN_OFFSETS[dragState.el.id]={x:parseInt(dragState.el.style.left),y:parseInt(dragState.el.style.top)};
  dragState=null;
});
// Click any window to focus it
document.addEventListener('mousedown',e=>{
  const win=e.target.closest('.modal-overlay');
  if(win&&IS_DESKTOP()) winFocus(win.id);
},true);

function initAllWindows(){
  document.querySelectorAll('.modal-overlay').forEach(el=>initDrag(el));
}

// Helper: open a window (adds .open + positions on desktop)
function winShow(id){
  const el=document.getElementById(id);
  if(!el) return;
  el.classList.add('open');
  winOpen(id);
}

// ── AUTH ───────────────────────────────────────────────────────
function switchTab(tab){document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(i===0)===(tab==='login')));document.getElementById('login-panel').classList.toggle('active',tab==='login');document.getElementById('register-panel').classList.toggle('active',tab==='register');}
fetch('/user-count').then(r=>r.json()).then(d=>{if(d.count)document.getElementById('auth-user-count').textContent=`${d.count} registered user${d.count===1?'':'s'}`;}).catch(()=>{});

async function doLogin(){
  const u=document.getElementById('login-username').value.trim(),p=document.getElementById('login-password').value,e=document.getElementById('login-error');
  e.textContent='';if(!u||!p){e.textContent='Please fill in all fields.';return;}
  const res=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  const data=await res.json();if(!res.ok){e.textContent=data.error;return;}
  enterChat(data.username,data.color||'#000080',data.theme||'classic',data.coins||0,data.token,data.dailyAvailable);
}
async function doRegister(){
  const u=document.getElementById('reg-username').value.trim(),p=document.getElementById('reg-password').value,p2=document.getElementById('reg-password2').value,e=document.getElementById('register-error');
  e.textContent='';if(!u||!p||!p2){e.textContent='Please fill in all fields.';return;}if(p!==p2){e.textContent='Passwords do not match.';return;}
  const res=await fetch('/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  const data=await res.json();if(!res.ok){e.textContent=data.error;return;}
  enterChat(data.username,data.color||'#000080',data.theme||'classic',data.coins||100,data.token,false);
}
async function doLogout(){await fetch('/logout',{method:'POST'});socket.disconnect();location.reload();}

function enterChat(username,color,theme,coins,token,dailyAvailable){
  myUsername=username;myColor=color||'#000080';myCoins=coins||0;myToken=token;
  applyTheme(theme||'classic');
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('chat-screen').style.display='block';
  setLoggedInAs(username,color);updateCoinDisplay();setCoinAmountShadow(myColor);
  document.getElementById('input').focus();
  socket.connect();
  initAllWindows();
  if(dailyAvailable) setTimeout(showDailyModal,1500);
}
function setLoggedInAs(username,color){const ci=SHOP_COLORS[color];const ec=ci?` user-${ci.effect}`:'';document.getElementById('logged-in-as').innerHTML=`<span class="${ec}" style="color:${color};text-shadow:0 0 2px rgba(255,255,255,0.5)">${escHtml(username)}</span>`;setCoinAmountShadow(color);}

// ── RECONNECTION ───────────────────────────────────────────────
socket.on('disconnect',reason=>{if(reason==='io server disconnect')return;document.getElementById('reconnect-banner').classList.add('visible');document.getElementById('input').disabled=true;document.getElementById('send-btn').disabled=true;});
socket.on('connect',()=>{document.getElementById('reconnect-banner').classList.remove('visible');document.getElementById('input').disabled=false;document.getElementById('send-btn').disabled=false;if(myToken)socket.emit('join',myToken);});
socket.on('reconnect',()=>{if(currentRoom&&currentRoom!=='general')socket.emit('switch room',{room:currentRoom});});

// ── ROOMS ──────────────────────────────────────────────────────
function renderRooms(rooms){
  const list=document.getElementById('rooms-list');list.innerHTML='';
  rooms.forEach(r=>{
    const name=typeof r==='string'?r:r.name,isPrivate=typeof r==='object'&&r.isPrivate,serverCode=typeof r==='object'&&r.ownerCode?r.ownerCode:null;
    if(serverCode)ownerRoomCodes[name]=serverCode;
    const btn=document.createElement('button');btn.className='room-btn'+(name===currentRoom?' active':'');btn.dataset.room=name;
    if(isPrivate){const li=document.createElement('img');li.className='sprite room-private-icon';li.src='/sprites/lockIcon.png';li.width=15;li.height=15;li.alt='private';li.onerror=function(){this.onerror=null;this.src='/sprites/placeholder.png';};btn.appendChild(li);btn.appendChild(document.createTextNode(' '));}
    btn.appendChild(document.createTextNode('#'+name));
    if(unreadCounts[name]){const badge=document.createElement('span');badge.className='room-unread';badge.textContent=unreadCounts[name];btn.appendChild(badge);}
    btn.onclick=()=>{sfxClick();switchRoom(name);};
    list.appendChild(btn);
  });
}
function switchRoom(room){if(room===currentRoom||room===pendingRoom)return;pendingRoom=room;socket.emit('switch room',{room});}

// ── KEYPAD ─────────────────────────────────────────────────────
function openKeypad(room){
  keypadRoom=room;keypadCode='';
  document.getElementById('keypad-room-label').textContent='#'+room;
  document.getElementById('keypad-error').textContent='';
  renderKeypadDots();
  winShow('keypad-modal');
}
function closeKeypad(){document.getElementById('keypad-modal').classList.remove('open');keypadRoom=null;keypadCode='';pendingRoom=null;}
function renderKeypadDots(){const wrap=document.getElementById('keypad-dots');wrap.innerHTML='';const len=Math.max(keypadCode.length,1);for(let i=0;i<Math.min(len,9);i++){const d=document.createElement('div');d.className='keypad-dot'+(i<keypadCode.length?' filled':'');wrap.appendChild(d);}}
function keypadPress(digit){if(keypadCode.length>=9)return;soundKeypad();keypadCode+=digit;document.getElementById('keypad-error').textContent='';renderKeypadDots();}
function keypadClear(){if(!keypadCode.length)return;keypadCode=keypadCode.slice(0,-1);renderKeypadDots();}
function keypadSubmit(){if(!keypadCode){document.getElementById('keypad-error').textContent='Enter a code first.';return;}pendingRoom=keypadRoom;socket.emit('switch room',{room:keypadRoom,code:keypadCode});}
document.addEventListener('keydown',e=>{
  if(!document.getElementById('keypad-modal').classList.contains('open'))return;
  if(e.key>='0'&&e.key<='9')keypadPress(e.key);
  else if(e.key==='Backspace')keypadClear();
  else if(e.key==='Enter')keypadSubmit();
});

// ── ROOM CREATED / CHANGEPASS ──────────────────────────────────
function openRoomCreated(room,code){document.getElementById('rc-room-name').textContent='#'+room;document.getElementById('rc-room-code').textContent=code;winShow('room-created-modal');}
function closeRoomCreated(){document.getElementById('room-created-modal').classList.remove('open');}
function openChangepassConfirm(room,newCode){pendingChangepass={room,newCode};document.getElementById('cp-room-name').textContent='#'+room;document.getElementById('cp-new-code').textContent=newCode;winShow('changepass-modal');}
function closeChangepass(){document.getElementById('changepass-modal').classList.remove('open');pendingChangepass=null;}
function confirmChangepass(){if(!pendingChangepass)return;socket.emit('confirm changepass',pendingChangepass);closeChangepass();}

// ── SEND / TYPING ──────────────────────────────────────────────
function send(){const inp=document.getElementById('input'),t=inp.value.trim();if(!t)return;socket.emit('chat message',t);inp.value='';stopTyping();}
document.getElementById('input').addEventListener('input',()=>{socket.emit('activity');if(!isTyping){isTyping=true;socket.emit('typing start');}clearTimeout(typingTimer);typingTimer=setTimeout(stopTyping,2000);});
function stopTyping(){if(!isTyping)return;isTyping=false;clearTimeout(typingTimer);socket.emit('typing stop');}
function toggleUsers(){usersVisible=!usersVisible;document.getElementById('users-panel').classList.toggle('visible',usersVisible);}

// ── MESSAGES ───────────────────────────────────────────────────
function addMessage(html,extraClass,timestamp,msgId){
  const messages=document.getElementById('messages');
  const atBottom=messages.scrollHeight-messages.scrollTop-messages.clientHeight<40;
  const li=document.createElement('li');li.style.listStyle='none';
  li.className='msg-row'+(extraClass?' '+extraClass:'');
  if(msgId)li.dataset.msgId=msgId;
  const ts=timestamp?`<span class="msg-ts">${formatTime(timestamp)}</span>`:'';
  const reactBtn=msgId?`<button class="msg-react-btn" title="React">+<div class="react-picker"><span class="react-emoji" data-emoji="👍">👍</span><span class="react-emoji" data-emoji="❤️">❤️</span><span class="react-emoji" data-emoji="😂">😂</span><span class="react-emoji" data-emoji="😮">😮</span></div></button>`:'';
  if(myUsername){const tmp=document.createElement('div');tmp.innerHTML=html;const re=new RegExp('@'+myUsername.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b','i');if(re.test(tmp.textContent||''))li.classList.add('msg-mention');}
  li.innerHTML=html+ts+reactBtn;
  messages.appendChild(li);
  if(atBottom)messages.scrollTop=messages.scrollHeight;
  return li;
}
function updateRoomBadge(room){const btn=document.querySelector(`.room-btn[data-room="${room}"]`);if(!btn)return;const ex=btn.querySelector('.room-unread');if(ex)ex.remove();const c=unreadCounts[room]||0;if(c>0){const s=document.createElement('span');s.className='room-unread';s.textContent=c>99?'99+':c;btn.appendChild(s);}}
function addDmMessage(data){
  const messages=document.getElementById('messages');
  const atBottom=messages.scrollHeight-messages.scrollTop-messages.clientHeight<40;
  const li=document.createElement('li');li.style.listStyle='none';
  li.className='msg-row msg-dm-row'+(!data.noFlash&&!data.self?' dm-flash':'');
  const label=data.self?`<span class="msg-dm-label">DM to ${escHtml(data.to)}:</span>`:`<span class="msg-dm-label">DM from ${escHtml(data.from)}:</span>`;
  li.innerHTML=label+`<span class="msg-text">${escHtml(data.text)}</span>`;
  messages.appendChild(li);
  if(atBottom)messages.scrollTop=messages.scrollHeight;
  if(!data.noFlash&&!data.self)soundDM();
}
document.getElementById('messages').addEventListener('click',e=>{
  const emojiBtn=e.target.closest('.react-emoji');
  if(emojiBtn){const li=emojiBtn.closest('.msg-row');if(li&&li.dataset.msgId)socket.emit('react',{messageId:parseInt(li.dataset.msgId),emoji:emojiBtn.dataset.emoji});return;}
  const pill=e.target.closest('.reaction-pill');
  if(pill){const li=pill.closest('.msg-row');if(!li||!li.dataset.msgId)return;const emoji=pill.dataset.emoji,mr=li.dataset.myReaction;if(mr===emoji)socket.emit('unreact',{messageId:parseInt(li.dataset.msgId)});else socket.emit('react',{messageId:parseInt(li.dataset.msgId),emoji});return;}
  const opt=e.target.closest('.poll-option');
  if(opt&&!opt.classList.contains('concluded')){const pollId=parseInt(opt.dataset.poll),option=opt.dataset.opt;if(pollId&&option)socket.emit('poll vote',{pollId,option});return;}
  const uEl=e.target.closest('.msg-user');
  if(uEl&&uEl.dataset.username){sfxClick();openProfile(uEl.dataset.username);}
});
function updateReactions(li,reactions,myReaction){
  let wrap=li.querySelector('.msg-reactions');
  if(!wrap){wrap=document.createElement('div');wrap.className='msg-reactions';li.appendChild(wrap);}
  wrap.innerHTML='';li.dataset.myReaction=myReaction||'';
  Object.entries(reactions).forEach(([emoji,count])=>{if(count<=0)return;const pill=document.createElement('span');pill.className='reaction-pill'+(myReaction===emoji?' selected':'');pill.dataset.emoji=emoji;pill.innerHTML=`${emoji}<span class="r-count">${count}</span>`;wrap.appendChild(pill);});
}

// ── POLLS ──────────────────────────────────────────────────────
function renderPoll(poll){polls[poll.id]=poll;const ex=document.getElementById('poll-'+poll.id);if(ex){ex.innerHTML=buildPollHtml(poll);return;}const messages=document.getElementById('messages');const atBottom=messages.scrollHeight-messages.scrollTop-messages.clientHeight<40;const li=document.createElement('li');li.style.listStyle='none';li.id='poll-'+poll.id;li.className='msg-row';li.innerHTML=buildPollHtml(poll);messages.appendChild(li);if(atBottom)messages.scrollTop=messages.scrollHeight;}
function buildPollHtml(poll){
  const total=Object.keys(poll.votes||{}).length,myVote=(poll.votes||{})[myUsername],concluded=poll.concluded;
  let topCount=0;if(concluded&&total>0){const t={};poll.options.forEach(o=>t[o]=0);Object.values(poll.votes||{}).forEach(v=>{if(t[v]!==undefined)t[v]++;});topCount=Math.max(...Object.values(t));}
  const optsHtml=poll.options.map(opt=>{const count=Object.values(poll.votes||{}).filter(v=>v===opt).length,pct=total>0?Math.round((count/total)*100):0;const isVoted=myVote===opt,isWinner=concluded&&total>0&&count===topCount;const cls=['poll-option',isVoted?'voted':'',concluded?'concluded':'',isWinner?'winner':''].filter(Boolean).join(' ');return `<div class="${cls}" data-poll="${poll.id}" data-opt="${escHtml(opt)}"><span class="poll-opt-label">${isWinner?si('trophyIcon.png',14,14,'win')+' ':''}${escHtml(opt)}</span><div class="poll-bar-wrap"><div class="poll-bar" style="width:${pct}%"></div></div><span class="poll-pct">${pct}%</span><span style="font-size:13px;color:var(--text-system)">${count}</span></div>`;}).join('');
  let timerHtml='';if(!concluded&&poll.endsAt)timerHtml=`<span class="poll-timer" data-ends="${new Date(poll.endsAt).getTime()}">...</span>`;else if(concluded)timerHtml=`<span style="color:var(--text-system)">concluded</span>`;
  return `<div class="poll-card${concluded?' poll-concluded':''}"><div class="poll-question">${si('starIcon.png',14,14,'poll')} ${escHtml(poll.question)}</div>${optsHtml}<div class="poll-meta">by ${escHtml(poll.creator)} &middot; ${total} vote${total!==1?'s':''} &middot; ${timerHtml}</div></div>`;
}

// ── HISTORY ────────────────────────────────────────────────────
function renderHistory(history){
  const messages=document.getElementById('messages');messages.innerHTML='';
  if(!history.length)return;
  addMessage(`<span class="msg-system">-- message history --</span>`);
  history.forEach(row=>{
    const ts=new Date(row.created_at).getTime();
    const ci=SHOP_COLORS[row.color];const ec=ci?` user-${ci.effect}`:'';
    if(row.type==='poll'){const poll=row.poll_data;if(!poll)return;polls[poll.id]=poll;const messages2=document.getElementById('messages');const atBottom=messages2.scrollHeight-messages2.scrollTop-messages2.clientHeight<40;const li=document.createElement('li');li.style.listStyle='none';li.id='poll-'+poll.id;li.className='msg-row';li.innerHTML=buildPollHtml(poll);messages2.appendChild(li);if(atBottom)messages2.scrollTop=messages2.scrollHeight;}
    else if(row.type==='system'){addMessage(`<span class="msg-system">*** ${escHtml(row.text)} ***</span>`,'',ts);}
    else if(row.type==='action'){addMessage(`<span class="msg-action">*** <span class="msg-user${ec}" data-username="${escHtml(row.sender)}" style="color:${row.color}">${escHtml(row.sender)}</span> ${escHtml(row.text)} ***</span>`,'',ts);}
    else if(row.type==='dm'){addDmMessage({from:row.sender,to:row.recipient,text:row.text,self:row.sender===myUsername,noFlash:true});}
    else{const li=addMessage(`<span class="msg-user${ec}" data-username="${escHtml(row.sender)}" style="color:${row.color}">${escHtml(row.sender)}:</span> <span class="msg-text">${escHtml(row.text)}</span>`,row.sender===myUsername?'msg-own':'',ts,row.id);if(row.reactions&&Object.keys(row.reactions).length)updateReactions(li,row.reactions,null);}
  });
  addMessage(`<span class="msg-system">-- live --</span>`);
  document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
}

// ── SOCKET EVENTS ──────────────────────────────────────────────
socket.on('rooms list',rooms=>renderRooms(rooms));
socket.on('room changed',room=>{currentRoom=room;pendingRoom=null;unreadCounts[room]=0;updateRoomBadge(room);document.getElementById('messages').innerHTML='';if(document.getElementById('keypad-modal').classList.contains('open'))closeKeypad();document.querySelectorAll('.room-btn').forEach(b=>b.classList.toggle('active',b.dataset.room===room));});
socket.on('history',history=>{document.getElementById('messages').innerHTML='';renderHistory(history);});
socket.on('room requires code',room=>{pendingRoom=room;openKeypad(room);});
socket.on('keypad error',msg=>{document.getElementById('keypad-error').textContent=msg||'Wrong code.';keypadCode='';renderKeypadDots();});
socket.on('confirm changepass',({room,newCode})=>openChangepassConfirm(room,newCode));
socket.on('room code changed',({room,newCode})=>{ownerRoomCodes[room]=String(newCode);addMessage(`<span class="msg-system">Room code changed to: ${newCode}</span>`);});
socket.on('room created',({room,code})=>{ownerRoomCodes[room]=String(code);openRoomCreated(room,code);});
socket.on('chat message',({id,user,color,text,type,timestamp})=>{
  const isOwn=user===myUsername;const ci=SHOP_COLORS[color];const ec=ci?` user-${ci.effect}`:'';
  if(type==='action')addMessage(`<span class="msg-action">*** <span class="msg-user${ec}" data-username="${escHtml(user)}" style="color:${color}">${escHtml(user)}</span> ${escHtml(text)} ***</span>`,'',timestamp);
  else addMessage(`<span class="msg-user${ec}" data-username="${escHtml(user)}" style="color:${color}">${escHtml(user)}:</span> <span class="msg-text">${escHtml(text)}</span>`,isOwn?'msg-own':'',timestamp||Date.now(),id);
  if(!isOwn)soundMessage();
});
socket.on('room message',({room,user})=>{try{if(!myUsername||room===currentRoom)return;if(user&&user.toLowerCase()===myUsername.toLowerCase())return;unreadCounts[room]=(unreadCounts[room]||0)+1;updateRoomBadge(room);}catch(e){}});
socket.on('system message',msg=>{
  const isClaim=msg.includes('/claim')||msg.includes('claimed the reward')||msg.includes('Nobody claimed');
  if(isClaim){addMessage(`<span class="msg-claim-event">${escHtml(msg)}</span>`);if(msg.includes('/claim'))soundClaim();else if(msg.includes('claimed the reward')&&msg.includes(myUsername))soundWin();}
  else{addMessage(`<span class="msg-system">*** ${escHtml(msg)} ***</span>`);if(/has joined/.test(msg))soundJoin();else if(/has left/.test(msg))soundLeave();}
});
socket.on('announcement',({from,message})=>{
  document.getElementById('announcement-content').textContent=(from&&from.toLowerCase()==='mce'?'Admin: ':'')+message;
  winShow('announcement-modal');soundClaim();
});
socket.on('dm',data=>addDmMessage(data));
socket.on('coins update',({coins})=>{myCoins=coins;updateCoinDisplay();});
socket.on('reaction update',({messageId,reactions})=>{const li=document.querySelector(`[data-msg-id="${messageId}"]`);if(!li)return;updateReactions(li,reactions,li.dataset.myReaction||null);});
socket.on('link preview',({url,title,image,description})=>{
  const messages=document.getElementById('messages');const rows=messages.querySelectorAll('.msg-row');let target=null;
  for(let i=rows.length-1;i>=0;i--){if(rows[i].textContent.includes(url.slice(8,40))){target=rows[i];break;}}
  const prev=document.createElement('div');prev.className='link-preview';
  let h='';if(image)h+=`<img src="${image}" alt="" onerror="this.style.display='none'">`;if(title)h+=`<div class="lp-title">${escHtml(title)}</div>`;if(description)h+=`<div class="lp-desc">${escHtml(description)}</div>`;
  prev.innerHTML=h;
  const atBottom=messages.scrollHeight-messages.scrollTop-messages.clientHeight<40;
  if(target)target.appendChild(prev);else{const li=document.createElement('li');li.style.listStyle='none';li.appendChild(prev);messages.appendChild(li);}
  if(atBottom)messages.scrollTop=messages.scrollHeight;
});
socket.on('poll update',poll=>renderPoll(poll));
socket.on('poll concluded',({pollId})=>{if(polls[pollId]){polls[pollId].concluded=true;const el=document.getElementById('poll-'+pollId);if(el)el.innerHTML=buildPollHtml(polls[pollId]);soundPollEnd();}});
socket.on('user list',list=>{
  document.getElementById('user-count-text').textContent=list.length;
  const panel=document.getElementById('users-panel');panel.innerHTML='';
  list.forEach(({username,color,joinedAt,idle})=>{
    const entry=document.createElement('span');entry.className='user-entry';entry.dataset.joinedAt=joinedAt;
    const ci=SHOP_COLORS[color];const ec=ci?` user-${ci.effect}`:'';
    entry.innerHTML=`<span class="uname${ec}" style="color:${color}" data-username="${escHtml(username)}">${escHtml(username)}</span>${idle?'<span class="uidle">||</span>':''}<span class="utime">${formatDuration(Date.now()-joinedAt)}</span>`;
    entry.querySelector('.uname').onclick=()=>{sfxClick();openProfile(username);};
    panel.appendChild(entry);
    if(username===myUsername){myColor=color;setLoggedInAs(username,color);}
  });
});
socket.on('typing',({text})=>{const bar=document.getElementById('typing-bar');bar.innerHTML=text?escHtml(text)+' <span class="dots"><span></span><span></span><span></span></span>':'';});
socket.on('kicked',reason=>{addMessage(`<span class="msg-kicked">You were kicked: ${escHtml(reason||'Signed in elsewhere.')}</span>`);document.getElementById('input').disabled=true;document.getElementById('send-btn').disabled=true;socket.disconnect();});

// ── DAILY ──────────────────────────────────────────────────────
function showDailyModal(){winShow('daily-modal');}
function closeDailyModal(){document.getElementById('daily-modal').classList.remove('open');}
async function claimDaily(){
  try{const res=await fetch('/daily',{method:'POST',credentials:'include'});const data=await res.json();if(!res.ok){closeDailyModal();return;}myCoins=data.coins;updateCoinDisplay();soundCoin();soundWin();closeDailyModal();addMessage(`<span class="msg-system">Daily reward claimed! +${fmtNum(data.reward)} coins. Balance: ${fmtNum(data.coins)}</span>`);}catch{closeDailyModal();}
}

// ── PROFILE ────────────────────────────────────────────────────
async function openProfile(username){
  document.getElementById('profile-modal-title').textContent=username+"'s Profile";
  document.getElementById('profile-modal-body').innerHTML='<div style="text-align:center;padding:20px;color:var(--text-system);">Loading...</div>';
  winShow('profile-modal');
  try{
    const res=await fetch(`/profile/${encodeURIComponent(username)}`,{credentials:'include'});
    const d=await res.json();if(!res.ok){document.getElementById('profile-modal-body').textContent=d.error;return;}
    const ci=SHOP_COLORS[d.color];const ec=ci?` user-${ci.effect}`:'';
    const badgeHtml=d.activeBadge?`${si(BADGE_SPRITES[d.activeBadge.id]||'placeholder.png',18,18,d.activeBadge.name)} ${escHtml(d.activeBadge.name)}`:`<span style="color:var(--text-system)">No badge</span>`;
    const earnedHtml=d.earnedBadges.length?d.earnedBadges.map(b=>`<span title="${escHtml(b.description)}" style="cursor:help">${si(BADGE_SPRITES[b.id]||'placeholder.png',24,24,b.name)}</span>`).join(' '):`<span style="color:var(--text-system);font-size:14px">No badges yet</span>`;
    document.getElementById('profile-modal-body').innerHTML=`
      <div class="profile-header"><img class="profile-avatar-img sprite" src="/sprites/profileAvatar.png" alt="Avatar" onerror="this.onerror=null;this.src='/sprites/placeholder.png'"><div><div class="profile-name${ec}" style="color:${d.color||'var(--text-main)'}">${escHtml(d.username)}</div><div class="profile-badge-display">${badgeHtml}</div></div></div>
      <div class="profile-stats">
        <div class="stat-row"><span class="stat-label">Joined</span><span class="stat-value">${formatDate(d.createdAt)}</span></div>
        <div class="stat-row"><span class="stat-label">Coins</span><span class="stat-value" style="color:#ffd700;text-shadow:1px 1px 0 #7a6000,0 1px 3px rgba(0,0,0,0.4)">${si('coinIcon.png',14,14,'coin')} ${fmtNum(d.coins)}</span></div>
        <div class="stat-row"><span class="stat-label">Messages sent</span><span class="stat-value">${d.messagesSent}</span></div>
        <div class="stat-row"><span class="stat-label">Time online</span><span class="stat-value">${formatSeconds(d.timeOnlineSeconds)}</span></div>
      </div>
      <div style="font-size:15px;margin-bottom:6px;">Badges earned:</div>
      <div style="padding:4px 0;display:flex;flex-wrap:wrap;gap:6px;align-items:center;">${earnedHtml}</div>`;
  }catch{document.getElementById('profile-modal-body').textContent='Error loading profile.';}
}
function closeProfile(){document.getElementById('profile-modal').classList.remove('open');}
// Mobile: click backdrop to close
document.getElementById('profile-modal').addEventListener('click',e=>{if(e.target===document.getElementById('profile-modal')&&!IS_DESKTOP())closeProfile();});

// ── SETTINGS ───────────────────────────────────────────────────
function switchSettingsTab(tab){const tabs=['appearance','badges','stats','account','help'];document.querySelectorAll('.stab').forEach((t,i)=>t.classList.toggle('active',tabs[i]===tab));document.querySelectorAll('.stab-panel').forEach(p=>p.classList.remove('active'));document.getElementById('stab-'+tab).classList.add('active');if(tab==='stats')loadStats();if(tab==='badges')loadBadges();}
async function openSettings(){winShow('settings-overlay');document.getElementById('settings-status').textContent='';selectedSettingsColor=myColor;selectedSettingsTheme=selectedTheme;await loadShopItems();renderSettingsThemes();renderSettingsColors();}
function closeSettings(){document.getElementById('settings-overlay').classList.remove('open');}
document.getElementById('settings-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('settings-overlay')&&!IS_DESKTOP())closeSettings();});

function renderSettingsThemes(){
  const owned=shopItems.filter(i=>i.type==='theme'&&i.owned);
  const wrap=document.getElementById('settings-theme-options');wrap.innerHTML='';
  if(!owned.length){wrap.innerHTML='<span style="font-size:14px;color:var(--text-system)">No themes owned. Visit Shop!</span>';return;}
  owned.forEach(item=>{const btn=document.createElement('button');btn.className=`theme-btn theme-opt-${item.value}${item.value===selectedSettingsTheme?' selected':''}`;btn.textContent=item.name;btn.onclick=()=>{sfxClick();selectedSettingsTheme=item.value;wrap.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');applyTheme(item.value);};wrap.appendChild(btn);});
}
function renderSettingsColors(){
  const owned=shopItems.filter(i=>i.type==='color'&&i.owned);
  const wrap=document.getElementById('settings-color-swatches');wrap.innerHTML='';
  owned.forEach(item=>{
    const div=document.createElement('div');div.className='color-swatch'+(item.value===selectedSettingsColor?' selected':'');
    const prev=document.createElement('div');prev.className='color-preview';prev.style.background=item.value;
    const name=document.createElement('div');name.className='color-name';name.textContent=item.name;name.style.color=item.value;name.style.textShadow='0 1px 3px rgba(0,0,0,0.6)';
    const check=document.createElement('div');check.className='color-checkmark';check.textContent=item.value===selectedSettingsColor?'✓':'';
    div.appendChild(prev);div.appendChild(name);div.appendChild(check);
    div.onclick=()=>{sfxClick();selectedSettingsColor=item.value;wrap.querySelectorAll('.color-swatch').forEach(s=>{s.classList.remove('selected');s.querySelector('.color-checkmark').textContent='';});div.classList.add('selected');div.querySelector('.color-checkmark').textContent='✓';};
    wrap.appendChild(div);
  });
}
async function saveSettings(){
  const st=document.getElementById('settings-status');st.textContent='Saving...';st.style.color='inherit';
  try{const res=await fetch('/settings',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({color:selectedSettingsColor,theme:selectedSettingsTheme})});const data=await res.json();if(!res.ok){st.textContent=data.error;st.style.color='#cc0000';return;}myColor=selectedSettingsColor;setLoggedInAs(myUsername,myColor);socket.emit('color update',myColor);st.textContent='Saved!';st.style.color='#007700';setTimeout(()=>st.textContent='',2000);}catch{st.textContent='Error saving.';st.style.color='#cc0000';}
}
async function changePassword(){
  const st=document.getElementById('pw-status'),op=document.getElementById('pw-old').value,np=document.getElementById('pw-new').value,np2=document.getElementById('pw-new2').value;
  st.textContent='Changing...';st.style.color='inherit';
  try{const res=await fetch('/settings/password',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({oldPassword:op,newPassword:np,newPassword2:np2})});const data=await res.json();if(!res.ok){st.textContent=data.error||'Error';st.style.color='#cc0000';return;}st.textContent='Password changed!';st.style.color='#007700';['pw-old','pw-new','pw-new2'].forEach(id=>document.getElementById(id).value='');setTimeout(()=>st.textContent='',2500);}catch{st.textContent='Server error';st.style.color='#cc0000';}
}

// ── BADGES ─────────────────────────────────────────────────────
async function loadBadges(){
  const grid=document.getElementById('badge-grid');grid.innerHTML='<div style="color:var(--text-system);font-size:14px">Loading...</div>';
  try{
    const res=await fetch('/stats',{credentials:'include'});const data=await res.json();if(!res.ok)return;
    const earnedIds=new Set(data.earnedBadges.map(b=>b.id));const activeId=data.activeBadge?.id||null;
    const allBadges=[{id:'lurker_no_more',name:'Lurker No More',description:'Send 10 messages'},{id:'regular',name:'Regular',description:'Send 50 messages'},{id:'chatterbox',name:'Chatterbox',description:'Send 100 messages'},{id:'motormouth',name:'Motormouth',description:'Send 500 messages'},{id:'legendary',name:'Legendary',description:'Send 1,000 messages'},{id:'feeling_lucky',name:'Feeling Lucky',description:'Place your first gamble'},{id:'high_roller',name:'High Roller',description:'Win over 1,000 coins at once'},{id:'loaded',name:'Loaded',description:'Earn 5,000 coins total'},{id:'whale',name:'Whale',description:'Earn 10,000 coins total'},{id:'tycoon',name:'Tycoon',description:'Earn 50,000 coins total'},{id:'mogul',name:'Mogul',description:'Earn 100,000 coins total'}];
    grid.innerHTML='';
    allBadges.forEach(b=>{const earned=earnedIds.has(b.id),isActive=b.id===activeId;const div=document.createElement('div');div.className='badge-item'+(earned?' earned':'  locked')+(isActive?' active-badge':'');const spriteFile=BADGE_SPRITES[b.id]||'placeholder.png';div.innerHTML=`<img class="badge-icon sprite" src="/sprites/${spriteFile}" alt="${escHtml(b.name)}" onerror="this.onerror=null;this.src='/sprites/placeholder.png'"><div class="badge-name">${escHtml(b.name)}</div><div class="badge-desc">${escHtml(b.description)}</div>${isActive?'<div class="badge-active-label">* Active showcase</div>':''}`;if(earned)div.onclick=()=>{sfxClick();setActiveBadge(b.id,data.activeBadge?.id);};grid.appendChild(div);});
  }catch{document.getElementById('badge-grid').innerHTML='<div style="color:#cc0000">Error loading badges.</div>';}
}
async function setActiveBadge(badgeId,currentActiveId){
  const newId=badgeId===currentActiveId?null:badgeId;
  try{const res=await fetch('/badge/set',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({badgeId:newId})});const data=await res.json();const st=document.getElementById('badge-status');if(!res.ok){st.textContent=data.error;st.style.color='#cc0000';return;}st.textContent=newId?'Badge set!':'Badge removed.';st.style.color='#007700';setTimeout(()=>st.textContent='',2000);loadBadges();}catch{}
}

// ── STATS ──────────────────────────────────────────────────────
async function loadStats(){
  const el=document.getElementById('stats-content');el.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-system);">Loading...</div>';
  try{const res=await fetch('/stats',{credentials:'include'});const d=await res.json();if(!res.ok){el.textContent=d.error;return;}el.innerHTML=`<div class="stat-row"><span class="stat-label">Username</span><span class="stat-value" style="color:${myColor}">${escHtml(d.username)}</span></div><div class="stat-row"><span class="stat-label">Member since</span><span class="stat-value">${formatDate(d.createdAt)}</span></div><div class="stat-row"><span class="stat-label">Current coins</span><span class="stat-value">${si('coinIcon.png',16,16,'coin')} ${fmtNum(d.coins)}</span></div><div class="stat-row"><span class="stat-label">Total earned</span><span class="stat-value">${si('coinIcon.png',16,16,'coin')} ${fmtNum(d.coinsEarned)}</span></div><div class="stat-row"><span class="stat-label">Total spent</span><span class="stat-value">${si('coinIcon.png',16,16,'coin')} ${fmtNum(d.coinsSpent)}</span></div><div class="stat-row"><span class="stat-label">Messages sent</span><span class="stat-value">${d.messagesSent}</span></div><div class="stat-row"><span class="stat-label">Time online</span><span class="stat-value">${formatSeconds(d.timeOnlineSeconds)}</span></div><div class="stat-row"><span class="stat-label">Badges earned</span><span class="stat-value">${si('trophyIcon.png',14,14,'trophy')} ${d.earnedBadges.length}</span></div><div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">Stats tracked from Feb 2026</div>`;}catch{el.textContent='Error loading stats.';}
}

// ── SHOP ───────────────────────────────────────────────────────
async function openShop(){winShow('shop-overlay');document.getElementById('shop-balance-amt').textContent=fmtNum(myCoins);document.getElementById('shop-status').textContent='';await loadShopItems();}
function closeShop(){document.getElementById('shop-overlay').classList.remove('open');}
function switchShopTab(tab){document.querySelectorAll('.shop-tab').forEach(t=>t.classList.toggle('active',t.textContent.toLowerCase().includes(tab==='themes'?'theme':'colour')));document.getElementById('shop-themes').classList.toggle('active',tab==='themes');document.getElementById('shop-colors').classList.toggle('active',tab==='colors');}
async function loadShopItems(){try{const res=await fetch('/shop',{credentials:'include'});shopItems=await res.json();renderShopThemes();renderShopColors();}catch{document.getElementById('shop-status').textContent='Error loading shop.';document.getElementById('shop-status').className='shop-status err';}}
function renderShopThemes(){document.getElementById('shop-themes').innerHTML=`<div class="shop-grid">${shopItems.filter(i=>i.type==='theme').map(shopItemHtml).join('')}</div>`;}
function renderShopColors(){document.getElementById('shop-colors').innerHTML=`<div class="shop-grid">${shopItems.filter(i=>i.type==='color').map(shopItemHtml).join('')}</div>`;}
function shopItemHtml(item){
  const priceHtml=item.price===0?`<span class="shop-item-price free">FREE</span>`:`<span class="shop-item-price">${si('coinIcon.png',13,13,'coin')} ${fmtNum(item.price)}</span>`;
  const badge=item.owned?`<span class="shop-item-owned-badge">OWNED</span>`:'';
  const btn=item.owned?`<button class="shop-buy-btn" disabled>Owned</button>`:`<button class="shop-buy-btn" onclick="sfxClick();buyItem('${item.id}')">Buy ${item.price===0?'(Free)':fmtNum(item.price)}</button>`;
  const nameStyle=item.type==='color'?`style="color:${item.value};text-shadow:0 1px 3px rgba(0,0,0,0.55)"` :'';
  return `<div class="shop-item${item.owned?' owned':''}" id="shop-item-${item.id}">${badge}<div class="shop-item-swatch" style="background:${item.preview}"></div><div class="shop-item-name" ${nameStyle}>${escHtml(item.name)}</div><div class="shop-item-desc">${escHtml(item.description||'')}</div>${priceHtml}${btn}</div>`;
}
async function buyItem(itemId){
  const st=document.getElementById('shop-status');st.textContent='Purchasing...';st.className='shop-status';
  try{const res=await fetch('/shop/buy',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({itemId})});const data=await res.json();if(!res.ok){st.textContent=data.error;st.className='shop-status err';return;}myCoins=data.coins;updateCoinDisplay();const idx=shopItems.findIndex(i=>i.id===itemId);if(idx>=0)shopItems[idx].owned=true;renderShopThemes();renderShopColors();st.textContent=`Purchased ${data.item.name}!`;soundCoin();}catch{st.textContent='Purchase failed.';st.className='shop-status err';}
}
document.getElementById('shop-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('shop-overlay')&&!IS_DESKTOP())closeShop();});

// ── GAMES ──────────────────────────────────────────────────────
function openGames(){updateCoinDisplay();winShow('games-overlay');loadLeaderboard();}
function closeGames(){document.getElementById('games-overlay').classList.remove('open');}
function openPatchNotes(){winShow('patchnotes-modal');}
function closePatchNotes(){document.getElementById('patchnotes-modal').classList.remove('open');}
function closeAnnouncement(){document.getElementById('announcement-modal').classList.remove('open');}
function switchGame(name){document.querySelectorAll('.game-panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.games-tab').forEach(t=>t.classList.remove('active'));document.getElementById('game-'+name).classList.add('active');document.querySelectorAll('.games-tab').forEach(t=>{if(t.textContent.toLowerCase().includes(name==='leaderboard'?'board':name))t.classList.add('active');});if(name==='leaderboard')loadLeaderboard();if(name==='roulette')initRouletteNumbers();}
function setBet(game,amount){document.getElementById(game+'-bet').value=amount;}

const SLOT_SYMBOLS={'🍒':'cherryIcon.png','🍋':'lemonIcon.png','🍊':'orangeIcon.png','⭐':'starIcon.png','💎':'diamondIcon.png','7️⃣':'sevenIcon.png'};
function reelSymbolHtml(sym){const f=SLOT_SYMBOLS[sym];return f?`<img class="sprite" src="/sprites/${f}" width="40" height="40" alt="${sym}" onerror="this.onerror=null;this.src='/sprites/placeholder.png'">`:sym;}

let slotsSpinning=false;
async function playSlots(){
  if(slotsSpinning)return;const bet=parseInt(document.getElementById('slots-bet').value,10);
  if(!bet||bet<1||bet>50000){document.getElementById('slots-result').innerHTML='<span class="result-lose">Bet must be 1-50000</span>';return;}
  slotsSpinning=true;const btn=document.getElementById('slots-spin-btn');btn.disabled=true;document.getElementById('slots-result').textContent='';
  [0,1,2].forEach(i=>document.getElementById('reel-'+i).classList.add('spinning'));
  await new Promise(r=>setTimeout(r,600));
  try{const res=await fetch('/game/slots',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({bet})});const data=await res.json();[0,1,2].forEach(i=>{const el=document.getElementById('reel-'+i);el.classList.remove('spinning');el.innerHTML=data.reels?reelSymbolHtml(data.reels[i]):'?';});if(!res.ok)document.getElementById('slots-result').innerHTML=`<span class="result-lose">${escHtml(data.error)}</span>`;else{myCoins=data.coins;updateCoinDisplay();if(data.winAmount>0){document.getElementById('slots-result').innerHTML=`<span class="result-win">WIN! ${data.multiplier}x = +${fmtNum(data.winAmount)} coins!</span>`;soundWin();}else{document.getElementById('slots-result').innerHTML=`<span class="result-lose">No match. Better luck next time!</span>`;soundLose();}}}catch{document.getElementById('slots-result').innerHTML='<span class="result-lose">Error. Try again.</span>';[0,1,2].forEach(i=>document.getElementById('reel-'+i).classList.remove('spinning'));}
  slotsSpinning=false;btn.disabled=false;
}

let diceRolling=false;
async function playDice(){
  if(diceRolling)return;const bet=parseInt(document.getElementById('dice-bet').value,10);
  if(!bet||bet<1||bet>50000){document.getElementById('dice-result').innerHTML='<span class="result-lose">Bet must be 1-50000</span>';return;}
  diceRolling=true;const btn=document.getElementById('dice-roll-btn');btn.disabled=true;
  document.getElementById('dice-player').innerHTML=`<img class="sprite" src="/sprites/diceIcon.png" width="36" height="36" alt="..." onerror="this.src='/sprites/placeholder.png'">`;
  document.getElementById('dice-house').innerHTML=`<img class="sprite" src="/sprites/diceIcon.png" width="36" height="36" alt="..." onerror="this.src='/sprites/placeholder.png'">`;
  document.getElementById('dice-result').textContent='';
  await new Promise(r=>setTimeout(r,500));
  try{const res=await fetch('/game/dice',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({bet})});const data=await res.json();if(!res.ok)document.getElementById('dice-result').innerHTML=`<span class="result-lose">${escHtml(data.error)}</span>`;else{document.getElementById('dice-player').textContent=data.playerRoll;document.getElementById('dice-house').textContent=data.houseRoll;myCoins=data.coins;updateCoinDisplay();if(data.result==='win'){document.getElementById('dice-result').innerHTML=`<span class="result-win">You win! +${fmtNum(data.winAmount)} coins!</span>`;soundWin();}else if(data.result==='tie')document.getElementById('dice-result').innerHTML=`<span class="result-tie">Tie! Bet returned.</span>`;else{document.getElementById('dice-result').innerHTML=`<span class="result-lose">House wins. Better luck next time!</span>`;soundLose();}}}catch{document.getElementById('dice-result').innerHTML='<span class="result-lose">Error. Try again.</span>';}
  diceRolling=false;btn.disabled=false;
}

let rouletteSpinning=false,selectedRouletteNumber=null;
async function playRoulette(betType){
  if(rouletteSpinning)return;const bet=parseInt(document.getElementById('roulette-bet').value,10);
  if(!bet||bet<1||bet>50000){document.getElementById('roulette-result').innerHTML='<span class="result-lose">Bet must be 1-50000</span>';return;}
  if(betType==='number'&&selectedRouletteNumber===null){document.getElementById('roulette-result').innerHTML='<span class="result-lose">Select a number first!</span>';return;}
  rouletteSpinning=true;
  const spinEl=document.getElementById('roulette-spin');spinEl.innerHTML=`<img class="sprite" src="/sprites/rouletteIcon.png" width="40" height="40" alt="spinning" style="animation:spin 2s linear 1" onerror="this.src='/sprites/placeholder.png'">`;
  document.getElementById('roulette-result').textContent='';
  await new Promise(r=>setTimeout(r,2000));
  try{const res=await fetch('/game/roulette',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({bet,betType:betType==='number'?selectedRouletteNumber:betType})});const data=await res.json();if(!res.ok)document.getElementById('roulette-result').innerHTML=`<span class="result-lose">${escHtml(data.error)}</span>`;else{spinEl.innerHTML=`<div style="font-size:28px;">${data.spinColor}</div><div>${data.spin}</div>`;myCoins=data.coins;updateCoinDisplay();if(data.result==='win'){const label=betType==='number'?`#${selectedRouletteNumber}`:betType;document.getElementById('roulette-result').innerHTML=`<span class="result-win">${label} hits! +${fmtNum(data.winAmount)} coins!</span>`;soundWin();}else{document.getElementById('roulette-result').innerHTML=`<span class="result-lose">House wins. Better luck next time!</span>`;soundLose();}}}catch{document.getElementById('roulette-result').innerHTML='<span class="result-lose">Error. Try again.</span>';}
  rouletteSpinning=false;
}
function initRouletteNumbers(){
  const reds=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];const grid=document.getElementById('roulette-number-grid');grid.innerHTML='';
  for(let i=1;i<=36;i++){const btn=document.createElement('button');btn.className='roulette-num-btn '+(reds.includes(i)?'red':'black');btn.innerHTML=`<div style="font-size:20px;">${reds.includes(i)?'R':'B'}</div><div>${i}</div>`;btn.onclick=()=>{sfxClick();selectedRouletteNumber=i;playRoulette('number');};grid.appendChild(btn);}
}
async function loadLeaderboard(){
  const container=document.getElementById('leaderboard-rows');container.innerHTML='<div style="text-align:center;color:var(--text-system);padding:20px;">Loading...</div>';
  try{const res=await fetch('/leaderboard',{credentials:'include'});const data=await res.json();if(!res.ok){container.innerHTML='<div style="color:#cc0000;text-align:center;padding:12px;">Error loading.</div>';return;}const medals=['goldMedal.png','silverMedal.png','bronzeMedal.png'];container.innerHTML=data.map((row,i)=>{const rank=i<3?`<img class="sprite" src="/sprites/${medals[i]}" width="20" height="20" alt="#${i+1}" onerror="this.onerror=null;this.src='/sprites/placeholder.png'">`:` #${i+1}`;return `<div class="lb-row"><span class="lb-rank">${rank}</span><span class="lb-name">${escHtml(row.username)}</span><span class="lb-coins" style="color:#ffd700;text-shadow:1px 1px 0 #7a6000,0 1px 3px rgba(0,0,0,0.4)">${si('coinIcon.png',16,16,'coin')} ${fmtNum(row.coins)}</span></div>`;}).join('');}catch{container.innerHTML='<div style="color:#cc0000;text-align:center;padding:12px;">Error loading.</div>';}
}

// ── TICKERS ────────────────────────────────────────────────────
setInterval(()=>{document.querySelectorAll('.user-entry').forEach(e=>{const s=e.querySelector('.utime');if(s)s.textContent=formatDuration(Date.now()-parseInt(e.dataset.joinedAt,10));});},1000);
setInterval(()=>{document.querySelectorAll('.poll-timer').forEach(el=>{const left=Math.max(0,Math.ceil((parseInt(el.dataset.ends,10)-Date.now())/1000));if(left===0){el.textContent='ending...';el.classList.add('urgent');}else{const m=Math.floor(left/60),s=left%60;el.textContent=m>0?`${m}m ${s}s left`:`${s}s left`;el.classList.toggle('urgent',left<=30);}});},1000);

let activityThrottle=0;
document.addEventListener('keydown',e=>{
  const now=Date.now();if(now-activityThrottle>30000){activityThrottle=now;socket.emit('activity');}
  if(e.key==='Escape'){closeSettings();closeGames();closeShop();closeProfile();closeKeypad();closeRoomCreated();closeChangepass();closeDailyModal();closeAnnouncement();closePatchNotes();}
});
document.getElementById('input').addEventListener('keydown',e=>{if(e.key==='Enter'){sfxClick();send();}});
['login-username','login-password'].forEach(id=>document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();}));
['reg-username','reg-password','reg-password2'].forEach(id=>document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')doRegister();}));

// ── AUTO-LOGIN ─────────────────────────────────────────────────
fetch('/me').then(async res=>{if(res.ok){const d=await res.json();enterChat(d.username,d.color,d.theme||'classic',d.coins||0,d.token,d.dailyAvailable);}});
</script>
</body>
</html>
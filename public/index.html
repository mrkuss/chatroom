<!DOCTYPE html>
<html lang="en">
<head>
  <title>chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* â”€â”€ THEMES â”€â”€ */
    :root {
      --bg-outer:#000080;--bg-window:#c0c0c0;--bg-titlebar:#000080;--bg-sidebar:#000060;
      --bg-sidebar-hdr:#000040;--bg-messages:#ffffff;--bg-input:#ffffff;--bg-bottom:#c0c0c0;
      --bg-users-panel:#c0c0c0;--border-main:white #808080 #808080 white;--border-inset:#808080;
      --text-main:#000000;--text-titlebar:#ffffff;--text-sidebar:#c0c0ff;--text-sidebar-hdr:#aad4ff;
      --text-system:#808080;--text-action:#555555;--room-active-bg:#0000c0;--room-hover-bg:#0000a0;
      --poll-bg:#f0f0ff;--poll-border:#000080;--poll-bar:#000080;--poll-question:#000080;
      --link-preview-bg:#f0f4ff;--link-preview-border:#c0c8e0;--link-preview-accent:#000080;
      --link-title-color:#000080;--typing-color:#808080;--btn-bg:#c0c0c0;
      --btn-border:white #808080 #808080 white;--auth-bg:#c0c0c0;--auth-tab-active-bg:#000080;--auth-input-bg:#ffffff;
    }
    body.theme-dark {
      --bg-outer:#0a0a0a;--bg-window:#1a1a1a;--bg-titlebar:#111111;--bg-sidebar:#0d0d0d;
      --bg-sidebar-hdr:#080808;--bg-messages:#141414;--bg-input:#1e1e1e;--bg-bottom:#1a1a1a;
      --bg-users-panel:#1a1a1a;--border-main:#444 #111 #111 #444;--border-inset:#333;
      --text-main:#d0d0d0;--text-titlebar:#e0e0e0;--text-sidebar:#9090c0;--text-sidebar-hdr:#7090b0;
      --text-system:#555;--text-action:#777;--room-active-bg:#252535;--room-hover-bg:#1e1e2e;
      --poll-bg:#1e1e2e;--poll-border:#4444aa;--poll-bar:#4444aa;--poll-question:#8888cc;
      --link-preview-bg:#1e1e28;--link-preview-border:#333355;--link-preview-accent:#4444aa;
      --link-title-color:#8888cc;--typing-color:#555;--btn-bg:#222;--btn-border:#444 #111 #111 #444;
      --auth-bg:#1a1a1a;--auth-tab-active-bg:#111;--auth-input-bg:#222;
    }
    body.theme-rose {
      --bg-outer:#3d1a2e;--bg-window:#f5e8ee;--bg-titlebar:#7a2d52;--bg-sidebar:#5c1f3d;
      --bg-sidebar-hdr:#3d1428;--bg-messages:#fff5f8;--bg-input:#fff0f5;--bg-bottom:#f5e8ee;
      --bg-users-panel:#f5e8ee;--border-main:#f0c0d8 #8a3060 #8a3060 #f0c0d8;--border-inset:#c090a8;
      --text-main:#3a1428;--text-titlebar:#ffe0ee;--text-sidebar:#f0b0cc;--text-sidebar-hdr:#f8d0e4;
      --text-system:#b08090;--text-action:#805060;--room-active-bg:#7a2d52;--room-hover-bg:#5c1f3d;
      --poll-bg:#fff0f8;--poll-border:#cc5588;--poll-bar:#cc5588;--poll-question:#993366;
      --link-preview-bg:#fff5f9;--link-preview-border:#e8b0c8;--link-preview-accent:#cc5588;
      --link-title-color:#993366;--typing-color:#c090a8;--btn-bg:#f5e8ee;--btn-border:#f0c0d8 #8a3060 #8a3060 #f0c0d8;
      --auth-bg:#f5e8ee;--auth-tab-active-bg:#7a2d52;--auth-input-bg:#fff5f8;
    }
    body.theme-amber {
      --bg-outer:#0d0800;--bg-window:#1a1000;--bg-titlebar:#2a1800;--bg-sidebar:#150d00;
      --bg-sidebar-hdr:#0d0800;--bg-messages:#120b00;--bg-input:#1a1000;--bg-bottom:#1a1000;
      --bg-users-panel:#1a1000;--border-main:#cc7700 #442200 #442200 #cc7700;--border-inset:#553300;
      --text-main:#ff9900;--text-titlebar:#ffbb44;--text-sidebar:#aa6600;--text-sidebar-hdr:#cc8800;
      --text-system:#664400;--text-action:#886600;--room-active-bg:#2a1800;--room-hover-bg:#221200;
      --poll-bg:#1a1000;--poll-border:#aa6600;--poll-bar:#cc8800;--poll-question:#ffaa00;
      --link-preview-bg:#150d00;--link-preview-border:#553300;--link-preview-accent:#cc7700;
      --link-title-color:#ffaa00;--typing-color:#664400;--btn-bg:#1a1000;--btn-border:#cc7700 #442200 #442200 #cc7700;
      --auth-bg:#1a1000;--auth-tab-active-bg:#2a1800;--auth-input-bg:#1a1000;
    }

    body { background-color:var(--bg-outer);font-family:'VT323',monospace;font-size:18px;color:var(--text-main);height:100vh;height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:background-color 0.2s; }

    /* â”€â”€ AUTH â”€â”€ */
    #auth-screen { background:var(--auth-bg);color:var(--text-main);border:3px solid;border-color:var(--border-main);width:90%;max-width:380px; }
    .auth-titlebar { background:var(--bg-titlebar);color:var(--text-titlebar);padding:6px 10px;font-size:18px;letter-spacing:1px;display:flex;justify-content:space-between;align-items:center; }
    .auth-version { font-size:13px;opacity:0.5; }
    .auth-disclaimer { background:#a8a8a8;color:#333;font-size:13px;padding:6px 10px;border-bottom:1px solid #808080;font-family:'VT323',monospace; }
    .auth-tabs { display:flex;border-bottom:2px solid var(--border-inset); }
    .auth-tab { flex:1;padding:8px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:18px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444; }
    .auth-tab:last-child { border-right:none; }
    .auth-tab.active { background:var(--auth-tab-active-bg);color:white; }
    .auth-body { padding:20px; }
    .auth-panel { display:none; }
    .auth-panel.active { display:block; }
    .auth-panel p { margin-bottom:10px;font-size:16px; }
    .auth-panel input { width:100%;padding:6px 8px;margin:6px 0;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);background:var(--auth-input-bg);color:var(--text-main); }
    .auth-panel button.primary { width:100%;margin-top:10px;padding:8px;font-family:'VT323',monospace;font-size:20px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px; }
    .auth-error { margin-top:10px;color:#cc0000;font-size:16px;min-height:20px; }

    /* â”€â”€ CHAT SCREEN â”€â”€ */
    #chat-screen { display:none;width:100%;height:100vh;height:100dvh;background:var(--bg-window);border:none;overflow:hidden;transition:background-color 0.2s; }
    @media (min-width:700px) { #chat-screen { width:760px;height:90vh;border:3px solid;border-color:var(--border-main); } }
    #chat-layout { display:flex;flex:1;height:calc(100% - 40px);overflow:hidden; }

    /* â”€â”€ SIDEBAR â”€â”€ */
    #rooms-sidebar { width:110px;background:var(--bg-sidebar);color:var(--text-sidebar);display:flex;flex-direction:column;border-right:2px solid var(--border-inset);flex-shrink:0; }
    #rooms-sidebar h3 { font-size:14px;padding:6px 8px;background:var(--bg-sidebar-hdr);border-bottom:1px solid var(--border-inset);letter-spacing:1px;color:var(--text-sidebar-hdr); }
    .room-btn { display:block;width:100%;text-align:left;padding:6px 8px;font-family:'VT323',monospace;font-size:16px;background:none;border:none;color:var(--text-sidebar);cursor:pointer;border-bottom:1px solid var(--bg-sidebar-hdr); }
    .room-btn:hover { background:var(--room-hover-bg); }
    .room-btn.active { background:var(--room-active-bg);color:white;font-weight:bold; }
    .room-btn .room-unread { float:right;background:#cc0000;color:white;font-size:12px;padding:0 4px;border-radius:2px;min-width:16px;text-align:center; }

    /* â”€â”€ MAIN AREA â”€â”€ */
    #main-area { flex:1;display:flex;flex-direction:column;overflow:hidden; }

    /* â”€â”€ TITLEBAR â”€â”€ */
    #titlebar { background:var(--bg-titlebar);color:var(--text-titlebar);padding:0 8px;display:flex;justify-content:space-between;align-items:center;font-size:18px;letter-spacing:1px;flex-shrink:0;height:40px;gap:8px; }
    #titlebar-title { font-size:18px;letter-spacing:2px;flex-shrink:0; }
    #titlebar-right { display:flex;align-items:center;gap:5px;margin-left:auto; }
    #logged-in-as { font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-right:2px; }
    #coin-display { font-size:14px;color:#ffd700;white-space:nowrap;margin-right:4px;text-shadow:0 0 4px rgba(255,215,0,0.5); }
    body.theme-dark #coin-display { color:#ffcc00; }
    body.theme-rose #coin-display { color:#ffaa44; }
    body.theme-amber #coin-display { color:#ffcc00; }

    /* â”€â”€ ICON BUTTONS â”€â”€ */
    .icon-btn { font-family:'VT323',monospace;font-size:16px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;padding:0;line-height:1;position:relative; }
    .icon-btn:active { border-color:var(--border-inset) white white var(--border-inset); }
    .icon-btn.on { background:#006600;color:white;border-color:#0a0 #030 #030 #0a0; }
    .icon-btn.danger { background:#800000;color:white;border-color:#ff8080 #400000 #400000 #ff8080; }
    .icon-btn.danger:active { border-color:#400000 #ff8080 #ff8080 #400000; }
    .icon-btn[title]:hover::after { content:attr(title);position:absolute;bottom:-26px;left:50%;transform:translateX(-50%);background:#000;color:#fff;font-size:12px;padding:2px 6px;white-space:nowrap;z-index:100;pointer-events:none;border:1px solid #555; }
    #user-count-btn { width:auto;padding:0 8px;font-size:14px; }

    /* â”€â”€ USERS PANEL â”€â”€ */
    #users-panel { display:none;flex-wrap:wrap;gap:4px 16px;padding:6px 8px;background:var(--bg-users-panel);border-bottom:2px inset var(--border-inset);font-size:15px;color:var(--text-main);flex-shrink:0; }
    #users-panel.visible { display:flex; }
    .user-entry .uname { font-weight:bold; }
    .user-entry .utime { color:var(--text-system);font-size:13px;margin-left:4px; }
    .user-entry .uidle { color:#aa6600;font-size:13px;margin-left:2px; }

    /* â”€â”€ MESSAGES â”€â”€ */
    #messages { flex:1;overflow-y:auto;padding:8px;background:var(--bg-messages);border:2px inset var(--border-inset);margin:8px 8px 0 8px;font-size:18px;line-height:1.6;-webkit-overflow-scrolling:touch;color:var(--text-main);transition:background-color 0.2s,color 0.2s; }
    .msg-action { color:var(--text-action);font-style:italic; }
    .msg-action .msg-user { color:var(--text-action); }
    .msg-system { color:var(--text-system);font-style:italic; }
    .msg-dm-row { background:#fff0f8;padding:0 4px;border-left:3px solid #cc0088; }
    .msg-dm-label { color:#cc0088;font-size:15px;margin-right:4px; }
    .msg-text { color:var(--text-main); }
    .msg-own .msg-user { opacity:0.8; }
    .msg-kicked { color:#cc0000;font-style:italic; }
    /* Claim event highlight */
    .msg-claim-event { color:#ffaa00;font-weight:bold;font-style:italic;animation:claimPulse 1s ease-in-out 3; }
    @keyframes claimPulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
    body.theme-dark .msg-dm-row { background:#1a0a14;border-left-color:#aa0066; }
    body.theme-rose .msg-dm-row { background:#ffe8f4;border-left-color:#cc5588; }
    body.theme-amber .msg-dm-row { background:#1a0f00;border-left-color:#cc7700; }
    body.theme-amber .msg-dm-label { color:#cc7700; }
    .msg-row { position:relative;padding:2px 0; }
    .msg-row:hover .msg-ts { display:inline; }
    .msg-ts { display:none;font-size:12px;color:var(--text-system);margin-left:8px; }

    /* â”€â”€ LINK PREVIEW â”€â”€ */
    .link-preview { display:inline-block;margin:4px 0 2px 12px;padding:6px 10px;background:var(--link-preview-bg);border:1px solid var(--link-preview-border);border-left:3px solid var(--link-preview-accent);font-size:15px;max-width:420px;color:var(--text-main); }
    .link-preview img { max-width:100%;max-height:80px;display:block;margin-bottom:4px; }
    .link-preview .lp-title { font-weight:bold;color:var(--link-title-color); }
    .link-preview .lp-desc { color:var(--text-system);font-size:13px; }

    /* â”€â”€ POLL â”€â”€ */
    .poll-card { background:var(--poll-bg);border:2px solid var(--poll-border);margin:6px 0;padding:8px 12px;font-size:16px;color:var(--text-main); }
    .poll-card.poll-concluded { opacity:0.75;border-color:var(--border-inset);background:var(--bg-messages); }
    .poll-question { font-weight:bold;color:var(--poll-question);margin-bottom:6px;font-size:17px; }
    .poll-option { display:flex;align-items:center;gap:8px;margin:3px 0;cursor:pointer;user-select:none; }
    .poll-option:hover:not(.concluded) .poll-opt-label { text-decoration:underline; }
    .poll-option.voted .poll-opt-label { color:var(--poll-question);font-weight:bold; }
    .poll-option.concluded { cursor:default;pointer-events:none; }
    .poll-bar-wrap { flex:1;height:14px;background:var(--border-inset);border:1px solid var(--border-inset);overflow:hidden; }
    .poll-bar { height:100%;background:var(--poll-bar);transition:width 0.3s; }
    .poll-card.poll-concluded .poll-bar { background:var(--border-inset); }
    .poll-option.winner .poll-bar { background:#007700; }
    .poll-option.winner .poll-opt-label { color:#007700;font-weight:bold; }
    .poll-pct { font-size:13px;color:var(--text-system);width:36px;text-align:right; }
    .poll-opt-label { min-width:80px; }
    .poll-meta { font-size:13px;color:var(--text-system);margin-top:4px; }
    .poll-timer { color:#cc6600;font-size:13px; }
    .poll-timer.urgent { color:#cc0000;font-weight:bold; }

    /* â”€â”€ TYPING â”€â”€ */
    #typing-bar { min-height:22px;padding:2px 10px;margin:0 8px;font-size:14px;color:var(--typing-color);font-style:italic;display:flex;align-items:center;gap:5px;flex-shrink:0; }
    .dots span { display:inline-block;width:4px;height:4px;background:var(--typing-color);border-radius:50%;animation:bounce 1.2s infinite; }
    .dots span:nth-child(2) { animation-delay:.2s; }
    .dots span:nth-child(3) { animation-delay:.4s; }
    @keyframes bounce { 0%,80%,100% { transform:translateY(0);opacity:.4; } 40% { transform:translateY(-4px);opacity:1; } }

    #bottom { display:flex;gap:6px;padding:8px;flex-shrink:0;background:var(--bg-bottom); }
    #input { flex:1;padding:8px;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);min-width:0;color:var(--text-main);background:var(--bg-input); }
    #send-btn { padding:8px 16px;font-family:'VT323',monospace;font-size:20px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);cursor:pointer;white-space:nowrap;flex-shrink:0; }
    #send-btn:active { border-color:var(--border-inset) white white var(--border-inset); }
    .dm-flash { animation:flash 0.4s 3; }
    @keyframes flash { 0%,100% { background:#fff0f8; } 50% { background:#ffccee; } }

    /* â”€â”€ OVERLAY BASE â”€â”€ */
    .modal-overlay { display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;align-items:center;justify-content:center; }
    .modal-overlay.open { display:flex; }
    .modal-box { background:var(--bg-window);border:3px solid;border-color:var(--border-main);width:90%;font-family:'VT323',monospace;color:var(--text-main); }
    .modal-titlebar { background:var(--bg-titlebar);color:var(--text-titlebar);padding:6px 10px;display:flex;justify-content:space-between;align-items:center;font-size:18px;letter-spacing:1px; }
    .modal-close { font-family:'VT323',monospace;font-size:16px;background:#800000;color:white;border:2px solid;border-color:#ff8080 #400000 #400000 #ff8080;width:22px;height:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;line-height:1; }
    .modal-body { padding:16px; }

    /* â”€â”€ SETTINGS â”€â”€ */
    #settings-modal { max-width:360px; }
    .settings-section { margin-bottom:16px; }
    .settings-label { font-size:16px;margin-bottom:6px;display:block;color:var(--text-main);letter-spacing:1px; }
    .settings-note { font-size:13px;color:var(--text-system);margin-bottom:8px; }
    /* Owned theme/color buttons shown in settings */
    .theme-options { display:grid;grid-template-columns:1fr 1fr;gap:6px; }
    .theme-btn { font-family:'VT323',monospace;font-size:16px;padding:8px 6px;border:2px solid;cursor:pointer;letter-spacing:1px;transition:opacity 0.1s;text-align:center; }
    .theme-btn.theme-opt-classic { background:#000080;color:white;border-color:#6060c0 #000040 #000040 #6060c0; }
    .theme-btn.theme-opt-dark { background:#1a1a1a;color:#d0d0d0;border-color:#444 #111 #111 #444; }
    .theme-btn.theme-opt-rose { background:#7a2d52;color:#ffe0ee;border-color:#f0a0c0 #3d1428 #3d1428 #f0a0c0; }
    .theme-btn.theme-opt-amber { background:#2a1800;color:#ff9900;border-color:#cc7700 #442200 #442200 #cc7700; }
    .theme-btn.selected { outline:2px solid white;outline-offset:1px; }
    .theme-btn:active { opacity:0.7; }
    #settings-color-swatches { display:flex;flex-wrap:wrap;gap:5px; }
    .color-swatch { width:24px;height:24px;border:2px solid transparent;cursor:pointer;border-radius:2px; }
    .color-swatch.selected { border-color:black;outline:1px solid white; }
    .settings-save-row { display:flex;gap:8px;margin-top:4px; }
    .settings-btn { flex:1;padding:8px;font-family:'VT323',monospace;font-size:18px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px; }
    .settings-status { font-size:14px;color:#007700;min-height:18px;margin-top:6px;text-align:center; }

    /* â”€â”€ DAILY REWARD â”€â”€ */
    #daily-modal .modal-box { max-width:320px;text-align:center; }
    #daily-modal .modal-body { padding:24px 16px; }
    .daily-icon { font-size:48px;display:block;margin-bottom:8px; }
    .daily-title { font-size:24px;color:var(--poll-question);margin-bottom:8px; }
    .daily-amount { font-size:32px;color:#ffd700;margin:8px 0;text-shadow:0 0 8px rgba(255,215,0,0.6); }
    .daily-claim-btn { width:100%;padding:10px;font-family:'VT323',monospace;font-size:22px;background:#007700;color:white;border:2px solid;border-color:#0a0 #030 #030 #0a0;cursor:pointer;margin-top:12px;letter-spacing:1px; }
    .daily-claim-btn:active { border-color:#030 #0a0 #0a0 #030; }

    /* â”€â”€ SHOP MODAL â”€â”€ */
    #shop-modal { max-width:520px; }
    .shop-tabs { display:flex;border-bottom:2px solid var(--border-inset); }
    .shop-tab { flex:1;padding:7px 4px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:16px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;text-align:center; }
    .shop-tab:last-child { border-right:none; }
    .shop-tab.active { background:var(--bg-titlebar);color:white; }
    .shop-panel { display:none; }
    .shop-panel.active { display:block; }
    .shop-balance { font-size:16px;color:#ffd700;padding:10px 0 6px;text-align:center; }
    body.theme-amber .shop-balance { color:#ffcc00; }
    .shop-grid { display:grid;grid-template-columns:1fr 1fr;gap:8px;padding-bottom:8px; }
    .shop-item { border:2px solid var(--border-inset);padding:8px;background:var(--bg-messages);position:relative;font-size:14px; }
    .shop-item.owned { border-color:#007700; }
    .shop-item-swatch { width:100%;height:28px;margin-bottom:6px;border:1px solid var(--border-inset); }
    .shop-item-name { font-size:16px;font-weight:bold;color:var(--text-main); }
    .shop-item-desc { font-size:12px;color:var(--text-system);margin:3px 0 6px; }
    .shop-item-price { font-size:14px;color:#ffd700; }
    body.theme-amber .shop-item-price { color:#ffaa00; }
    .shop-item-price.free { color:#007700; }
    .shop-item-owned-badge { position:absolute;top:4px;right:4px;font-size:11px;background:#007700;color:white;padding:1px 5px; }
    .shop-buy-btn { display:block;width:100%;margin-top:6px;padding:5px;font-family:'VT323',monospace;font-size:15px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer; }
    .shop-buy-btn:disabled { opacity:0.4;cursor:not-allowed; }
    .shop-status { font-size:14px;min-height:18px;margin-top:8px;text-align:center;color:#007700; }
    .shop-status.err { color:#cc0000; }

    /* â”€â”€ GAMES MODAL â”€â”€ */
    #games-modal { max-width:500px; }
    .games-tabs { display:flex;border-bottom:2px solid var(--border-inset);flex-wrap:wrap; }
    .games-tab { flex:1;min-width:80px;padding:6px 4px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:16px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;text-align:center; }
    .games-tab:last-child { border-right:none; }
    .games-tab.active { background:var(--bg-titlebar);color:white; }
    .game-panel { display:none;padding:16px 0 0 0; }
    .game-panel.active { display:block; }
    .game-balance { font-size:16px;color:#ffd700;margin-bottom:12px;text-align:center; }
    body.theme-amber .game-balance { color:#ffcc00; }
    .bet-row { display:flex;align-items:center;gap:8px;margin-bottom:12px; }
    .bet-row label { font-size:16px;flex-shrink:0; }
    .bet-input { flex:1;padding:4px 8px;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);background:var(--bg-input);color:var(--text-main);min-width:0; }
    .bet-presets { display:flex;gap:4px; }
    .bet-preset { font-family:'VT323',monospace;font-size:14px;padding:2px 8px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);cursor:pointer; }
    .game-btn { width:100%;padding:10px;font-family:'VT323',monospace;font-size:20px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px;margin-top:4px; }
    .game-btn:disabled { opacity:0.5;cursor:not-allowed; }
    .game-result { margin-top:12px;padding:10px;background:var(--bg-messages);border:2px inset var(--border-inset);font-size:16px;min-height:50px;text-align:center;color:var(--text-main); }
    .result-win { color:#007700;font-size:20px; }
    .result-lose { color:#cc0000;font-size:20px; }
    .result-tie { color:#cc6600;font-size:20px; }

    /* SLOTS */
    .slots-reels { display:flex;gap:8px;justify-content:center;margin:12px 0;font-size:40px; }
    .slot-reel { width:60px;height:60px;background:var(--bg-messages);border:3px inset var(--border-inset);display:flex;align-items:center;justify-content:center;transition:transform 0.1s; }
    .slot-reel.spinning { animation:spinReel 0.15s infinite; }
    @keyframes spinReel { 0% { transform:translateY(-4px); } 50% { transform:translateY(4px); } 100% { transform:translateY(-4px); } }

    /* DICE */
    .dice-display { display:flex;gap:16px;justify-content:center;align-items:center;margin:12px 0;font-size:14px;text-align:center; }
    .dice-side label { display:block;margin-bottom:4px;color:var(--text-system); }
    .dice-value { font-size:48px;min-width:60px;height:60px;background:var(--bg-messages);border:3px inset var(--border-inset);display:flex;align-items:center;justify-content:center; }
    .dice-vs { font-size:20px;color:var(--text-system); }

    /* LEADERBOARD */
    #leaderboard-panel { padding:12px 0 0 0; }
    .lb-row { display:flex;justify-content:space-between;padding:4px 8px;border-bottom:1px solid var(--border-inset);font-size:16px; }
    .lb-row:nth-child(odd) { background:var(--poll-bg); }
    .lb-rank { color:var(--text-system);width:30px; }
    .lb-name { flex:1;margin:0 8px; }
    .lb-coins { color:#ffd700; }
    body.theme-amber .lb-coins { color:#ffcc00; }
    .lb-header { display:flex;justify-content:space-between;padding:4px 8px;font-size:14px;color:var(--text-system);border-bottom:2px solid var(--border-inset);margin-bottom:4px; }
  </style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth-screen">
  <div class="auth-titlebar">
    <span>chatroom</span>
    <span class="auth-version">v2.0</span>
  </div>
  <div class="auth-disclaimer">a small project by mce. since all social platforms are selling your data, pushing micro-transactions in your face and asking for a pic of your face</div>
  <div class="auth-tabs">
    <button class="auth-tab active" onclick="switchTab('login')">Login</button>
    <button class="auth-tab" onclick="switchTab('register')">Register</button>
  </div>
  <div class="auth-body">
    <div id="login-panel" class="auth-panel active">
      <p>Sign in to your account:</p>
      <input id="login-username" type="text" placeholder="Username..." maxlength="20" autocomplete="username" />
      <input id="login-password" type="password" placeholder="Password..." autocomplete="current-password" />
      <button class="primary" onclick="doLogin()">Login</button>
      <div class="auth-error" id="login-error"></div>
    </div>
    <div id="register-panel" class="auth-panel">
      <p>Create a new account:</p>
      <input id="reg-username" type="text" placeholder="Username (3-20 chars)..." maxlength="20" autocomplete="username" />
      <input id="reg-password" type="password" placeholder="Password (min 6 chars)..." autocomplete="new-password" />
      <input id="reg-password2" type="password" placeholder="Confirm password..." autocomplete="new-password" />
      <button class="primary" onclick="doRegister()">Create Account</button>
      <div class="auth-error" id="register-error"></div>
    </div>
  </div>
</div>

<!-- Chat Screen -->
<div id="chat-screen">
  <div id="titlebar">
    <span id="titlebar-title">chatroom</span>
    <div id="titlebar-right">
      <span id="logged-in-as"></span>
      <span id="coin-display">ğŸª™ 0</span>
      <button id="user-count-btn" class="icon-btn" onclick="toggleUsers()" title="Online users">ğŸ‘¤ 0</button>
      <button id="sound-btn" class="icon-btn on" onclick="toggleSound()" title="Toggle SFX">ğŸ”Š</button>
      <button class="icon-btn" onclick="openShop()" title="Shop">ğŸ›’</button>
      <button class="icon-btn" onclick="openGames()" title="Games">ğŸ®</button>
      <button class="icon-btn" onclick="openSettings()" title="Settings">âš™</button>
      <button class="icon-btn danger" onclick="doLogout()" title="Exit">âœ•</button>
    </div>
  </div>
  <div id="chat-layout">
    <div id="rooms-sidebar">
      <h3>ROOMS</h3>
      <div id="rooms-list"></div>
    </div>
    <div id="main-area">
      <div id="users-panel"></div>
      <ul id="messages"></ul>
      <div id="typing-bar"></div>
      <div id="bottom">
        <input id="input" placeholder="Type a message, /me, /msg, /poll, /duel, /give, or 'claim'..." autocomplete="off" />
        <button id="send-btn" onclick="send()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Daily Reward Modal -->
<div id="daily-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:320px;text-align:center;">
    <div class="modal-titlebar"><span>Daily Reward</span></div>
    <div class="modal-body">
      <span class="daily-icon">ğŸª™</span>
      <div class="daily-title">Daily Bonus Available!</div>
      <div style="font-size:15px;color:var(--text-system);margin-bottom:4px;">Claim your free coins for today</div>
      <div class="daily-amount">+50 coins</div>
      <button class="daily-claim-btn" onclick="claimDaily()">Claim Reward</button>
    </div>
  </div>
</div>

<!-- Shop Modal -->
<div id="shop-overlay" class="modal-overlay">
  <div class="modal-box" id="shop-modal">
    <div class="modal-titlebar">
      <span>ğŸ›’ Shop</span>
      <button class="modal-close" onclick="closeShop()">âœ•</button>
    </div>
    <div style="padding:0 16px;">
      <div class="shop-balance" id="shop-balance">Balance: ğŸª™ 0</div>
      <div class="shop-tabs">
        <button class="shop-tab active" onclick="switchShopTab('themes')">Themes</button>
        <button class="shop-tab" onclick="switchShopTab('colors')">Colours</button>
      </div>
    </div>
    <div style="padding:0 16px 16px;max-height:380px;overflow-y:auto;">
      <div id="shop-themes" class="shop-panel active"></div>
      <div id="shop-colors" class="shop-panel"></div>
    </div>
    <div style="padding:0 16px 12px;">
      <div class="shop-status" id="shop-status"></div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settings-overlay" class="modal-overlay">
  <div class="modal-box" id="settings-modal">
    <div class="modal-titlebar">
      <span>âš™ Settings</span>
      <button class="modal-close" onclick="closeSettings()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="settings-section">
        <span class="settings-label">Theme</span>
        <div class="settings-note">Only owned themes shown. Buy more in the ğŸ›’ Shop.</div>
        <div class="theme-options" id="settings-theme-options"></div>
      </div>
      <div class="settings-section">
        <span class="settings-label">Username Colour</span>
        <div class="settings-note">Only owned colours shown.</div>
        <div id="settings-color-swatches"></div>
      </div>
      <div class="settings-save-row">
        <button class="settings-btn" onclick="saveSettings()">Save</button>
      </div>
      <div class="settings-status" id="settings-status"></div>
    </div>
  </div>
</div>

<!-- Games Modal -->
<div id="games-overlay" class="modal-overlay">
  <div class="modal-box" id="games-modal">
    <div class="modal-titlebar">
      <span>ğŸ® Games</span>
      <button class="modal-close" onclick="closeGames()">âœ•</button>
    </div>
    <div style="padding:0 16px;">
      <div class="games-tabs">
        <button class="games-tab active" onclick="switchGame('slots')">ğŸ° Slots</button>
        <button class="games-tab" onclick="switchGame('dice')">ğŸ² Dice</button>
        <button class="games-tab" onclick="switchGame('leaderboard')">ğŸ† Board</button>
      </div>
    </div>

    <!-- SLOTS -->
    <div id="game-slots" class="game-panel active" style="padding:0 16px 16px;">
      <div class="game-balance" id="slots-balance">Balance: ğŸª™ 0</div>
      <div class="slots-reels">
        <div class="slot-reel" id="reel-0">ğŸ°</div>
        <div class="slot-reel" id="reel-1">ğŸ°</div>
        <div class="slot-reel" id="reel-2">ğŸ°</div>
      </div>
      <div class="bet-row">
        <label>Bet:</label>
        <input type="number" class="bet-input" id="slots-bet" value="10" min="1" max="500" />
        <div class="bet-presets">
          <button class="bet-preset" onclick="setBet('slots',10)">10</button>
          <button class="bet-preset" onclick="setBet('slots',50)">50</button>
          <button class="bet-preset" onclick="setBet('slots',100)">100</button>
        </div>
      </div>
      <button class="game-btn" id="slots-spin-btn" onclick="playSlots()">SPIN</button>
      <div class="game-result" id="slots-result"></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">
        ğŸ’Ã—3=2x Â· ğŸ‹Ã—3=3x Â· ğŸŠÃ—3=4x Â· â­Ã—3=6x Â· ğŸ’Ã—3=10x Â· 7ï¸âƒ£Ã—3=25x
      </div>
    </div>

    <!-- DICE -->
    <div id="game-dice" class="game-panel" style="padding:0 16px 16px;">
      <div class="game-balance" id="dice-balance">Balance: ğŸª™ 0</div>
      <div class="dice-display">
        <div class="dice-side">
          <label>You</label>
          <div class="dice-value" id="dice-player">?</div>
        </div>
        <div class="dice-vs">VS</div>
        <div class="dice-side">
          <label>House</label>
          <div class="dice-value" id="dice-house">?</div>
        </div>
      </div>
      <div class="bet-row">
        <label>Bet:</label>
        <input type="number" class="bet-input" id="dice-bet" value="10" min="1" max="500" />
        <div class="bet-presets">
          <button class="bet-preset" onclick="setBet('dice',10)">10</button>
          <button class="bet-preset" onclick="setBet('dice',50)">50</button>
          <button class="bet-preset" onclick="setBet('dice',100)">100</button>
        </div>
      </div>
      <button class="game-btn" id="dice-roll-btn" onclick="playDice()">ROLL DICE</button>
      <div class="game-result" id="dice-result"></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">Roll 2 dice vs the house. Higher total wins 1.9x Â· Tie returns bet</div>
    </div>

    <!-- LEADERBOARD -->
    <div id="game-leaderboard" class="game-panel" style="padding:0 16px 16px;">
      <div class="lb-header"><span>Rank</span><span>Player</span><span>Coins</span></div>
      <div id="leaderboard-rows"><div style="text-align:center;color:var(--text-system);padding:20px;">Loading...</div></div>
      <button class="game-btn" style="margin-top:12px;" onclick="loadLeaderboard()">â†» Refresh</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// â”€â”€ SOUNDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let soundEnabled = true;
const AudioContext = window.AudioContext || window.webkitAudioContext;
let actx = null;
function getActx() { if (!actx) actx = new AudioContext(); return actx; }
function playTone(freq, type, duration, vol = 0.15, delay = 0) {
  if (!soundEnabled) return;
  try {
    const ctx = getActx();
    const osc = ctx.createOscillator(); const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = type; osc.frequency.setValueAtTime(freq, ctx.currentTime + delay);
    gain.gain.setValueAtTime(vol, ctx.currentTime + delay);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + duration);
    osc.start(ctx.currentTime + delay); osc.stop(ctx.currentTime + delay + duration + 0.01);
  } catch {}
}
function soundMessage() { playTone(880, 'square', 0.06, 0.1); }
function soundJoin()    { playTone(523,'sine',0.15,0.12); playTone(659,'sine',0.15,0.12,0.12); playTone(784,'sine',0.2,0.14,0.24); }
function soundLeave()   { playTone(784,'sine',0.12,0.1); playTone(523,'sine',0.2,0.1,0.14); }
function soundDM()      { playTone(1046,'square',0.08,0.1); playTone(1318,'square',0.12,0.12,0.1); }
function soundPollEnd() { playTone(659,'sine',0.1,0.12); playTone(784,'sine',0.1,0.12,0.1); playTone(1046,'sine',0.3,0.15,0.2); }
function soundWin()     { playTone(523,'sine',0.1,0.15); playTone(659,'sine',0.1,0.15,0.1); playTone(784,'sine',0.1,0.15,0.2); playTone(1046,'sine',0.3,0.18,0.3); }
function soundLose()    { playTone(400,'sawtooth',0.1,0.12); playTone(300,'sawtooth',0.2,0.12,0.12); }
function soundCoin()    { playTone(1318,'sine',0.08,0.12); playTone(1568,'sine',0.12,0.14,0.08); }
function soundClaim()   { playTone(880,'sine',0.08,0.2); playTone(1046,'sine',0.08,0.2,0.1); playTone(1318,'sine',0.15,0.2,0.2); playTone(1568,'sine',0.3,0.25,0.35); }

function toggleSound() {
  soundEnabled = !soundEnabled;
  const btn = document.getElementById('sound-btn');
  btn.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
  btn.classList.toggle('on', soundEnabled);
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const socket = io({ autoConnect: false });
let myUsername = null, myColor = '#000080', myCoins = 0, selectedTheme = 'classic';
let currentRoom = 'general', usersVisible = false, isTyping = false, typingTimer;
const unreadCounts = {}, polls = {};

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function updateCoinDisplay() { document.getElementById('coin-display').textContent = `ğŸª™ ${myCoins}`; }

function formatDuration(ms) {
  const total = Math.floor(ms / 1000);
  const d = Math.floor(total / 86400), h = Math.floor((total % 86400) / 3600), m = Math.floor((total % 3600) / 60), s = total % 60;
  if (d > 0) return d + "D " + h + "HR " + m + "M";
  if (h > 0) return h + "HR " + m + "M";
  if (m > 0) return m + "M " + s + "S";
  return s + "S";
}
function formatTime(ts) { return new Date(ts).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }); }

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(theme) {
  document.body.className = document.body.className.replace(/theme-\w+/g, '').trim();
  if (theme !== 'classic') document.body.classList.add('theme-' + theme);
  selectedTheme = theme;
}

// â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t, i) => t.classList.toggle('active', (i === 0) === (tab === 'login')));
  document.getElementById('login-panel').classList.toggle('active', tab === 'login');
  document.getElementById('register-panel').classList.toggle('active', tab === 'register');
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.textContent = '';
  if (!username || !password) { errEl.textContent = 'Please fill in all fields.'; return; }
  const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
  const data = await res.json();
  if (!res.ok) { errEl.textContent = data.error; return; }
  enterChat(data.username, data.color || '#000080', data.theme || 'classic', data.coins || 0, data.token, data.dailyAvailable);
}

async function doRegister() {
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  const password2 = document.getElementById('reg-password2').value;
  const errEl = document.getElementById('register-error');
  errEl.textContent = '';
  if (!username || !password || !password2) { errEl.textContent = 'Please fill in all fields.'; return; }
  if (password !== password2) { errEl.textContent = 'Passwords do not match.'; return; }
  const res = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
  const data = await res.json();
  if (!res.ok) { errEl.textContent = data.error; return; }
  enterChat(data.username, data.color || '#000080', data.theme || 'classic', data.coins || 100, data.token, false);
}

async function doLogout() {
  await fetch('/logout', { method:'POST' });
  socket.disconnect();
  location.reload();
}

// â”€â”€ ENTER CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterChat(username, color, theme, coins, token, dailyAvailable) {
  myUsername = username; myColor = color || '#000080'; myCoins = coins || 0;
  applyTheme(theme || 'classic');
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('chat-screen').style.display = 'block';
  document.getElementById('logged-in-as').innerHTML = `<span style="color:${myColor};text-shadow:0 0 2px rgba(255,255,255,0.5)">${username}</span>`;
  updateCoinDisplay();
  document.getElementById('input').focus();
  socket.connect();
  socket.once('connect', () => { socket.emit('join', token); });
  if (dailyAvailable) setTimeout(() => showDailyModal(), 1500);
}

// â”€â”€ ROOMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRooms(rooms) {
  const list = document.getElementById('rooms-list'); list.innerHTML = '';
  rooms.forEach(room => {
    const btn = document.createElement('button');
    btn.className = 'room-btn' + (room === currentRoom ? ' active' : '');
    btn.dataset.room = room; btn.innerHTML = `#${room}`;
    if (unreadCounts[room]) btn.innerHTML += `<span class="room-unread">${unreadCounts[room]}</span>`;
    btn.onclick = () => switchRoom(room);
    list.appendChild(btn);
  });
}

function switchRoom(room) {
  if (room === currentRoom) return;
  document.getElementById('messages').innerHTML = ''; currentRoom = room;
  socket.emit('switch room', room); unreadCounts[room] = 0;
}

// â”€â”€ SEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function send() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if (!text) return;
  socket.emit('chat message', text); input.value = ''; stopTyping();
}

// â”€â”€ TYPING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('input').addEventListener('input', () => {
  socket.emit('activity');
  if (!isTyping) { isTyping = true; socket.emit('typing start'); }
  clearTimeout(typingTimer); typingTimer = setTimeout(stopTyping, 2000);
});
function stopTyping() { if (!isTyping) return; isTyping = false; clearTimeout(typingTimer); socket.emit('typing stop'); }
function toggleUsers() { usersVisible = !usersVisible; document.getElementById('users-panel').classList.toggle('visible', usersVisible); }

// â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMessage(html, extraClass = '', timestamp = null) {
  const messages = document.getElementById('messages');
  const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
  const li = document.createElement('li'); li.style.listStyle = 'none';
  li.className = 'msg-row' + (extraClass ? ' ' + extraClass : '');
  const ts = timestamp ? `<span class="msg-ts">${formatTime(timestamp)}</span>` : '';
  li.innerHTML = html + ts; messages.appendChild(li);
  if (atBottom) messages.scrollTop = messages.scrollHeight;
  return li;
}

function addDmMessage(data) {
  const messages = document.getElementById('messages');
  const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
  const li = document.createElement('li'); li.style.listStyle = 'none';
  li.className = 'msg-row msg-dm-row' + (!data.noFlash && !data.self ? ' dm-flash' : '');
  const label = data.self ? `<span class="msg-dm-label">â†’ DM to ${data.to}:</span>` : `<span class="msg-dm-label">DM from ${data.from}:</span>`;
  li.innerHTML = label + `<span class="msg-text">${data.text}</span>`;
  messages.appendChild(li);
  if (atBottom) messages.scrollTop = messages.scrollHeight;
  if (!data.noFlash && !data.self) soundDM();
}

// â”€â”€ POLLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPoll(poll) {
  polls[poll.id] = poll;
  const existing = document.getElementById(`poll-${poll.id}`);
  if (existing) { existing.innerHTML = buildPollHtml(poll); return; }
  const messages = document.getElementById('messages');
  const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
  const li = document.createElement('li'); li.style.listStyle = 'none';
  li.id = `poll-${poll.id}`; li.className = 'msg-row'; li.innerHTML = buildPollHtml(poll);
  messages.appendChild(li);
  if (atBottom) messages.scrollTop = messages.scrollHeight;
}

function buildPollHtml(poll) {
  const totalVotes = Object.keys(poll.votes || {}).length;
  const myVote = (poll.votes || {})[myUsername];
  const concluded = poll.concluded;
  let topCount = 0;
  if (concluded && totalVotes > 0) {
    const tally = {}; poll.options.forEach(o => tally[o] = 0);
    Object.values(poll.votes || {}).forEach(v => { if (tally[v] !== undefined) tally[v]++; });
    topCount = Math.max(...Object.values(tally));
  }
  const optionsHtml = poll.options.map(opt => {
    const count = Object.values(poll.votes || {}).filter(v => v === opt).length;
    const pct = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
    const isVoted = myVote === opt;
    const isWinner = concluded && totalVotes > 0 && count === topCount;
    const classes = ['poll-option', isVoted ? 'voted' : '', concluded ? 'concluded' : '', isWinner ? 'winner' : ''].filter(Boolean).join(' ');
    // Use data-poll and data-opt attributes so onclick isn't broken by string escaping
    return `<div class="${classes}" data-poll="${poll.id}" data-opt="${escHtml(opt)}">
      <span class="poll-opt-label">${isWinner ? 'ğŸ† ' : ''}${escHtml(opt)}</span>
      <div class="poll-bar-wrap"><div class="poll-bar" style="width:${pct}%"></div></div>
      <span class="poll-pct">${pct}%</span>
      <span style="font-size:13px;color:var(--text-system)">${count}</span>
    </div>`;
  }).join('');
  let timerHtml = '';
  if (!concluded && poll.endsAt) timerHtml = `<span class="poll-timer" data-ends="${new Date(poll.endsAt).getTime()}">...</span>`;
  else if (concluded) timerHtml = `<span style="color:var(--text-system)">concluded</span>`;
  return `<div class="poll-card${concluded ? ' poll-concluded' : ''}">
    <div class="poll-question">ğŸ“Š ${escHtml(poll.question)}</div>${optionsHtml}
    <div class="poll-meta">by ${escHtml(poll.creator)} Â· ${totalVotes} vote${totalVotes !== 1 ? 's' : ''} Â· ${timerHtml}</div>
  </div>`;
}

// Delegate poll clicks from the messages container (fixes double-fire from innerHTML re-use)
document.getElementById('messages').addEventListener('click', (e) => {
  const opt = e.target.closest('.poll-option');
  if (!opt || opt.classList.contains('concluded')) return;
  const pollId = parseInt(opt.dataset.poll, 10);
  const option = opt.dataset.opt;
  if (pollId && option) socket.emit('poll vote', { pollId, option });
});

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistory(history) {
  const messages = document.getElementById('messages'); messages.innerHTML = '';
  if (history.length === 0) return;
  addMessage(`<span class="msg-system">â”€â”€ message history â”€â”€</span>`);
  history.forEach(row => {
    const ts = new Date(row.created_at).getTime();
    if (row.type === 'system') {
      addMessage(`<span class="msg-system">*** ${row.text} ***</span>`, '', ts);
    } else if (row.type === 'action') {
      addMessage(`<span class="msg-action">*** <span class="msg-user" style="color:${row.color}">${row.sender}</span> ${row.text} ***</span>`, '', ts);
    } else if (row.type === 'dm') {
      addDmMessage({ from: row.sender, to: row.recipient, text: row.text, self: row.sender === myUsername, noFlash: true });
    } else {
      addMessage(`<span class="msg-user" style="color:${row.color}">${row.sender}:</span> <span class="msg-text">${row.text}</span>`, row.sender === myUsername ? 'msg-own' : '', ts);
    }
  });
  addMessage(`<span class="msg-system">â”€â”€ live â”€â”€</span>`);
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

// â”€â”€ SOCKET EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
socket.on('rooms list', rooms => renderRooms(rooms));
socket.on('room changed', room => { currentRoom = room; renderRooms([...document.querySelectorAll('.room-btn')].map(b => b.dataset.room)); });
socket.on('history', history => renderHistory(history));

socket.on('chat message', ({ user, color, text, type, timestamp }) => {
  const isOwn = user === myUsername;
  if (type === 'action') addMessage(`<span class="msg-action">*** <span class="msg-user" style="color:${color}">${user}</span> ${text} ***</span>`, '', timestamp);
  else addMessage(`<span class="msg-user" style="color:${color}">${user}:</span> <span class="msg-text">${text}</span>`, isOwn ? 'msg-own' : '', timestamp || Date.now());
  if (!isOwn) soundMessage();
});

socket.on('system message', msg => {
  // Detect claim event announcement for special styling
  const isClaim = msg.includes('TYPE "claim"') || msg.includes('claimed the reward');
  if (isClaim) {
    addMessage(`<span class="msg-claim-event">*** ${msg} ***</span>`);
    if (msg.includes('TYPE "claim"')) soundClaim();
    else if (msg.includes('claimed the reward') && msg.includes(myUsername)) soundWin();
  } else {
    addMessage(`<span class="msg-system">*** ${msg} ***</span>`);
    if (/has joined/.test(msg)) soundJoin();
    else if (/has left/.test(msg)) soundLeave();
  }
});

socket.on('dm', data => addDmMessage(data));
socket.on('coins update', ({ coins }) => { myCoins = coins; updateCoinDisplay(); updateGameBalances(); });

socket.on('link preview', ({ url, title, image, description }) => {
  const messages = document.getElementById('messages');
  const rows = messages.querySelectorAll('.msg-row');
  let target = null;
  for (let i = rows.length - 1; i >= 0; i--) { if (rows[i].textContent.includes(url.slice(8, 40))) { target = rows[i]; break; } }
  const previewEl = document.createElement('div'); previewEl.className = 'link-preview';
  let html = '';
  if (image) html += `<img src="${image}" alt="" onerror="this.style.display='none'">`;
  if (title) html += `<div class="lp-title">${title}</div>`;
  if (description) html += `<div class="lp-desc">${description}</div>`;
  previewEl.innerHTML = html;
  const atBottom = messages.scrollHeight - messages.scrollTop - messages.clientHeight < 40;
  if (target) target.appendChild(previewEl);
  else { const li = document.createElement('li'); li.style.listStyle = 'none'; li.appendChild(previewEl); messages.appendChild(li); }
  if (atBottom) messages.scrollTop = messages.scrollHeight;
});

socket.on('poll update', poll => renderPoll(poll));
socket.on('poll concluded', ({ pollId }) => {
  if (polls[pollId]) { polls[pollId].concluded = true; const el = document.getElementById(`poll-${pollId}`); if (el) el.innerHTML = buildPollHtml(polls[pollId]); soundPollEnd(); }
});

socket.on('user list', list => {
  document.getElementById('user-count-btn').textContent = `ğŸ‘¤ ${list.length}`;
  const panel = document.getElementById('users-panel'); panel.innerHTML = '';
  list.forEach(({ username, color, joinedAt, idle }) => {
    const entry = document.createElement('span'); entry.className = 'user-entry'; entry.dataset.joinedAt = joinedAt;
    entry.innerHTML = `<span class="uname" style="color:${color}">${username}</span>${idle ? '<span class="uidle">â¸</span>' : ''}<span class="utime">${formatDuration(Date.now() - joinedAt)}</span>`;
    panel.appendChild(entry);
  });
});

socket.on('typing', ({ text }) => {
  const bar = document.getElementById('typing-bar');
  bar.innerHTML = text ? text + ' <span class="dots"><span></span><span></span><span></span></span>' : '';
});

socket.on('kicked', reason => {
  addMessage(`<span class="msg-kicked">âš  ${reason || 'You were signed in from another device.'}</span>`);
  document.getElementById('input').disabled = true;
  document.getElementById('send-btn').disabled = true;
  socket.disconnect();
});

// â”€â”€ DAILY REWARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDailyModal() { document.getElementById('daily-modal').classList.add('open'); }
function closeDailyModal() { document.getElementById('daily-modal').classList.remove('open'); }

async function claimDaily() {
  try {
    const res = await fetch('/daily', { method:'POST', credentials:'include' });
    const data = await res.json();
    if (!res.ok) { closeDailyModal(); return; }
    myCoins = data.coins; updateCoinDisplay();
    soundCoin(); soundWin();
    closeDailyModal();
    addMessage(`<span class="msg-system">Daily reward claimed! +${data.reward} coins. Balance: ${data.coins} ğŸª™</span>`);
  } catch { closeDailyModal(); }
}

// â”€â”€ SHOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shopItems = [];
let selectedSettingsColor = '#000080', selectedSettingsTheme = 'classic';

async function openShop() {
  document.getElementById('shop-overlay').classList.add('open');
  document.getElementById('shop-balance').textContent = `Balance: ğŸª™ ${myCoins}`;
  document.getElementById('shop-status').textContent = '';
  await loadShopItems();
}
function closeShop() { document.getElementById('shop-overlay').classList.remove('open'); }

function switchShopTab(tab) {
  document.querySelectorAll('.shop-tab').forEach(t => t.classList.toggle('active', t.textContent.toLowerCase().includes(tab === 'themes' ? 'theme' : 'colour')));
  document.getElementById('shop-themes').classList.toggle('active', tab === 'themes');
  document.getElementById('shop-colors').classList.toggle('active', tab === 'colors');
}

async function loadShopItems() {
  try {
    const res = await fetch('/shop', { credentials:'include' });
    shopItems = await res.json();
    renderShopThemes();
    renderShopColors();
  } catch { document.getElementById('shop-status').textContent = 'Error loading shop.'; document.getElementById('shop-status').className = 'shop-status err'; }
}

function renderShopThemes() {
  const themes = shopItems.filter(i => i.type === 'theme');
  document.getElementById('shop-themes').innerHTML = `<div class="shop-grid">${themes.map(item => shopItemHtml(item)).join('')}</div>`;
}

function renderShopColors() {
  const colors = shopItems.filter(i => i.type === 'color');
  document.getElementById('shop-colors').innerHTML = `<div class="shop-grid">${colors.map(item => shopItemHtml(item)).join('')}</div>`;
}

function shopItemHtml(item) {
  const priceLabel = item.price === 0
    ? `<span class="shop-item-price free">FREE</span>`
    : `<span class="shop-item-price">ğŸª™ ${item.price}</span>`;
  const badge = item.owned ? `<span class="shop-item-owned-badge">âœ“ OWNED</span>` : '';
  const btn = item.owned
    ? `<button class="shop-buy-btn" disabled>Owned</button>`
    : `<button class="shop-buy-btn" onclick="buyItem('${item.id}')">Buy ${item.price === 0 ? '(Free)' : `ğŸª™ ${item.price}`}</button>`;
  return `<div class="shop-item${item.owned ? ' owned' : ''}" id="shop-item-${item.id}">
    ${badge}
    <div class="shop-item-swatch" style="background:${item.preview}"></div>
    <div class="shop-item-name">${escHtml(item.name)}</div>
    <div class="shop-item-desc">${escHtml(item.description || '')}</div>
    ${priceLabel}
    ${btn}
  </div>`;
}

async function buyItem(itemId) {
  const statusEl = document.getElementById('shop-status');
  statusEl.textContent = 'Purchasing...'; statusEl.className = 'shop-status';
  try {
    const res = await fetch('/shop/buy', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ itemId }) });
    const data = await res.json();
    if (!res.ok) { statusEl.textContent = data.error; statusEl.className = 'shop-status err'; return; }
    myCoins = data.coins; updateCoinDisplay();
    document.getElementById('shop-balance').textContent = `Balance: ğŸª™ ${myCoins}`;
    // Update local item list
    const idx = shopItems.findIndex(i => i.id === itemId);
    if (idx >= 0) shopItems[idx].owned = true;
    renderShopThemes(); renderShopColors();
    statusEl.textContent = `âœ“ Purchased ${data.item.name}!`; statusEl.className = 'shop-status';
    soundCoin();
  } catch { statusEl.textContent = 'Purchase failed.'; statusEl.className = 'shop-status err'; }
}

document.getElementById('shop-overlay').addEventListener('click', e => { if (e.target === document.getElementById('shop-overlay')) closeShop(); });

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openSettings() {
  document.getElementById('settings-overlay').classList.add('open');
  document.getElementById('settings-status').textContent = '';
  selectedSettingsColor = myColor;
  selectedSettingsTheme = selectedTheme;
  // Load owned items to populate settings
  if (shopItems.length === 0) await loadShopItems();
  renderSettingsThemes();
  renderSettingsColors();
}
function closeSettings() { document.getElementById('settings-overlay').classList.remove('open'); }

function renderSettingsThemes() {
  const ownedThemes = shopItems.filter(i => i.type === 'theme' && i.owned);
  const wrap = document.getElementById('settings-theme-options'); wrap.innerHTML = '';
  ownedThemes.forEach(item => {
    const btn = document.createElement('button');
    btn.className = `theme-btn theme-opt-${item.value}${item.value === selectedSettingsTheme ? ' selected' : ''}`;
    btn.textContent = item.name;
    btn.onclick = () => {
      selectedSettingsTheme = item.value;
      wrap.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      applyTheme(item.value); // live preview
    };
    wrap.appendChild(btn);
  });
  if (ownedThemes.length === 0) wrap.innerHTML = '<span style="font-size:14px;color:var(--text-system)">No themes owned yet. Visit the ğŸ›’ Shop!</span>';
}

function renderSettingsColors() {
  const ownedColors = shopItems.filter(i => i.type === 'color' && i.owned);
  const wrap = document.getElementById('settings-color-swatches'); wrap.innerHTML = '';
  ownedColors.forEach(item => {
    const div = document.createElement('div');
    div.className = 'color-swatch' + (item.value === selectedSettingsColor ? ' selected' : '');
    div.style.background = item.value; div.title = item.name;
    div.onclick = () => {
      selectedSettingsColor = item.value;
      wrap.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
      div.classList.add('selected');
    };
    wrap.appendChild(div);
  });
  if (ownedColors.length === 0) wrap.innerHTML = '<span style="font-size:14px;color:var(--text-system)">No colours owned yet. Visit the ğŸ›’ Shop!</span>';
}

async function saveSettings() {
  const statusEl = document.getElementById('settings-status');
  statusEl.textContent = 'Saving...'; statusEl.style.color = 'inherit';
  try {
    const res = await fetch('/settings', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ color: selectedSettingsColor, theme: selectedSettingsTheme }) });
    const data = await res.json();
    if (!res.ok) { statusEl.textContent = data.error; statusEl.style.color = '#cc0000'; return; }
    myColor = selectedSettingsColor;
    document.getElementById('logged-in-as').innerHTML = `<span style="color:${myColor};text-shadow:0 0 2px rgba(255,255,255,0.5)">${myUsername}</span>`;
    statusEl.textContent = 'Saved!'; statusEl.style.color = '#007700';
    setTimeout(() => { statusEl.textContent = ''; }, 2000);
  } catch { statusEl.textContent = 'Error saving.'; statusEl.style.color = '#cc0000'; }
}

document.getElementById('settings-overlay').addEventListener('click', e => { if (e.target === document.getElementById('settings-overlay')) closeSettings(); });

// â”€â”€ GAMES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openGames() { updateGameBalances(); document.getElementById('games-overlay').classList.add('open'); loadLeaderboard(); }
function closeGames() { document.getElementById('games-overlay').classList.remove('open'); }

function switchGame(name) {
  document.querySelectorAll('.game-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.games-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('game-' + name).classList.add('active');
  document.querySelectorAll('.games-tab').forEach(t => { if (t.textContent.toLowerCase().includes(name === 'leaderboard' ? 'board' : name)) t.classList.add('active'); });
  if (name === 'leaderboard') loadLeaderboard();
  updateGameBalances();
}

function updateGameBalances() {
  ['slots','dice'].forEach(g => { const el = document.getElementById(g + '-balance'); if (el) el.textContent = `Balance: ğŸª™ ${myCoins}`; });
}

function setBet(game, amount) { document.getElementById(game + '-bet').value = amount; }

// SLOTS
let slotsSpinning = false;
async function playSlots() {
  if (slotsSpinning) return;
  const bet = parseInt(document.getElementById('slots-bet').value, 10);
  if (!bet || bet < 1 || bet > 500) { document.getElementById('slots-result').innerHTML = '<span class="result-lose">Bet must be 1-500</span>'; return; }
  slotsSpinning = true;
  const btn = document.getElementById('slots-spin-btn'); btn.disabled = true;
  document.getElementById('slots-result').textContent = '';
  [0,1,2].forEach(i => document.getElementById('reel-' + i).classList.add('spinning'));
  await new Promise(r => setTimeout(r, 600));
  try {
    const res = await fetch('/game/slots', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bet }) });
    const data = await res.json();
    [0,1,2].forEach(i => { const el = document.getElementById('reel-' + i); el.classList.remove('spinning'); el.textContent = data.reels ? data.reels[i] : '?'; });
    if (!res.ok) {
      document.getElementById('slots-result').innerHTML = `<span class="result-lose">${data.error}</span>`;
    } else {
      myCoins = data.coins; updateCoinDisplay(); updateGameBalances();
      if (data.winAmount > 0) { document.getElementById('slots-result').innerHTML = `<span class="result-win">ğŸ‰ WIN! ${data.multiplier}x = +${data.winAmount} coins!</span>`; soundWin(); }
      else { document.getElementById('slots-result').innerHTML = `<span class="result-lose">No match. Better luck next time!</span>`; soundLose(); }
    }
  } catch { document.getElementById('slots-result').innerHTML = '<span class="result-lose">Error. Try again.</span>'; [0,1,2].forEach(i => document.getElementById('reel-' + i).classList.remove('spinning')); }
  slotsSpinning = false; btn.disabled = false;
}

// DICE
let diceRolling = false;
async function playDice() {
  if (diceRolling) return;
  const bet = parseInt(document.getElementById('dice-bet').value, 10);
  if (!bet || bet < 1 || bet > 500) { document.getElementById('dice-result').innerHTML = '<span class="result-lose">Bet must be 1-500</span>'; return; }
  diceRolling = true;
  const btn = document.getElementById('dice-roll-btn'); btn.disabled = true;
  document.getElementById('dice-player').textContent = 'ğŸ²';
  document.getElementById('dice-house').textContent = 'ğŸ²';
  document.getElementById('dice-result').textContent = '';
  await new Promise(r => setTimeout(r, 500));
  try {
    const res = await fetch('/game/dice', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ bet }) });
    const data = await res.json();
    if (!res.ok) {
      document.getElementById('dice-result').innerHTML = `<span class="result-lose">${data.error}</span>`;
    } else {
      document.getElementById('dice-player').textContent = data.playerRoll;
      document.getElementById('dice-house').textContent = data.houseRoll;
      myCoins = data.coins; updateCoinDisplay(); updateGameBalances();
      if (data.result === 'win') { document.getElementById('dice-result').innerHTML = `<span class="result-win">ğŸ‰ You win! +${data.winAmount} coins!</span>`; soundWin(); }
      else if (data.result === 'tie') { document.getElementById('dice-result').innerHTML = `<span class="result-tie">ğŸ¤ Tie! Bet returned.</span>`; }
      else { document.getElementById('dice-result').innerHTML = `<span class="result-lose">House wins. Better luck next time!</span>`; soundLose(); }
    }
  } catch { document.getElementById('dice-result').innerHTML = '<span class="result-lose">Error. Try again.</span>'; }
  diceRolling = false; btn.disabled = false;
}

// LEADERBOARD
async function loadLeaderboard() {
  const container = document.getElementById('leaderboard-rows');
  container.innerHTML = '<div style="text-align:center;color:var(--text-system);padding:20px;">Loading...</div>';
  try {
    const res = await fetch('/leaderboard', { credentials:'include' });
    const data = await res.json();
    if (!res.ok) { container.innerHTML = '<div style="color:#cc0000;text-align:center;padding:12px;">Error loading.</div>'; return; }
    container.innerHTML = data.map((row, i) => `
      <div class="lb-row">
        <span class="lb-rank">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `#${i+1}`}</span>
        <span class="lb-name">${escHtml(row.username)}</span>
        <span class="lb-coins">ğŸª™ ${row.coins}</span>
      </div>
    `).join('');
  } catch { container.innerHTML = '<div style="color:#cc0000;text-align:center;padding:12px;">Error loading.</div>'; }
}

// â”€â”€ TICKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  document.querySelectorAll('.user-entry').forEach(entry => {
    const span = entry.querySelector('.utime');
    if (span) span.textContent = formatDuration(Date.now() - parseInt(entry.dataset.joinedAt, 10));
  });
}, 1000);

setInterval(() => {
  document.querySelectorAll('.poll-timer').forEach(el => {
    const left = Math.max(0, Math.ceil((parseInt(el.dataset.ends, 10) - Date.now()) / 1000));
    if (left === 0) { el.textContent = 'ending...'; el.classList.add('urgent'); }
    else { const m = Math.floor(left / 60), s = left % 60; el.textContent = m > 0 ? `${m}m ${s}s left` : `${s}s left`; el.classList.toggle('urgent', left <= 30); }
  });
}, 1000);

let activityThrottle = 0;
document.addEventListener('keydown', () => {
  const now = Date.now();
  if (now - activityThrottle > 30000) { activityThrottle = now; socket.emit('activity'); }
});

// â”€â”€ KEY BINDINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('input').addEventListener('keydown', e => { if (e.key === 'Enter') send(); });
['login-username','login-password'].forEach(id => document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); }));
['reg-username','reg-password','reg-password2'].forEach(id => document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doRegister(); }));
document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeSettings(); closeGames(); closeShop(); } });

// â”€â”€ AUTO-LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetch('/me').then(async res => {
  if (res.ok) {
    const data = await res.json();
    enterChat(data.username, data.color, data.theme || 'classic', data.coins || 0, data.token, data.dailyAvailable);
  }
});
</script>
</body>
</html>
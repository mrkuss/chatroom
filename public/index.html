<!DOCTYPE html>
<html lang="en">
<head>
  <title>chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-outer:#000080;--bg-window:#c0c0c0;--bg-titlebar:#000080;--bg-sidebar:#000060;
      --bg-sidebar-hdr:#000040;--bg-messages:#ffffff;--bg-input:#ffffff;--bg-bottom:#c0c0c0;
      --bg-users-panel:#c0c0c0;--border-main:white #808080 #808080 white;--border-inset:#808080;
      --text-main:#000000;--text-titlebar:#ffffff;--text-sidebar:#c0c0ff;--text-sidebar-hdr:#aad4ff;
      --text-system:#808080;--text-action:#555555;--room-active-bg:#0000c0;--room-hover-bg:#0000a0;
      --poll-bg:#f0f0ff;--poll-border:#000080;--poll-bar:#000080;--poll-question:#000080;
      --link-preview-bg:#f0f4ff;--link-preview-border:#c0c8e0;--link-preview-accent:#000080;
      --link-title-color:#000080;--typing-color:#808080;--btn-bg:#c0c0c0;
      --btn-border:white #808080 #808080 white;--auth-bg:#c0c0c0;--auth-tab-active-bg:#000080;--auth-input-bg:#ffffff;
    }
    body.theme-dark {
      --bg-outer:#0a0a0a;--bg-window:#1a1a1a;--bg-titlebar:#111111;--bg-sidebar:#0d0d0d;
      --bg-sidebar-hdr:#080808;--bg-messages:#141414;--bg-input:#1e1e1e;--bg-bottom:#1a1a1a;
      --bg-users-panel:#1a1a1a;--border-main:#444 #111 #111 #444;--border-inset:#333;
      --text-main:#d0d0d0;--text-titlebar:#e0e0e0;--text-sidebar:#9090c0;--text-sidebar-hdr:#7090b0;
      --text-system:#555;--text-action:#777;--room-active-bg:#252535;--room-hover-bg:#1e1e2e;
      --poll-bg:#1e1e2e;--poll-border:#4444aa;--poll-bar:#4444aa;--poll-question:#8888cc;
      --link-preview-bg:#1e1e28;--link-preview-border:#333355;--link-preview-accent:#4444aa;
      --link-title-color:#8888cc;--typing-color:#555;--btn-bg:#222;--btn-border:#444 #111 #111 #444;
      --auth-bg:#1a1a1a;--auth-tab-active-bg:#111;--auth-input-bg:#222;
    }
    body.theme-rose {
      --bg-outer:#3d1a2e;--bg-window:#f5e8ee;--bg-titlebar:#7a2d52;--bg-sidebar:#5c1f3d;
      --bg-sidebar-hdr:#3d1428;--bg-messages:#fff5f8;--bg-input:#fff0f5;--bg-bottom:#f5e8ee;
      --bg-users-panel:#f5e8ee;--border-main:#f0c0d8 #8a3060 #8a3060 #f0c0d8;--border-inset:#c090a8;
      --text-main:#3a1428;--text-titlebar:#ffe0ee;--text-sidebar:#f0b0cc;--text-sidebar-hdr:#f8d0e4;
      --text-system:#b08090;--text-action:#805060;--room-active-bg:#7a2d52;--room-hover-bg:#5c1f3d;
      --poll-bg:#fff0f8;--poll-border:#cc5588;--poll-bar:#cc5588;--poll-question:#993366;
      --link-preview-bg:#fff5f9;--link-preview-border:#e8b0c8;--link-preview-accent:#cc5588;
      --link-title-color:#993366;--typing-color:#c090a8;--btn-bg:#f5e8ee;--btn-border:#f0c0d8 #8a3060 #8a3060 #f0c0d8;
      --auth-bg:#f5e8ee;--auth-tab-active-bg:#7a2d52;--auth-input-bg:#fff5f8;
    }
    body.theme-amber {
      --bg-outer:#0d0800;--bg-window:#1a1000;--bg-titlebar:#2a1800;--bg-sidebar:#150d00;
      --bg-sidebar-hdr:#0d0800;--bg-messages:#120b00;--bg-input:#1a1000;--bg-bottom:#1a1000;
      --bg-users-panel:#1a1000;--border-main:#cc7700 #442200 #442200 #cc7700;--border-inset:#553300;
      --text-main:#ff9900;--text-titlebar:#ffbb44;--text-sidebar:#aa6600;--text-sidebar-hdr:#cc8800;
      --text-system:#664400;--text-action:#886600;--room-active-bg:#2a1800;--room-hover-bg:#221200;
      --poll-bg:#1a1000;--poll-border:#aa6600;--poll-bar:#cc8800;--poll-question:#ffaa00;
      --link-preview-bg:#150d00;--link-preview-border:#553300;--link-preview-accent:#cc7700;
      --link-title-color:#ffaa00;--typing-color:#664400;--btn-bg:#1a1000;--btn-border:#cc7700 #442200 #442200 #cc7700;
      --auth-bg:#1a1000;--auth-tab-active-bg:#2a1800;--auth-input-bg:#1a1000;
    }

    body { background-color:var(--bg-outer);font-family:'VT323',monospace;font-size:18px;color:var(--text-main);height:100vh;height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:background-color 0.2s; }

    /* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
    #auth-screen { background:var(--auth-bg);color:var(--text-main);border:3px solid;border-color:var(--border-main);width:90%;max-width:380px; }
    .auth-titlebar { background:var(--bg-titlebar);color:var(--text-titlebar);padding:6px 10px;font-size:18px;letter-spacing:1px;display:flex;justify-content:space-between;align-items:center; }
    .auth-version { font-size:13px;opacity:0.5; }
    .auth-disclaimer { background:#a8a8a8;color:#333;font-size:13px;padding:6px 10px;border-bottom:1px solid #808080; }
    .auth-tabs { display:flex;border-bottom:2px solid var(--border-inset); }
    .auth-tab { flex:1;padding:8px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:18px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444; }
    .auth-tab:last-child { border-right:none; }
    .auth-tab.active { background:var(--auth-tab-active-bg);color:white; }
    .auth-body { padding:20px; }
    .auth-panel { display:none; }
    .auth-panel.active { display:block; }
    .auth-panel p { margin-bottom:10px;font-size:16px; }
    .auth-panel input { width:100%;padding:6px 8px;margin:6px 0;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);background:var(--auth-input-bg);color:var(--text-main); }
    .auth-panel button.primary { width:100%;margin-top:10px;padding:8px;font-family:'VT323',monospace;font-size:20px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px; }
    .auth-error { margin-top:10px;color:#cc0000;font-size:16px;min-height:20px; }
    .auth-user-count { text-align:center;font-size:14px;color:var(--text-system);padding:8px 0 0;font-family:'VT323',monospace; }

    /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
    #chat-screen { display:none;width:100%;height:100vh;height:100dvh;background:var(--bg-window);border:none;overflow:hidden;transition:background-color 0.2s; }
    @media (min-width:700px) { #chat-screen { width:760px;height:90vh;border:3px solid;border-color:var(--border-main); } }
    #chat-layout { display:flex;flex:1;height:calc(100% - 40px);overflow:hidden; }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    #rooms-sidebar { width:110px;background:var(--bg-sidebar);color:var(--text-sidebar);display:flex;flex-direction:column;border-right:2px solid var(--border-inset);flex-shrink:0; }
    #rooms-sidebar h3 { font-size:14px;padding:6px 8px;background:var(--bg-sidebar-hdr);border-bottom:1px solid var(--border-inset);letter-spacing:1px;color:var(--text-sidebar-hdr); }
    .room-btn { display:block;width:100%;text-align:left;padding:6px 8px;font-family:'VT323',monospace;font-size:16px;background:none;border:none;color:var(--text-sidebar);cursor:pointer;border-bottom:1px solid var(--bg-sidebar-hdr); }
    .room-btn:hover { background:var(--room-hover-bg); }
    .room-btn.active { background:var(--room-active-bg);color:white;font-weight:bold; }
    .room-btn .room-unread { float:right;background:#cc0000;color:white;font-size:12px;padding:0 4px;border-radius:2px; }
    .room-private-icon { font-size:11px;margin-right:2px; }
    .room-code-badge { display:block;font-size:11px;color:#ffd700;letter-spacing:1px;padding:0 8px 4px;line-height:1.2;opacity:0.85; }
    body.theme-rose .room-code-badge { color:#cc5588; }
    body.theme-dark .room-code-badge { color:#8888cc; }
    body.theme-amber .room-code-badge { color:#cc8800; }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    #main-area { flex:1;display:flex;flex-direction:column;overflow:hidden; }
    #titlebar { background:var(--bg-titlebar);color:var(--text-titlebar);padding:0 8px;display:flex;justify-content:space-between;align-items:center;font-size:18px;letter-spacing:1px;flex-shrink:0;height:40px;gap:8px; }
    #titlebar-title { font-size:18px;letter-spacing:2px;flex-shrink:0; }
    #titlebar-right { display:flex;align-items:center;gap:5px;margin-left:auto; }
    #logged-in-as { font-size:22px;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-right:8px; text-shadow:0 0 3px rgba(0,0,0,0.9); }
    #logged-in-as span { color:white !important; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
    #coin-display { font-size:14px;color:#ffd700;white-space:nowrap;margin-right:4px;text-shadow:0 0 4px rgba(255,215,0,0.5); }
    body.theme-amber #coin-display,body.theme-dark #coin-display { color:#ffcc00; }
    body.theme-rose #coin-display { color:#ffaa44; }

    .icon-btn { font-family:'VT323',monospace;font-size:16px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;padding:0;line-height:1;position:relative; }
    .icon-btn:active { border-color:var(--border-inset) white white var(--border-inset); }
    .icon-btn.on { background:#006600;color:white;border-color:#0a0 #030 #030 #0a0; }
    .icon-btn.danger { background:#800000;color:white;border-color:#ff8080 #400000 #400000 #ff8080; }
    .icon-btn[title]:hover::after { content:attr(title);position:absolute;bottom:-26px;left:50%;transform:translateX(-50%);background:#000;color:#fff;font-size:12px;padding:2px 6px;white-space:nowrap;z-index:100;pointer-events:none;border:1px solid #555; }
    #user-count-btn { width:auto;padding:0 8px;font-size:14px; }
    .pixel-icon { width:100%;height:100%;image-rendering:pixelated;image-rendering:-moz-crisp-edges;image-rendering:crisp-edges;object-fit:contain; }

    /* ‚îÄ‚îÄ RECONNECT BANNER ‚îÄ‚îÄ */
    #reconnect-banner { display:none;background:#cc6600;color:white;font-size:14px;text-align:center;padding:4px 8px;flex-shrink:0;letter-spacing:1px; }
    #reconnect-banner.visible { display:block; }

    #users-panel { display:none;flex-wrap:wrap;gap:4px 16px;padding:6px 8px;background:var(--bg-users-panel);border-bottom:2px inset var(--border-inset);font-size:15px;flex-shrink:0; }
    #users-panel.visible { display:flex; }
    .user-entry .uname { font-weight:bold;cursor:pointer; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
    .user-entry .uname:hover { text-decoration:underline; }
    .user-entry .utime { color:var(--text-system);font-size:13px;margin-left:4px; }
    .user-entry .uidle { color:#aa6600;font-size:13px;margin-left:2px; }

    /* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
    #messages { flex:1;overflow-y:auto;padding:8px;background:var(--bg-messages);border:2px inset var(--border-inset);margin:8px 8px 0 8px;font-size:18px;line-height:1.6;-webkit-overflow-scrolling:touch;color:var(--text-main);transition:background-color 0.2s,color 0.2s; }
    .msg-action { color:var(--text-action);font-style:italic; }
    .msg-system { color:var(--text-system);font-style:italic; }
    .msg-dm-row { background:#fff0f8;padding:0 4px;border-left:3px solid #cc0088; }
    .msg-dm-label { color:#cc0088;font-size:15px;margin-right:4px; }
    .msg-text { color:var(--text-main); }
    .msg-mention { background: rgba(255,230,0,0.06); border-left:3px solid #ffcc00; padding-left:6px; }
    .msg-own .msg-user { opacity:0.8; }
    .msg-kicked { color:#cc0000;font-style:italic; }
    .msg-claim-event { color:#ffaa00;font-weight:bold;font-style:italic;animation:claimPulse 1s ease-in-out 3; }
    @keyframes claimPulse { 0%,100%{opacity:1}50%{opacity:0.4} }
    body.theme-dark .msg-dm-row { background:#1a0a14;border-left-color:#aa0066; }
    body.theme-rose .msg-dm-row { background:#ffe8f4;border-left-color:#cc5588; }
    body.theme-amber .msg-dm-row { background:#1a0f00;border-left-color:#cc7700; }
    body.theme-amber .msg-dm-label { color:#cc7700; }

    .msg-row { position:relative;padding:2px 0; }
    .msg-row:hover .msg-ts { display:inline; }
    .msg-row:hover .msg-react-btn { display:inline-flex; }
    .msg-ts { display:none;font-size:12px;color:var(--text-system);margin-left:8px; }
    .msg-user { cursor:pointer; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
    .msg-user:hover { text-decoration:underline; }

    /* ‚îÄ‚îÄ REACTIONS ‚îÄ‚îÄ */
    .msg-react-btn { display:none;background:none;border:1px solid var(--border-inset);font-size:13px;padding:1px 5px;cursor:pointer;margin-left:6px;color:var(--text-system);font-family:'VT323',monospace;vertical-align:middle;position:relative; }
    .msg-react-btn:hover .react-picker { display:flex; }
    .react-picker { display:none;position:absolute;bottom:100%;left:0;background:var(--bg-window);border:2px solid;border-color:var(--border-main);padding:4px;gap:4px;z-index:50;white-space:nowrap; }
    .react-emoji { font-size:20px;cursor:pointer;padding:2px;border-radius:3px; }
    .react-emoji:hover { background:var(--room-hover-bg); }
    .msg-reactions { display:flex;flex-wrap:wrap;gap:4px;margin-top:2px;margin-left:4px; }
    .reaction-pill { font-size:14px;padding:1px 6px;background:var(--poll-bg);border:1px solid var(--poll-border);cursor:pointer;display:inline-flex;align-items:center;gap:3px; }
    .reaction-pill:hover { background:var(--room-hover-bg); }
    .reaction-pill .r-count { font-size:12px;color:var(--text-system); }

    /* ‚îÄ‚îÄ LINK PREVIEW ‚îÄ‚îÄ */
    .link-preview { display:inline-block;margin:4px 0 2px 12px;padding:6px 10px;background:var(--link-preview-bg);border:1px solid var(--link-preview-border);border-left:3px solid var(--link-preview-accent);font-size:15px;max-width:420px;color:var(--text-main); }
    .link-preview img { max-width:100%;max-height:80px;display:block;margin-bottom:4px; }
    .link-preview .lp-title { font-weight:bold;color:var(--link-title-color); }
    .link-preview .lp-desc { color:var(--text-system);font-size:13px; }

    /* ‚îÄ‚îÄ POLL ‚îÄ‚îÄ */
    .poll-card { background:var(--poll-bg);border:2px solid var(--poll-border);margin:6px 0;padding:8px 12px;font-size:16px;color:var(--text-main); }
    .poll-card.poll-concluded { opacity:0.75;border-color:var(--border-inset); }
    .poll-question { font-weight:bold;color:var(--poll-question);margin-bottom:6px;font-size:17px; }
    .poll-option { display:flex;align-items:center;gap:8px;margin:3px 0;cursor:pointer;user-select:none; }
    .poll-option:hover:not(.concluded) .poll-opt-label { text-decoration:underline; }
    .poll-option.voted .poll-opt-label { color:var(--poll-question);font-weight:bold; }
    .poll-option.concluded { cursor:default;pointer-events:none; }
    .poll-bar-wrap { flex:1;height:14px;background:var(--border-inset);border:1px solid var(--border-inset);overflow:hidden; }
    .poll-bar { height:100%;background:var(--poll-bar);transition:width 0.3s; }
    .poll-option.winner .poll-bar { background:#007700; }
    .poll-option.winner .poll-opt-label { color:#007700;font-weight:bold; }
    .poll-pct { font-size:13px;color:var(--text-system);width:36px;text-align:right; }
    .poll-opt-label { min-width:80px; }
    .poll-meta { font-size:13px;color:var(--text-system);margin-top:4px; }
    .poll-timer { color:#cc6600;font-size:13px; }
    .poll-timer.urgent { color:#cc0000;font-weight:bold; }

    /* ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ */
    #typing-bar { min-height:22px;padding:2px 10px;margin:0 8px;font-size:14px;color:var(--typing-color);font-style:italic;display:flex;align-items:center;gap:5px;flex-shrink:0; }
    .dots span { display:inline-block;width:4px;height:4px;background:var(--typing-color);border-radius:50%;animation:bounce 1.2s infinite; }
    .dots span:nth-child(2){animation-delay:.2s}.dots span:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.4}40%{transform:translateY(-4px);opacity:1}}

    #bottom { display:flex;gap:6px;padding:8px;flex-shrink:0;background:var(--bg-bottom); }
    #input { flex:1;padding:8px;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);min-width:0;color:var(--text-main);background:var(--bg-input); }
    #send-btn { padding:8px 16px;font-family:'VT323',monospace;font-size:20px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);cursor:pointer;white-space:nowrap;flex-shrink:0; }
    .dm-flash { animation:flash 0.4s 3; }
    @keyframes flash{0%,100%{background:#fff0f8}50%{background:#ffccee}}

    /* ‚îÄ‚îÄ Premium Color Effects ‚îÄ‚îÄ */
    @keyframes shimmer { 0%,100%{opacity:1}50%{opacity:0.7;text-shadow:0 0 8px #ffd700} }
    @keyframes gleam { 0%,100%{text-shadow:0 0 0 rgba(255,255,255,0)}50%{text-shadow:0 0 12px rgba(255,255,255,0.8)} }
    @keyframes sparkle { 0%,100%{text-shadow:0 0 0 rgba(100,200,255,0)}25%{text-shadow:0 0 8px rgba(100,200,255,0.6)}50%{text-shadow:0 0 16px rgba(200,255,255,0.8)}75%{text-shadow:0 0 8px rgba(100,200,255,0.6)} }
    @keyframes rainbow { 0%{color:#ff0000}16%{color:#ff7f00}33%{color:#ffff00}50%{color:#00ff00}66%{color:#0000ff}83%{color:#4b0082}100%{color:#ff0000} }
    @keyframes nebula { 0%,100%{text-shadow:0 0 20px rgba(138,43,226,0.5),0 0 40px rgba(75,0,130,0.3)}50%{text-shadow:0 0 30px rgba(138,43,226,0.8),0 0 60px rgba(75,0,130,0.6)} }
    @keyframes infinity { 0%{text-shadow:0 0 10px #ffd700,0 0 20px rgba(255,215,0,0.8),0 0 40px rgba(255,215,0,0.4);transform:scale(1)}20%{text-shadow:0 0 20px #ffed4e,0 0 40px rgba(255,237,74,0.8),0 0 80px rgba(255,237,74,0.5);transform:scale(1.02)}40%{text-shadow:0 0 30px #ffd700,0 0 60px rgba(255,215,0,0.9),0 0 100px rgba(255,215,0,0.6);transform:scale(1.05)}60%{text-shadow:0 0 25px #ffed4e,0 0 50px rgba(255,237,74,0.8),0 0 80px rgba(255,237,74,0.5);transform:scale(1.03)}80%{text-shadow:0 0 15px #ffd700,0 0 30px rgba(255,215,0,0.7),0 0 50px rgba(255,215,0,0.4);transform:scale(1.01)}100%{text-shadow:0 0 10px #ffd700,0 0 20px rgba(255,215,0,0.8),0 0 40px rgba(255,215,0,0.4);transform:scale(1)} }
    @keyframes prism { 0%{color:#ff0000;text-shadow:0 0 15px #ff0000,0 0 30px rgba(255,0,0,0.6),0 0 50px rgba(255,0,0,0.4)}14%{color:#ff7f00;text-shadow:0 0 15px #ff7f00,0 0 30px rgba(255,127,0,0.6),0 0 50px rgba(255,127,0,0.4)}28%{color:#ffff00;text-shadow:0 0 15px #ffff00,0 0 30px rgba(255,255,0,0.6),0 0 50px rgba(255,255,0,0.4)}42%{color:#00ff00;text-shadow:0 0 15px #00ff00,0 0 30px rgba(0,255,0,0.6),0 0 50px rgba(0,255,0,0.4)}56%{color:#0099ff;text-shadow:0 0 15px #0099ff,0 0 30px rgba(0,153,255,0.6),0 0 50px rgba(0,153,255,0.4)}70%{color:#6600ff;text-shadow:0 0 15px #6600ff,0 0 30px rgba(102,0,255,0.6),0 0 50px rgba(102,0,255,0.4)}85%{color:#ff00ff;text-shadow:0 0 15px #ff00ff,0 0 30px rgba(255,0,255,0.6),0 0 50px rgba(255,0,255,0.4)}100%{color:#ff0000;text-shadow:0 0 15px #ff0000,0 0 30px rgba(255,0,0,0.6),0 0 50px rgba(255,0,0,0.4)} }
    .user-shimmer { animation:shimmer 1.5s ease-in-out infinite; }
    .user-gleam { animation:gleam 2s ease-in-out infinite; }
    .user-sparkle { animation:sparkle 2s ease-in-out infinite; }
    .user-rainbow { animation:rainbow 3s linear infinite; }
    .user-nebula { animation:nebula 3s ease-in-out infinite; }
    .user-infinity { animation:infinity 2s ease-in-out infinite; }
    .user-prism { animation:prism 2s linear infinite; }

    /* ‚îÄ‚îÄ ROULETTE NUMBER GRID ‚îÄ‚îÄ */
    #roulette-number-grid { display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin:8px 0;max-height:180px;overflow-y:auto;padding:4px; }
    .roulette-num-btn { padding:4px;font-family:'VT323',monospace;font-size:14px;border:2px solid;cursor:pointer;font-weight:bold;color:#fff;border-color:var(--border-main);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:50px;line-height:1.2; }
    .roulette-num-btn.red { background:#cc0000; }
    .roulette-num-btn.black { background:#222222; }
    .roulette-num-btn.selected { outline:2px solid yellow;outline-offset:1px;box-shadow:inset 0 0 0 2px yellow; }
    #roulette-selected-info { text-align:center;font-size:14px;color:var(--text-system);margin:8px 0;min-height:20px; }

    /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
    .modal-overlay { display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;align-items:center;justify-content:center; }
    .modal-overlay.open { display:flex; }
    .modal-box { background:var(--bg-window);border:3px solid;border-color:var(--border-main);width:90%;font-family:'VT323',monospace;color:var(--text-main); }
    .modal-titlebar { background:var(--bg-titlebar);color:var(--text-titlebar);padding:6px 10px;display:flex;justify-content:space-between;align-items:center;font-size:18px;letter-spacing:1px; }
    .modal-close { font-family:'VT323',monospace;font-size:16px;background:#800000;color:white;border:2px solid;border-color:#ff8080 #400000 #400000 #ff8080;width:22px;height:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;line-height:1; }
    .modal-body { padding:16px; }

    /* ‚îÄ‚îÄ KEYPAD MODAL ‚îÄ‚îÄ */
    #keypad-modal .modal-box { max-width:280px; }
    .keypad-room-name { text-align:center;font-size:17px;color:var(--text-system);margin-bottom:10px; }
    .keypad-dots { display:flex;justify-content:center;gap:8px;margin-bottom:12px;min-height:24px; }
    .keypad-dot { width:14px;height:14px;border-radius:50%;border:2px solid var(--border-inset);background:transparent;transition:background 0.1s; }
    .keypad-dot.filled { background:var(--poll-bar); }
    .keypad-grid { display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:6px; }
    .keypad-btn { font-family:'VT323',monospace;font-size:28px;padding:10px 0;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);cursor:pointer;text-align:center;user-select:none;transition:opacity 0.07s; }
    .keypad-btn:active { border-color:var(--border-inset) white white var(--border-inset);opacity:0.7; }
    .keypad-bottom-row { display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px; }
    .keypad-enter { background:var(--bg-titlebar);color:var(--text-titlebar);border-color:var(--border-main); }
    .keypad-clear { background:#800000;color:white;border-color:#ff8080 #400000 #400000 #ff8080; }
    .keypad-error { text-align:center;color:#cc0000;font-size:15px;min-height:20px;margin-top:6px; }

    /* ‚îÄ‚îÄ ROOM CREATED / CODE DISPLAY MODAL ‚îÄ‚îÄ */
    #room-created-modal .modal-box { max-width:300px;text-align:center; }
    .room-created-icon { font-size:40px;display:block;margin-bottom:6px; }
    .room-code-display { font-size:48px;letter-spacing:12px;color:var(--poll-question);margin:10px 0;font-weight:bold; }
    .room-code-label { font-size:14px;color:var(--text-system);margin-bottom:12px; }
    .room-code-note { font-size:13px;color:var(--text-system);margin-top:8px; }

    /* ‚îÄ‚îÄ CHANGEPASS CONFIRM MODAL ‚îÄ‚îÄ */
    #changepass-modal .modal-box { max-width:320px; }
    .changepass-warning { font-size:15px;color:#cc6600;margin-bottom:10px;line-height:1.4; }
    .changepass-new-code { font-size:32px;letter-spacing:8px;text-align:center;color:var(--poll-question);margin:8px 0; }
    .changepass-row { display:flex;gap:8px;margin-top:12px; }
    .changepass-confirm-btn { flex:1;padding:8px;font-family:'VT323',monospace;font-size:18px;background:#006600;color:white;border:2px solid;border-color:#0a0 #030 #030 #0a0;cursor:pointer;letter-spacing:1px; }
    .changepass-cancel-btn { flex:1;padding:8px;font-family:'VT323',monospace;font-size:18px;background:#800000;color:white;border:2px solid;border-color:#ff8080 #400000 #400000 #ff8080;cursor:pointer;letter-spacing:1px; }

    /* ‚îÄ‚îÄ SETTINGS TABS ‚îÄ‚îÄ */
    #settings-modal { max-width:420px; }
    .stab-bar { display:flex;border-bottom:2px solid var(--border-inset);margin-bottom:12px; }
    .stab { flex:1;padding:6px 4px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:15px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;text-align:center; }
    .stab:last-child { border-right:none; }
    .stab.active { background:var(--bg-titlebar);color:white; }
    .stab-panel { display:none; }
    .stab-panel.active { display:block; }
    .settings-section { margin-bottom:16px; }
    .settings-label { font-size:16px;margin-bottom:6px;display:block;letter-spacing:1px; }
    .settings-note { font-size:13px;color:var(--text-system);margin-bottom:8px; }
    .theme-options { display:grid;grid-template-columns:1fr 1fr;gap:6px; }
    .theme-btn { font-family:'VT323',monospace;font-size:16px;padding:8px 6px;border:2px solid;cursor:pointer;letter-spacing:1px;text-align:center; }
    .theme-btn.theme-opt-classic { background:#000080;color:white;border-color:#6060c0 #000040 #000040 #6060c0; }
    .theme-btn.theme-opt-dark { background:#1a1a1a;color:#d0d0d0;border-color:#444 #111 #111 #444; }
    .theme-btn.theme-opt-rose { background:#7a2d52;color:#ffe0ee;border-color:#f0a0c0 #3d1428 #3d1428 #f0a0c0; }
    .theme-btn.theme-opt-amber { background:#2a1800;color:#ff9900;border-color:#cc7700 #442200 #442200 #cc7700; }
    .theme-btn.selected { outline:2px solid white;outline-offset:1px; }
    #settings-color-swatches { display:flex;flex-direction:column;gap:0;max-height:280px;overflow-y:auto;border:2px inset var(--border-inset);background:var(--bg-messages);padding:0; }
    .color-swatch { display:flex;align-items:center;gap:12px;padding:8px 12px;cursor:pointer;border:2px solid transparent;background:var(--bg-messages);min-height:32px; }
    .color-swatch:hover { background:var(--bg-window); }
    .color-swatch.selected { background:var(--bg-titlebar);border-color:var(--text-titlebar);box-shadow:inset 0 0 0 1px var(--text-titlebar); }
    .color-preview { width:32px;height:32px;border:2px solid;border-color:var(--border-main);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px; }
    .color-name { flex:1;font-family:'VT323',monospace;font-size:16px;color:var(--text-main); }
    .color-checkmark { color:var(--text-main);font-weight:bold;width:20px;text-align:center;font-size:18px; }
    .settings-save-row { display:flex;gap:8px;margin-top:4px; }
    .settings-btn { flex:1;padding:8px;font-family:'VT323',monospace;font-size:18px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px; }
    .settings-status { font-size:14px;color:#007700;min-height:18px;margin-top:6px;text-align:center; }
    .stat-row { display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border-inset);font-size:16px; }
    .stat-label { color:var(--text-system); }
    .stat-value { color:var(--text-main);font-weight:bold; }
    .badge-grid { display:grid;grid-template-columns:1fr 1fr;gap:6px; }
    .badge-item { border:2px solid var(--border-inset);padding:6px 8px;font-size:14px;cursor:pointer;background:var(--bg-messages); }
    .badge-item.earned { border-color:#007700;background:var(--poll-bg); }
    .badge-item.active-badge { border-color:#ffd700;outline:1px solid #ffd700; }
    .badge-item.locked { opacity:0.4;cursor:default; }
    .badge-emoji { font-size:22px;display:block;margin-bottom:3px; }
    .badge-name { font-size:15px;font-weight:bold;color:var(--text-main); }
    .badge-desc { font-size:12px;color:var(--text-system);margin-top:2px; }
    .badge-active-label { font-size:11px;color:#ffd700;margin-top:2px; }
    .badge-set-note { font-size:13px;color:var(--text-system);margin-bottom:8px; }
    .help-section { margin-bottom:14px; }
    .help-section-title { font-size:16px;font-weight:bold;color:var(--poll-question);margin-bottom:4px;letter-spacing:1px; }
    .help-cmd { font-size:14px;padding:2px 0;border-bottom:1px dotted var(--border-inset); }
    .help-cmd code { color:var(--link-title-color);font-family:'VT323',monospace;font-size:15px; }

    /* ‚îÄ‚îÄ DAILY ‚îÄ‚îÄ */
    #daily-modal .modal-box { max-width:320px;text-align:center; }
    .daily-icon { font-size:48px;display:block;margin-bottom:8px; }
    .daily-title { font-size:24px;color:var(--poll-question);margin-bottom:8px; }
    .daily-amount { font-size:32px;color:#ffd700;margin:8px 0; }
    .daily-claim-btn { width:100%;padding:10px;font-family:'VT323',monospace;font-size:22px;background:#007700;color:white;border:2px solid;border-color:#0a0 #030 #030 #0a0;cursor:pointer;margin-top:12px;letter-spacing:1px; }

    /* ‚îÄ‚îÄ PROFILE POPUP ‚îÄ‚îÄ */
    #profile-modal .modal-box { max-width:340px; }
    .profile-header { display:flex;align-items:center;gap:10px;margin-bottom:12px; }
    .profile-avatar { font-size:40px; }
    .profile-name { font-size:24px;font-weight:bold; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
    .profile-badge-display { font-size:16px;margin-top:2px;color:var(--text-system); }
    .profile-stats { margin-bottom:12px; }

    /* ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ */
    #shop-modal { max-width:520px; }
    .shop-tabs { display:flex;border-bottom:2px solid var(--border-inset); }
    .shop-tab { flex:1;padding:7px 4px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:16px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;text-align:center; }
    .shop-tab:last-child { border-right:none; }
    .shop-tab.active { background:var(--bg-titlebar);color:white; }
    .shop-panel { display:none; }
    .shop-panel.active { display:block; }
    .shop-balance { font-size:16px;color:#ffd700;padding:10px 0 6px;text-align:center; }
    .shop-grid { display:grid;grid-template-columns:1fr 1fr;gap:8px;padding-bottom:8px; }
    .shop-item { border:2px solid var(--border-inset);padding:8px;background:var(--bg-messages);position:relative;font-size:14px; }
    .shop-item.owned { border-color:#007700; }
    .shop-item-swatch { width:100%;height:28px;margin-bottom:6px;border:1px solid var(--border-inset); }
    .shop-item-name { font-size:16px;font-weight:bold; }
    .shop-item-desc { font-size:12px;color:var(--text-system);margin:3px 0 6px; }
    .shop-item-price { font-size:14px;color:#ffd700; }
    .shop-item-price.free { color:#007700; }
    .shop-item-owned-badge { position:absolute;top:4px;right:4px;font-size:11px;background:#007700;color:white;padding:1px 5px; }
    .shop-buy-btn { display:block;width:100%;margin-top:6px;padding:5px;font-family:'VT323',monospace;font-size:15px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer; }
    .shop-buy-btn:disabled { opacity:0.4;cursor:not-allowed; }
    .shop-status { font-size:14px;min-height:18px;margin-top:8px;text-align:center;color:#007700; }
    .shop-status.err { color:#cc0000; }

    /* ‚îÄ‚îÄ GAMES ‚îÄ‚îÄ */
    #games-modal { max-width:500px; }
    .games-tabs { display:flex;border-bottom:2px solid var(--border-inset);flex-wrap:wrap; }
    .games-tab { flex:1;min-width:80px;padding:6px 4px;background:#a0a0a0;border:none;font-family:'VT323',monospace;font-size:16px;cursor:pointer;border-right:1px solid var(--border-inset);color:#444;text-align:center; }
    .games-tab:last-child { border-right:none; }
    .games-tab.active { background:var(--bg-titlebar);color:white; }
    .game-panel { display:none;padding:16px 0 0; }
    .game-panel.active { display:block; }
    .game-balance { font-size:16px;color:#ffd700;margin-bottom:12px;text-align:center; }
    .bet-row { display:flex;align-items:center;gap:8px;margin-bottom:12px; }
    .bet-row label { font-size:16px;flex-shrink:0; }
    .bet-input { flex:1;padding:4px 8px;font-family:'VT323',monospace;font-size:20px;border:2px inset var(--border-inset);background:var(--bg-input);color:var(--text-main);min-width:0; }
    .bet-presets { display:flex;gap:4px; }
    .bet-preset { font-family:'VT323',monospace;font-size:14px;padding:2px 8px;background:var(--btn-bg);color:var(--text-main);border:2px solid;border-color:var(--btn-border);cursor:pointer; }
    .game-btn { width:100%;padding:10px;font-family:'VT323',monospace;font-size:20px;background:var(--bg-titlebar);color:var(--text-titlebar);border:2px solid;border-color:var(--border-main);cursor:pointer;letter-spacing:1px;margin-top:4px; }
    .game-btn:disabled { opacity:0.5;cursor:not-allowed; }
    .game-result { margin-top:12px;padding:10px;background:var(--bg-messages);border:2px inset var(--border-inset);font-size:16px;min-height:50px;text-align:center; }
    .result-win { color:#007700;font-size:20px; }
    .result-lose { color:#cc0000;font-size:20px; }
    .result-tie { color:#cc6600;font-size:20px; }
    .slots-reels { display:flex;gap:8px;justify-content:center;margin:12px 0;font-size:40px; }
    .slot-reel { width:60px;height:60px;background:var(--bg-messages);border:3px inset var(--border-inset);display:flex;align-items:center;justify-content:center; }
    .slot-reel.spinning { animation:spinReel 0.15s infinite; }
    @keyframes spinReel{0%{transform:translateY(-4px)}50%{transform:translateY(4px)}100%{transform:translateY(-4px)}}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .dice-display { display:flex;gap:16px;justify-content:center;align-items:center;margin:12px 0;font-size:14px;text-align:center; }
    .dice-side label { display:block;margin-bottom:4px;color:var(--text-system); }
    .dice-value { font-size:48px;min-width:60px;height:60px;background:var(--bg-messages);border:3px inset var(--border-inset);display:flex;align-items:center;justify-content:center; }
    .dice-vs { font-size:20px;color:var(--text-system); }
    
    .lb-row { display:flex;justify-content:space-between;padding:4px 8px;border-bottom:1px solid var(--border-inset);font-size:16px; }
    .lb-row:nth-child(odd) { background:var(--poll-bg); }
    .lb-rank { color:var(--text-system);width:30px; }
    .lb-name { flex:1;margin:0 8px; }
    .lb-coins { color:#ffd700; }
    .lb-header { display:flex;justify-content:space-between;padding:4px 8px;font-size:14px;color:var(--text-system);border-bottom:2px solid var(--border-inset);margin-bottom:4px; }
  </style>
</head>
<body>

<!-- Auth -->
<div id="auth-screen">
  <div class="auth-titlebar"><span>chatroom</span><span class="auth-version">v2.0</span></div>
  <div class="auth-disclaimer">a small project by mce.</div>
  <div class="auth-tabs">
    <button class="auth-tab active" onclick="switchTab('login')">Login</button>
    <button class="auth-tab" onclick="switchTab('register')">Register</button>
  </div>
  <div class="auth-body">
    <div id="login-panel" class="auth-panel active">
      <p>Sign in to your account:</p>
      <input id="login-username" type="text" placeholder="Username..." maxlength="20" autocomplete="username" />
      <input id="login-password" type="password" placeholder="Password..." autocomplete="current-password" />
      <button class="primary" onclick="doLogin()">Login</button>
      <div class="auth-error" id="login-error"></div>
    </div>
    <div id="register-panel" class="auth-panel">
      <p>Create a new account:</p>
      <input id="reg-username" type="text" placeholder="Username (3-20 chars)..." maxlength="20" autocomplete="username" />
      <input id="reg-password" type="password" placeholder="Password (min 6 chars)..." autocomplete="new-password" />
      <input id="reg-password2" type="password" placeholder="Confirm password..." autocomplete="new-password" />
      <button class="primary" onclick="doRegister()">Create Account</button>
      <div class="auth-error" id="register-error"></div>
    </div>
    <div class="auth-user-count" id="auth-user-count"></div>
  </div>
</div>

<!-- Chat -->
<div id="chat-screen">
  <div id="titlebar">
    <span id="titlebar-title">chatroom</span>
    <div id="titlebar-right">
      <span id="logged-in-as"></span>
      <span id="coin-display">ü™ô 0</span>
      <button class="icon-btn" onclick="openShop()" title="Shop"><img src="/sprites/shopButtonIcon.png" alt="Shop" class="pixel-icon"></button>
      <button class="icon-btn" onclick="openGames()" title="Games"><img src="/sprites/gameButtonIcon.png" alt="Games" class="pixel-icon"></button>
      <button id="user-count-btn" class="icon-btn" onclick="toggleUsers()" title="Online users"><img src="/sprites/onlineUsersButtonIcon.png" alt="Users" class="pixel-icon"> <span id="user-count-text">0</span></button>
      <button class="icon-btn" onclick="openSettings()" title="Settings"><img src="/sprites/settingsButtonIcon.png" alt="Settings" class="pixel-icon"></button>
      <button class="icon-btn danger" onclick="doLogout()" title="Exit">‚úï</button>
    </div>
  </div>
  <div id="reconnect-banner">‚ö† Connection lost ‚Äî reconnecting...</div>
  <div id="chat-layout">
    <div id="rooms-sidebar">
      <h3>ROOMS</h3>
      <div id="rooms-list"></div>
    </div>
    <div id="main-area">
      <div id="users-panel"></div>
      <ul id="messages"></ul>
      <div id="typing-bar"></div>
      <div id="bottom">
        <input id="input" placeholder="Message, '/help' for commands" autocomplete="off" />
        <button id="send-btn" onclick="send()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ KEYPAD MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="keypad-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span>üîí Enter Room Code</span>
      <button class="modal-close" onclick="closeKeypad()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="keypad-room-name" id="keypad-room-label"></div>
      <div class="keypad-dots" id="keypad-dots"></div>
      <div class="keypad-grid">
        <button class="keypad-btn" onclick="keypadPress('1')">1</button>
        <button class="keypad-btn" onclick="keypadPress('2')">2</button>
        <button class="keypad-btn" onclick="keypadPress('3')">3</button>
        <button class="keypad-btn" onclick="keypadPress('4')">4</button>
        <button class="keypad-btn" onclick="keypadPress('5')">5</button>
        <button class="keypad-btn" onclick="keypadPress('6')">6</button>
        <button class="keypad-btn" onclick="keypadPress('7')">7</button>
        <button class="keypad-btn" onclick="keypadPress('8')">8</button>
        <button class="keypad-btn" onclick="keypadPress('9')">9</button>
      </div>
      <div class="keypad-bottom-row">
        <button class="keypad-btn keypad-clear" onclick="keypadClear()">‚å´</button>
        <button class="keypad-btn" onclick="keypadPress('0')">0</button>
        <button class="keypad-btn keypad-enter" onclick="keypadSubmit()">‚Üµ</button>
      </div>
      <div class="keypad-error" id="keypad-error"></div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ ROOM CREATED MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="room-created-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span>üîí Room Created</span>
      <button class="modal-close" onclick="closeRoomCreated()">‚úï</button>
    </div>
    <div class="modal-body" style="text-align:center;">
      <span class="room-created-icon">üè†</span>
      <div style="font-size:17px;margin-bottom:4px;">Room <strong id="rc-room-name"></strong> is ready!</div>
      <div class="room-code-label">Share this code with anyone you want to join:</div>
      <div class="room-code-display" id="rc-room-code"></div>
      <div class="room-code-note">The code also appears under the room name in your sidebar.</div>
      <button class="settings-btn" style="margin-top:14px;width:100%" onclick="closeRoomCreated()">Got it</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ CHANGEPASS CONFIRM MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="changepass-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar">
      <span>‚ö† Confirm Code Change</span>
      <button class="modal-close" onclick="closeChangepass()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="changepass-warning">‚ö† This will kick ALL current members from the room. They will need the new code to re-join.</div>
      <div style="font-size:14px;color:var(--text-system);margin-bottom:4px;">New code for <strong id="cp-room-name"></strong>:</div>
      <div class="changepass-new-code" id="cp-new-code"></div>
      <div class="changepass-row">
        <button class="changepass-confirm-btn" onclick="confirmChangepass()">Confirm</button>
        <button class="changepass-cancel-btn" onclick="closeChangepass()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Daily Reward -->
<div id="daily-modal" class="modal-overlay">
  <div class="modal-box" style="max-width:320px;text-align:center;">
    <div class="modal-titlebar"><span>Daily Reward</span></div>
    <div class="modal-body">
      <span class="daily-icon">ü™ô</span>
      <div class="daily-title">Daily Bonus Available!</div>
      <div style="font-size:15px;color:var(--text-system);margin-bottom:4px;">Claim your free coins for today</div>
      <div class="daily-amount">+50 coins</div>
      <button class="daily-claim-btn" onclick="claimDaily()">Claim Reward</button>
    </div>
  </div>
</div>

<!-- Profile Popup -->
<div id="profile-modal" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-titlebar"><span id="profile-modal-title">Profile</span><button class="modal-close" onclick="closeProfile()">‚úï</button></div>
    <div class="modal-body" id="profile-modal-body">Loading...</div>
  </div>
</div>

<!-- Settings -->
<div id="settings-overlay" class="modal-overlay">
  <div class="modal-box" id="settings-modal">
    <div class="modal-titlebar"><span>‚öô Settings</span><button class="modal-close" onclick="closeSettings()">‚úï</button></div>
    <div class="modal-body">
      <div class="stab-bar">
        <button class="stab active" onclick="switchSettingsTab('appearance')">Look</button>
        <button class="stab" onclick="switchSettingsTab('badges')">Badges</button>
        <button class="stab" onclick="switchSettingsTab('stats')">Stats</button>
        <button class="stab" onclick="switchSettingsTab('account')">Account</button>
        <button class="stab" onclick="switchSettingsTab('help')">Help</button>
      </div>
      <div id="stab-appearance" class="stab-panel active">
        <div class="settings-section">
          <span class="settings-label">Sound Effects</span>
          <button id="sound-toggle-btn" class="icon-btn on" onclick="toggleSound()" title="Toggle SFX">üîä Enabled</button>
        </div>
        <div class="settings-section">
          <span class="settings-label">Theme</span>
          <div class="settings-note">Only owned themes shown. Buy more in the üõí Shop.</div>
          <div class="theme-options" id="settings-theme-options"></div>
        </div>
        <div class="settings-section">
          <span class="settings-label">Username Colour</span>
          <div class="settings-note">Only owned colours shown.</div>
          <div id="settings-color-swatches"></div>
        </div>
        <div class="settings-save-row"><button class="settings-btn" onclick="saveSettings()">Save</button></div>
        <div class="settings-status" id="settings-status"></div>
      </div>
      <div id="stab-badges" class="stab-panel">
        <div class="badge-set-note">Click an earned badge to set it as your active showcase badge.</div>
        <div class="badge-grid" id="badge-grid"></div>
        <div class="settings-status" id="badge-status"></div>
      </div>
      <div id="stab-stats" class="stab-panel">
        <div id="stats-content"><div style="text-align:center;padding:20px;color:var(--text-system);">Loading...</div></div>
      </div>
      <div id="stab-account" class="stab-panel" style="padding:6px 0 0;">
        <div class="settings-section">
          <span class="settings-label">Change Password</span>
          <div class="settings-note">Provide your current password, then choose a new one.</div>
          <input id="pw-old" type="password" placeholder="Current password" style="width:100%;margin:8px 0;padding:6px;font-family:'VT323',monospace;font-size:16px;" />
          <input id="pw-new" type="password" placeholder="New password (min 6 chars)" style="width:100%;margin:8px 0;padding:6px;font-family:'VT323',monospace;font-size:16px;" />
          <input id="pw-new2" type="password" placeholder="Confirm new password" style="width:100%;margin:8px 0;padding:6px;font-family:'VT323',monospace;font-size:16px;" />
          <div class="settings-save-row"><button class="settings-btn" onclick="changePassword()">Change Password</button></div>
          <div class="settings-status" id="pw-status"></div>
        </div>
      </div>
      <div id="stab-help" class="stab-panel">
        <div style="max-height:340px;overflow-y:auto;">
          <div class="help-section">
            <div class="help-section-title">üí¨ Chat</div>
            <div class="help-cmd"><code>/me action</code> ‚Äî emote action</div>
            <div class="help-cmd"><code>/msg username text</code> ‚Äî private DM</div>
          </div>
          <div class="help-section">
            <div class="help-section-title">üìä Polls</div>
            <div class="help-cmd"><code>/poll "Question?" Yes No Maybe</code> ‚Äî create a 5-min poll</div>
          </div>
          <div class="help-section">
            <div class="help-section-title">üé≤ Duels</div>
            <div class="help-cmd"><code>/duel username amount</code> ‚Äî challenge to coinflip</div>
            <div class="help-cmd"><code>/accept</code> / <code>/decline</code> ‚Äî respond to a challenge</div>
          </div>
          <div class="help-section">
            <div class="help-section-title">üí∏ Coins</div>
            <div class="help-cmd"><code>/give username amount</code> ‚Äî send coins</div>
            <div class="help-cmd"><code>claim</code> ‚Äî grab free coins during events</div>
          </div>
          <div class="help-section">
            <div class="help-section-title">üîí Private Rooms</div>
            <div class="help-cmd"><code>/create roomname code</code> ‚Äî create a room with a numeric code</div>
            <div class="help-cmd"><code>/joinroom roomname</code> ‚Äî open the keypad to join a private room</div>
            <div class="help-cmd"><code>/kick username</code> ‚Äî (owner) kick someone; revokes their access</div>
            <div class="help-cmd"><code>/ban username</code> ‚Äî (owner) permanently ban a user from the room</div>
            <div class="help-cmd"><code>/unban username</code> ‚Äî (owner) remove a ban</div>
            <div class="help-cmd"><code>/changepass newcode</code> ‚Äî (owner) change the room code; kicks all members</div>
            <div class="help-cmd"><code>/deleteroom roomname</code> ‚Äî (owner) delete your private room</div>
            <div class="help-cmd">Your room code always shows under the room name in the sidebar</div>
            <div class="help-cmd">Codes are 1‚Äì9 digits only (e.g. 4729 or 123456789)</div>
          </div>
          <div class="help-section">
            <div class="help-section-title">üòÆ Reactions</div>
            <div class="help-cmd">Hover a message ‚Üí click + ‚Üí pick an emoji</div>
          </div>
          <div class="help-section">
            <div class="help-section-title">üéÆ Games</div>
            <div class="help-cmd">Slots ‚Äî match 3 symbols, up to 20x bet</div>
            <div class="help-cmd">Dice ‚Äî beat the house, win 1.9x</div>
            <div class="help-cmd">Roulette ‚Äî pick red/black or even/odd, 1.8x payout</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Shop -->
<div id="shop-overlay" class="modal-overlay">
  <div class="modal-box" id="shop-modal">
    <div class="modal-titlebar"><span>üõí Shop</span><button class="modal-close" onclick="closeShop()">‚úï</button></div>
    <div style="padding:0 16px;">
      <div class="shop-balance" id="shop-balance">Balance: ü™ô 0</div>
      <div class="shop-tabs">
        <button class="shop-tab active" onclick="switchShopTab('themes')">Themes</button>
        <button class="shop-tab" onclick="switchShopTab('colors')">Colours</button>
      </div>
    </div>
    <div style="padding:0 16px 16px;max-height:380px;overflow-y:auto;">
      <div id="shop-themes" class="shop-panel active"></div>
      <div id="shop-colors" class="shop-panel"></div>
    </div>
    <div style="padding:0 16px 12px;"><div class="shop-status" id="shop-status"></div></div>
  </div>
</div>

<!-- Games -->
<div id="games-overlay" class="modal-overlay">
  <div class="modal-box" id="games-modal">
    <div class="modal-titlebar"><span>üéÆ Games</span><button class="modal-close" onclick="closeGames()">‚úï</button></div>
    <div style="padding:0 16px;">
      <div class="games-tabs">
        <button class="games-tab active" onclick="switchGame('slots')">üé∞ Slots</button>
        <button class="games-tab" onclick="switchGame('dice')">üé≤ Dice</button>
        <button class="games-tab" onclick="switchGame('roulette')">üé° Roulette</button>
        <button class="games-tab" onclick="switchGame('leaderboard')">üèÜ Board</button>
      </div>
    </div>
    <div id="game-slots" class="game-panel active" style="padding:0 16px 16px;">
      <div class="game-balance" id="slots-balance">Balance: ü™ô 0</div>
      <div class="slots-reels"><div class="slot-reel" id="reel-0">üé∞</div><div class="slot-reel" id="reel-1">üé∞</div><div class="slot-reel" id="reel-2">üé∞</div></div>
      <div class="bet-row"><label>Bet:</label><input type="number" class="bet-input" id="slots-bet" value="10" min="1" max="50000" /><div class="bet-presets"><button class="bet-preset" onclick="setBet('slots',10)">10</button><button class="bet-preset" onclick="setBet('slots',50)">50</button><button class="bet-preset" onclick="setBet('slots',100)">100</button></div></div>
      <button class="game-btn" id="slots-spin-btn" onclick="playSlots()">SPIN</button>
      <div class="game-result" id="slots-result"></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">More forgiving odds ¬∑ üçí=2x ¬∑ üçã=3x ¬∑ üçä=4x ¬∑ ‚≠ê=6x ¬∑ üíé=8x ¬∑ 7Ô∏è‚É£=20x</div>
    </div>
    <div id="game-dice" class="game-panel" style="padding:0 16px 16px;">
      <div class="game-balance" id="dice-balance">Balance: ü™ô 0</div>
      <div class="dice-display"><div class="dice-side"><label>You</label><div class="dice-value" id="dice-player">?</div></div><div class="dice-vs">VS</div><div class="dice-side"><label>House</label><div class="dice-value" id="dice-house">?</div></div></div>
      <div class="bet-row"><label>Bet:</label><input type="number" class="bet-input" id="dice-bet" value="10" min="1" max="50000" /><div class="bet-presets"><button class="bet-preset" onclick="setBet('dice',10)">10</button><button class="bet-preset" onclick="setBet('dice',50)">50</button><button class="bet-preset" onclick="setBet('dice',100)">100</button></div></div>
      <button class="game-btn" id="dice-roll-btn" onclick="playDice()">ROLL DICE</button>
      <div class="game-result" id="dice-result"></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">Roll 2 dice vs the house. Higher total wins 1.9x ¬∑ Tie returns bet</div>
    </div>
    <div id="game-roulette" class="game-panel" style="padding:0 16px 16px;">
      <div class="game-balance" id="roulette-balance">Balance: ü™ô 0</div>
      <div style="display:flex;justify-content:center;align-items:center;gap:16px;margin:16px 0;">
        <div style="text-align:center;">
          <label style="font-size:12px;color:var(--text-system);">Spin</label>
          <div style="font-size:28px;margin-top:4px;text-align:center;line-height:1.2;" id="roulette-spin">üé°</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0;">
        <button class="game-btn" id="roulette-red-btn" onclick="playRoulette('red')" style="background:#cc0000;">üî¥ RED</button>
        <button class="game-btn" id="roulette-black-btn" onclick="playRoulette('black')" style="background:#222222;color:#fff;">‚ö´ BLACK</button>
        <button class="game-btn" onclick="playRoulette('even')" style="background:#0056b3;">2,4,6... EVEN</button>
        <button class="game-btn" onclick="playRoulette('odd')" style="background:#0056b3;">1,3,5... ODD</button>
      </div>
      <div class="bet-row"><label>Bet:</label><input type="number" class="bet-input" id="roulette-bet" value="10" min="1" max="50000" /><div class="bet-presets"><button class="bet-preset" onclick="setBet('roulette',10)">10</button><button class="bet-preset" onclick="setBet('roulette',50)">50</button><button class="bet-preset" onclick="setBet('roulette',100)">100</button></div></div>
      <div id="roulette-selected-info"></div>
      <div style="font-size:12px;color:var(--text-system);margin:8px 0;">Or pick a specific number (50x payout):</div>
      <div id="roulette-number-grid"></div>
      <div class="game-result" id="roulette-result"></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">Red/Black/Even/Odd = 1.8x ¬∑ Number = 50x. Spin 0 is green (house win)</div>
    </div>
    <div id="game-leaderboard" class="game-panel" style="padding:0 16px 16px;">
      <div class="lb-header"><span>Rank</span><span>Player</span><span>Coins</span></div>
      <div id="leaderboard-rows"><div style="text-align:center;color:var(--text-system);padding:20px;">Loading...</div></div>
      <button class="game-btn" style="margin-top:12px;" onclick="loadLeaderboard()">‚Üª Refresh</button>
    </div>
  </div>
</div>

<!-- Announcement Modal -->
<div id="announcement-modal" class="modal-overlay">
  <div style="background:var(--bg-input);padding:24px;border-radius:4px;max-width:500px;box-shadow:0 4px 16px rgba(0,0,0,0.4);">
    <div style="font-weight:bold;font-size:18px;margin-bottom:12px;">Server Announcement</div>
    <div id="announcement-content" style="color:var(--text-primary);margin-bottom:20px;line-height:1.5;"></div>
    <button class="game-btn" onclick="closeAnnouncement()" style="width:100%;">Close</button>
  </div>
</div>

<!-- Patch Notes Modal -->
<div id="patchnotes-modal" class="modal-overlay">
  <div style="background:var(--bg-input);padding:24px;border-radius:4px;max-width:600px;max-height:80vh;overflow-y:auto;box-shadow:0 4px 16px rgba(0,0,0,0.4);">
    <div style="font-weight:bold;font-size:18px;margin-bottom:16px;">Patch Notes</div>
    <div id="patchnotes-content" style="color:var(--text-primary);line-height:1.6;font-size:14px;">
      <div style="margin-bottom:16px;">
        <div style="font-weight:bold;margin-bottom:8px;">Latest Updates</div>
        <ul style="margin:0;padding-left:20px;">
          <li>Removed emojis from system messages for cleaner chat</li>
          <li>Added /flip command - 50/50 coinflip to double your coins or lose them</li>
          <li>Added 10-minute cooldown to /rob command</li>
          <li>Added /announcement command for admins to broadcast messages</li>
          <li>Premium colors now display correctly without emoji names</li>
          <li>Improved shop and settings UI clarity</li>
        </ul>
      </div>
      <div style="margin-bottom:16px;">
        <div style="font-weight:bold;margin-bottom:8px;">Game Balance</div>
        <ul style="margin:0;padding-left:20px;">
          <li>Slots: Increased winning odds with adjusted multipliers</li>
          <li>Dice: 1.9x payout on wins</li>
          <li>Roulette: 1.8x for color/even/odd bets, 50x for number bets (1-36)</li>
          <li>/duel: Coinflip for doubled stakes</li>
        </ul>
      </div>
      <div>
        <div style="font-weight:bold;margin-bottom:8px;">Premium Colors</div>
        <ul style="margin:0;padding-left:20px;">
          <li>1k: Shimmering Gold (shimmer effect)</li>
          <li>2.5k: Platinum Gleam (gleam effect)</li>
          <li>5k: Diamond Sparkle (sparkle effect)</li>
          <li>10k: Aurora Borealis (rainbow effect)</li>
          <li>50k: Cosmic Nebula (nebula effect)</li>
          <li>100k: Infinity Gold (infinity effect)</li>
          <li>500k: Prismatic Legend (prism effect)</li>
        </ul>
      </div>
    </div>
    <button class="game-btn" onclick="closePatchNotes()" style="width:100%;margin-top:16px;">Close</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ‚îÄ‚îÄ SHOP CATALOGUE (for color effects) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SHOP_COLORS={
  '#ffd700':{name:'Shimmering Gold / Infinity Gold',effect:'shimmer'},'#e5e4e2':{name:'Platinum Gleam',effect:'gleam'},
  '#b9f2ff':{name:'Diamond Sparkle',effect:'sparkle'},'#ff6bcb':{name:'Aurora Borealis',effect:'rainbow'},
  '#2a0845':{name:'Cosmic Nebula',effect:'nebula'},'#ff00ff':{name:'Prismatic Legend',effect:'prism'}
};

// ‚îÄ‚îÄ SOUNDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let soundEnabled = true;
const AudioContext = window.AudioContext || window.webkitAudioContext;
let actx = null;
function getActx() { if (!actx) actx = new AudioContext(); return actx; }
function playTone(freq,type,duration,vol=0.15,delay=0) {
  if (!soundEnabled) return;
  try { const ctx=getActx(),osc=ctx.createOscillator(),gain=ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); osc.type=type; osc.frequency.setValueAtTime(freq,ctx.currentTime+delay); gain.gain.setValueAtTime(vol,ctx.currentTime+delay); gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+delay+duration); osc.start(ctx.currentTime+delay); osc.stop(ctx.currentTime+delay+duration+0.01); } catch {}
}
function soundMessage(){playTone(880,'square',0.06,0.1)}
function soundJoin(){playTone(523,'sine',0.15,0.12);playTone(659,'sine',0.15,0.12,0.12);playTone(784,'sine',0.2,0.14,0.24)}
function soundLeave(){playTone(784,'sine',0.12,0.1);playTone(523,'sine',0.2,0.1,0.14)}
function soundDM(){playTone(1046,'square',0.08,0.1);playTone(1318,'square',0.12,0.12,0.1)}
function soundPollEnd(){playTone(659,'sine',0.1,0.12);playTone(784,'sine',0.1,0.12,0.1);playTone(1046,'sine',0.3,0.15,0.2)}
function soundWin(){playTone(523,'sine',0.1,0.15);playTone(659,'sine',0.1,0.15,0.1);playTone(784,'sine',0.1,0.15,0.2);playTone(1046,'sine',0.3,0.18,0.3)}
function soundLose(){playTone(400,'sawtooth',0.1,0.12);playTone(300,'sawtooth',0.2,0.12,0.12)}
function soundCoin(){playTone(1318,'sine',0.08,0.12);playTone(1568,'sine',0.12,0.14,0.08)}
function soundClaim(){playTone(880,'sine',0.08,0.2);playTone(1046,'sine',0.08,0.2,0.1);playTone(1318,'sine',0.15,0.2,0.2);playTone(1568,'sine',0.3,0.25,0.35)}
function soundKeypad(){playTone(1000,'square',0.04,0.08)}
function toggleSound(){ soundEnabled=!soundEnabled; const btn=document.getElementById('sound-toggle-btn'); btn.textContent=soundEnabled?'üîä Enabled':'üîá Disabled'; btn.classList.toggle('on',soundEnabled); }

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Socket configured with aggressive reconnection so silent drops are recovered
const socket = io({
  autoConnect: false,
  reconnection: true,
  reconnectionAttempts: Infinity,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 10000,
  timeout: 20000,
});
let myUsername=null, myColor='#000080', myCoins=0, selectedTheme='classic';
let currentRoom='general', pendingRoom=null, usersVisible=false, isTyping=false, typingTimer;
let myToken=null; // stored so we can re-auth after reconnect
const unreadCounts={}, polls={};
let shopItems=[], selectedSettingsColor='#000080', selectedSettingsTheme='classic';

// Keypad state
let keypadRoom=null, keypadCode='';
// Changepass pending
let pendingChangepass=null;
// Owner room codes: roomName -> code (populated from server on rooms list + room created events)
const ownerRoomCodes={};

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function formatNumber(n){if(n===null||n===undefined)return'0';const num=Number(n);if(Number.isNaN(num))return String(n);return num.toLocaleString()}
function updateCoinDisplay(){document.getElementById('coin-display').textContent=`ü™ô ${formatNumber(myCoins)}`}
function formatDuration(ms){const t=Math.floor(ms/1000),d=Math.floor(t/86400),h=Math.floor((t%86400)/3600),m=Math.floor((t%3600)/60),s=t%60;if(d>0)return d+"D "+h+"HR "+m+"M";if(h>0)return h+"HR "+m+"M";if(m>0)return m+"M "+s+"S";return s+"S"}
function formatSeconds(s){if(s<60)return s+'s';if(s<3600)return Math.floor(s/60)+'m';if(s<86400)return Math.floor(s/3600)+'h '+Math.floor((s%3600)/60)+'m';return Math.floor(s/86400)+'d '+Math.floor((s%86400)/3600)+'h'}
function formatTime(ts){return new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function formatDate(d){return new Date(d).toLocaleDateString([],{year:'numeric',month:'short',day:'numeric'})}

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyTheme(theme){document.body.className=document.body.className.replace(/theme-\w+/g,'').trim();if(theme!=='classic')document.body.classList.add('theme-'+theme);selectedTheme=theme}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab){
  document.querySelectorAll('.auth-tab').forEach((t,i)=>t.classList.toggle('active',(i===0)===(tab==='login')));
  document.getElementById('login-panel').classList.toggle('active',tab==='login');
  document.getElementById('register-panel').classList.toggle('active',tab==='register');
}
fetch('/user-count').then(r=>r.json()).then(d=>{
  if(d.count) document.getElementById('auth-user-count').textContent=`üë• ${d.count} registered user${d.count===1?'':'s'}`;
}).catch(()=>{});

async function doLogin(){
  const u=document.getElementById('login-username').value.trim(),p=document.getElementById('login-password').value,e=document.getElementById('login-error');
  e.textContent='';if(!u||!p){e.textContent='Please fill in all fields.';return;}
  const res=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  const data=await res.json();if(!res.ok){e.textContent=data.error;return;}
  enterChat(data.username,data.color||'#000080',data.theme||'classic',data.coins||0,data.token,data.dailyAvailable);
}
async function doRegister(){
  const u=document.getElementById('reg-username').value.trim(),p=document.getElementById('reg-password').value,p2=document.getElementById('reg-password2').value,e=document.getElementById('register-error');
  e.textContent='';if(!u||!p||!p2){e.textContent='Please fill in all fields.';return;}if(p!==p2){e.textContent='Passwords do not match.';return;}
  const res=await fetch('/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u,password:p})});
  const data=await res.json();if(!res.ok){e.textContent=data.error;return;}
  enterChat(data.username,data.color||'#000080',data.theme||'classic',data.coins||100,data.token,false);
}
async function doLogout(){await fetch('/logout',{method:'POST'});socket.disconnect();location.reload()}

function enterChat(username,color,theme,coins,token,dailyAvailable){
  myUsername=username;myColor=color||'#000080';myCoins=coins||0;myToken=token;
  applyTheme(theme||'classic');
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('chat-screen').style.display='block';
  const colorInfo=SHOP_COLORS[myColor];const effectClass=colorInfo?` user-${colorInfo.effect}`:'';document.getElementById('logged-in-as').innerHTML=`<span class="${effectClass}" style="color:${myColor};text-shadow:0 0 2px rgba(255,255,255,0.5)">${username}</span>`;
  updateCoinDisplay();
  document.getElementById('input').focus();
  socket.connect();
  if(dailyAvailable)setTimeout(()=>showDailyModal(),1500);
}

// ‚îÄ‚îÄ RECONNECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
socket.on('disconnect', (reason) => {
  // If the server explicitly kicked us (e.g. logged in elsewhere), don't reconnect
  if (reason === 'io server disconnect') return;
  document.getElementById('reconnect-banner').classList.add('visible');
  document.getElementById('input').disabled = true;
  document.getElementById('send-btn').disabled = true;
});

socket.on('connect', () => {
  document.getElementById('reconnect-banner').classList.remove('visible');
  document.getElementById('input').disabled = false;
  document.getElementById('send-btn').disabled = false;
  // Re-authenticate on every (re)connect so the server has our session
  if (myToken) socket.emit('join', myToken);
});

socket.on('reconnect', () => {
  // After reconnect, switch back to the room we were in
  if (currentRoom && currentRoom !== 'general') {
    socket.emit('switch room', { room: currentRoom });
  }
});

// ‚îÄ‚îÄ ROOMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRooms(rooms){
  const list=document.getElementById('rooms-list');list.innerHTML='';
  rooms.forEach(r=>{
    const name=typeof r==='string'?r:r.name;
    const isPrivate=typeof r==='object'&&r.isPrivate;
    const isOwner=typeof r==='object'&&r.isOwner;
    // Server sends ownerCode for rooms the user owns
    const serverCode=typeof r==='object'&&r.ownerCode?r.ownerCode:null;
    if(serverCode) ownerRoomCodes[name]=serverCode;

    const btn=document.createElement('button');
    btn.className='room-btn'+(name===currentRoom?' active':'');
    btn.dataset.room=name;
    btn.innerHTML=(isPrivate?'<span class="room-private-icon">üîí</span>':'')+`#${name}`;
    if(unreadCounts[name])btn.innerHTML+=`<span class="room-unread">${unreadCounts[name]}</span>`;
    btn.onclick=()=>switchRoom(name);
    list.appendChild(btn);
  });
}

function switchRoom(room){
  if(room===currentRoom||room===pendingRoom)return;
  pendingRoom=room;
  socket.emit('switch room',{room});
}

// ‚îÄ‚îÄ KEYPAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openKeypad(room){
  keypadRoom=room;keypadCode='';
  document.getElementById('keypad-room-label').textContent=`#${room}`;
  document.getElementById('keypad-error').textContent='';
  renderKeypadDots();
  document.getElementById('keypad-modal').classList.add('open');
}
function closeKeypad(){
  document.getElementById('keypad-modal').classList.remove('open');
  keypadRoom=null;keypadCode='';
  pendingRoom=null;
}
function renderKeypadDots(){
  const wrap=document.getElementById('keypad-dots');
  wrap.innerHTML='';
  const len=Math.max(keypadCode.length,1);
  for(let i=0;i<Math.min(len,9);i++){
    const d=document.createElement('div');
    d.className='keypad-dot'+(i<keypadCode.length?' filled':'');
    wrap.appendChild(d);
  }
}
function keypadPress(digit){
  if(keypadCode.length>=9)return;
  soundKeypad();
  keypadCode+=digit;
  document.getElementById('keypad-error').textContent='';
  renderKeypadDots();
}
function keypadClear(){
  if(!keypadCode.length)return;
  keypadCode=keypadCode.slice(0,-1);
  renderKeypadDots();
}
function keypadSubmit(){
  if(!keypadCode){document.getElementById('keypad-error').textContent='Enter a code first.';return;}
  pendingRoom=keypadRoom;
  socket.emit('switch room',{room:keypadRoom,code:keypadCode});
}
document.addEventListener('keydown',e=>{
  if(!document.getElementById('keypad-modal').classList.contains('open'))return;
  if(e.key>='0'&&e.key<='9')keypadPress(e.key);
  else if(e.key==='Backspace')keypadClear();
  else if(e.key==='Enter')keypadSubmit();
});

// ‚îÄ‚îÄ ROOM CREATED MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openRoomCreated(room,code){
  document.getElementById('rc-room-name').textContent=`#${room}`;
  document.getElementById('rc-room-code').textContent=code;
  document.getElementById('room-created-modal').classList.add('open');
}
function closeRoomCreated(){document.getElementById('room-created-modal').classList.remove('open');}

// ‚îÄ‚îÄ CHANGEPASS CONFIRM MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openChangepassConfirm(room,newCode){
  pendingChangepass={room,newCode};
  document.getElementById('cp-room-name').textContent=`#${room}`;
  document.getElementById('cp-new-code').textContent=newCode;
  document.getElementById('changepass-modal').classList.add('open');
}
function closeChangepass(){document.getElementById('changepass-modal').classList.remove('open');pendingChangepass=null;}
function confirmChangepass(){
  if(!pendingChangepass)return;
  socket.emit('confirm changepass',pendingChangepass);
  closeChangepass();
}

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function send(){const input=document.getElementById('input'),text=input.value.trim();if(!text)return;socket.emit('chat message',text);input.value='';stopTyping()}

// ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('input').addEventListener('input',()=>{socket.emit('activity');if(!isTyping){isTyping=true;socket.emit('typing start')}clearTimeout(typingTimer);typingTimer=setTimeout(stopTyping,2000)});
function stopTyping(){if(!isTyping)return;isTyping=false;clearTimeout(typingTimer);socket.emit('typing stop')}
function toggleUsers(){usersVisible=!usersVisible;document.getElementById('users-panel').classList.toggle('visible',usersVisible)}

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addMessage(html, extraClass='', timestamp=null, msgId=null){
  const messages=document.getElementById('messages');
  const atBottom=messages.scrollHeight-messages.scrollTop-messages.clientHeight<40;
  const li=document.createElement('li');li.style.listStyle='none';
  li.className='msg-row'+(extraClass?' '+extraClass:'');
  if(msgId) li.dataset.msgId=msgId;
  const ts=timestamp?`<span class="msg-ts">${formatTime(timestamp)}</span>`:'';
  const reactBtn=msgId?`<button class="msg-react-btn" title="React">+<div class="react-picker"><span class="react-emoji" data-emoji="üëç">üëç</span><span class="react-emoji" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span><span class="react-emoji" data-emoji="üòÇ">üòÇ</span><span class="react-emoji" data-emoji="üòÆ">üòÆ</span></div></button>`:'';
  li.innerHTML=html+ts+reactBtn;
  messages.appendChild(li);
  if(atBottom)messages.scrollTop=messages.scrollHeight;
  return li;
}

// Room unread badge updater
function updateRoomBadge(room){
  const btn = document.querySelector(`.room-btn[data-room="${room}"]`);
  if (!btn) return;
  // remove existing badge
  const existing = btn.querySelector('.room-unread');
  if (existing) existing.remove();
  const count = unreadCounts[room] || 0;
  if (count > 0) {
    const span = document.createElement('span');
    span.className = 'room-unread';
    span.textContent = count>99? '99+' : count;
    btn.appendChild(span);
  }
}

function addDmMessage(data){
  const messages=document.getElementById('messages');
  const atBottom=messages.scrollHeight-messages.scrollTop-messages.clientHeight<40;
  const li=document.createElement('li');li.style.listStyle='none';
  li.className='msg-row msg-dm-row'+(!data.noFlash&&!data.self?' dm-flash':'');
  const label=data.self?`<span class="msg-dm-label">‚Üí DM to ${data.to}:</span>`:`<span class="msg-dm-label">DM from ${data.from}:</span>`;
  li.innerHTML=label+`<span class="msg-text">${data.text}</span>`;
  messages.appendChild(li);
  if(atBottom)messages.scrollTop=messages.scrollHeight;
  if(!data.noFlash&&!data.self)soundDM();
}

// Highlight mentions in general chat messages when added
const origAddMessage = addMessage;
addMessage = function(html, extraClass='', timestamp=null, msgId=null){
  // detect mention of current user
  const temp = document.createElement('div'); temp.innerHTML = html;
  const msgTextEl = temp.querySelector('.msg-text');
  const msgText = msgTextEl ? msgTextEl.textContent : temp.textContent || '';
  const mentionRegex = myUsername ? new RegExp(`@${myUsername.replace(/[.*+?^${}()|[\\]\\]/g,'\\\\$&')}\\b`, 'i') : null;
  const willMention = mentionRegex && mentionRegex.test(msgText);
  const li = origAddMessage(html, extraClass, timestamp, msgId);
  if (willMention) {
    li.classList.add('msg-mention');
    playTone(880,'square',0.06,0.18);
  }
  return li;
}

document.getElementById('messages').addEventListener('click',e=>{
  const emojiBtn=e.target.closest('.react-emoji');
  if(emojiBtn){const li=emojiBtn.closest('.msg-row');if(li&&li.dataset.msgId)socket.emit('react',{messageId:parseInt(li.dataset.msgId),emoji:emojiBtn.dataset.emoji});return;}
  const pill=e.target.closest('.reaction-pill');
  if(pill){const li=pill.closest('.msg-row');if(!li||!li.dataset.msgId)return;const emoji=pill.dataset.emoji,myReaction=li.dataset.myReaction;if(myReaction===emoji)socket.emit('unreact',{messageId:parseInt(li.dataset.msgId)});else socket.emit('react',{messageId:parseInt(li.dataset.msgId),emoji});return;}
  const opt=e.target.closest('.poll-option');
  if(opt&&!opt.classList.contains('concluded')){const pollId=parseInt(opt.dataset.poll),option=opt.dataset.opt;if(pollId&&option)socket.emit('poll vote',{pollId,option});return;}
  const userEl=e.target.closest('.msg-user');
  if(userEl&&userEl.dataset.username)openProfile(userEl.dataset.username);
});

function updateReactions(li,reactions,myReaction){
  let wrap=li.querySelector('.msg-reactions');
  if(!wrap){wrap=document.createElement('div');wrap.className='msg-reactions';li.appendChild(wrap)}
  wrap.innerHTML='';li.dataset.myReaction=myReaction||'';
  Object.entries(reactions).forEach(([emoji,count])=>{
    if(count<=0)return;
    const pill=document.createElement('span');pill.className='reaction-pill'+(myReaction===emoji?' selected':'');pill.dataset.emoji=emoji;
    pill.innerHTML=`${emoji}<span class="r-count">${count}</span>`;wrap.appendChild(pill);
  });
}

// ‚îÄ‚îÄ POLLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPoll(poll){
  polls[poll.id]=poll;const existing=document.getElementById(`poll-${poll.id}`);
  if(existing){existing.innerHTML=buildPollHtml(poll);return}
  const messages=document.getElementById('messages');const atBottom=messages.scrollHeight-messages.scrollTop-messages.clientHeight<40;
  const li=document.createElement('li');li.style.listStyle='none';li.id=`poll-${poll.id}`;li.className='msg-row';li.innerHTML=buildPollHtml(poll);
  messages.appendChild(li);if(atBottom)messages.scrollTop=messages.scrollHeight;
}
function buildPollHtml(poll){
  const totalVotes=Object.keys(poll.votes||{}).length,myVote=(poll.votes||{})[myUsername],concluded=poll.concluded;
  let topCount=0;
  if(concluded&&totalVotes>0){const tally={};poll.options.forEach(o=>tally[o]=0);Object.values(poll.votes||{}).forEach(v=>{if(tally[v]!==undefined)tally[v]++});topCount=Math.max(...Object.values(tally))}
  const optionsHtml=poll.options.map(opt=>{
    const count=Object.values(poll.votes||{}).filter(v=>v===opt).length,pct=totalVotes>0?Math.round((count/totalVotes)*100):0;
    const isVoted=myVote===opt,isWinner=concluded&&totalVotes>0&&count===topCount;
    const classes=['poll-option',isVoted?'voted':'',concluded?'concluded':'',isWinner?'winner':''].filter(Boolean).join(' ');
    return `<div class="${classes}" data-poll="${poll.id}" data-opt="${escHtml(opt)}"><span class="poll-opt-label">${isWinner?'üèÜ ':''}${escHtml(opt)}</span><div class="poll-bar-wrap"><div class="poll-bar" style="width:${pct}%"></div></div><span class="poll-pct">${pct}%</span><span style="font-size:13px;color:var(--text-system)">${count}</span></div>`;
  }).join('');
  let timerHtml='';
  if(!concluded&&poll.endsAt)timerHtml=`<span class="poll-timer" data-ends="${new Date(poll.endsAt).getTime()}">...</span>`;
  else if(concluded)timerHtml=`<span style="color:var(--text-system)">concluded</span>`;
  return `<div class="poll-card${concluded?' poll-concluded':''}"><div class="poll-question">üìä ${escHtml(poll.question)}</div>${optionsHtml}<div class="poll-meta">by ${escHtml(poll.creator)} ¬∑ ${totalVotes} vote${totalVotes!==1?'s':''} ¬∑ ${timerHtml}</div></div>`;
}

// ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistory(history){
  const messages=document.getElementById('messages');messages.innerHTML='';
  if(!history.length)return;
  addMessage(`<span class="msg-system">‚îÄ‚îÄ message history ‚îÄ‚îÄ</span>`);
  history.forEach(row=>{
    const ts=new Date(row.created_at).getTime();
    const colorInfo=SHOP_COLORS[row.color];const effectClass=colorInfo?` user-${colorInfo.effect}`:'';
    if(row.type==='poll'){
      const poll=row.poll_data;
      if(!poll)return;
      polls[poll.id]=poll;
      const msgEl=document.getElementById('messages');
      const atBottom=msgEl.scrollHeight-msgEl.scrollTop-msgEl.clientHeight<40;
      const li=document.createElement('li');li.style.listStyle='none';
      li.id=`poll-${poll.id}`;li.className='msg-row';li.innerHTML=buildPollHtml(poll);
      msgEl.appendChild(li);if(atBottom)msgEl.scrollTop=msgEl.scrollHeight;
    } else if(row.type==='system'){
      addMessage(`<span class="msg-system">*** ${row.text} ***</span>`,'',ts);
    } else if(row.type==='action'){
      addMessage(`<span class="msg-action">*** <span class="msg-user${effectClass}" data-username="${escHtml(row.sender)}" style="color:${row.color}">${row.sender}</span> ${row.text} ***</span>`,'',ts);
    } else if(row.type==='dm'){
      addDmMessage({from:row.sender,to:row.recipient,text:row.text,self:row.sender===myUsername,noFlash:true});
    } else {
      const li=addMessage(`<span class="msg-user${effectClass}" data-username="${escHtml(row.sender)}" style="color:${row.color}">${row.sender}:</span> <span class="msg-text">${row.text}</span>`,row.sender===myUsername?'msg-own':'',ts,row.id);
      if(row.reactions&&Object.keys(row.reactions).length)updateReactions(li,row.reactions,null);
    }
  });
  addMessage(`<span class="msg-system">‚îÄ‚îÄ live ‚îÄ‚îÄ</span>`);
  messages.scrollTop=messages.scrollHeight;
}

// ‚îÄ‚îÄ SOCKET EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
socket.on('rooms list',rooms=>renderRooms(rooms));

socket.on('room changed',room=>{
  currentRoom=room;
  pendingRoom=null;
  unreadCounts[room]=0;
  updateRoomBadge(room);
  document.getElementById('messages').innerHTML='';
  if(document.getElementById('keypad-modal').classList.contains('open'))closeKeypad();
  document.querySelectorAll('.room-btn').forEach(b=>b.classList.toggle('active',b.dataset.room===room));
});

socket.on('history', history => {
  // Ensure previous room messages are cleared before rendering new history
  document.getElementById('messages').innerHTML = '';
  renderHistory(history);
});

socket.on('room requires code',room=>{
  pendingRoom=room;
  openKeypad(room);
});

socket.on('keypad error',msg=>{
  document.getElementById('keypad-error').textContent=msg||'Wrong code.';
  keypadCode='';renderKeypadDots();
  playTone(200,'sawtooth',0.15,0.15);
});

socket.on('confirm changepass',({room,newCode})=>{openChangepassConfirm(room,newCode)});

socket.on('room code changed',({room,newCode})=>{
  ownerRoomCodes[room]=String(newCode);
  // Update badge in sidebar if present
  document.querySelectorAll(`[data-room-code-for="${room}"]`).forEach(el=>{
    el.textContent=`code: ${newCode}`;
  });
  addMessage(`<span class="msg-system">‚úÖ Room code changed to: ${newCode}</span>`);
});

socket.on('room created',({room,code})=>{
  ownerRoomCodes[room]=String(code);
  openRoomCreated(room,code);
});

socket.on('chat message',({id,user,color,text,type,timestamp})=>{
  const isOwn=user===myUsername;const colorInfo=SHOP_COLORS[color];const effectClass=colorInfo?` user-${colorInfo.effect}`:'';
  if(type==='action')addMessage(`<span class="msg-action">*** <span class="msg-user${effectClass}" data-username="${escHtml(user)}" style="color:${color}">${user}</span> ${text} ***</span>`,'',timestamp);
  else {
    addMessage(`<span class="msg-user${effectClass}" data-username="${escHtml(user)}" style="color:${color}">${user}:</span> <span class="msg-text">${text}</span>`,isOwn?'msg-own':'',timestamp||Date.now(),id);
    // If message from someone else in another room will be notified by 'room message'.
  }
  if(!isOwn)soundMessage();
});

socket.on('room message', ({room, user}) => {
  try{
    if (!myUsername) return;
    if (room === currentRoom) return; // visible already
    if (user && user.toLowerCase() === myUsername.toLowerCase()) return; // ignore own messages
    unreadCounts[room] = (unreadCounts[room] || 0) + 1;
    updateRoomBadge(room);
  }catch(e){}
});

socket.on('system message',msg=>{
  const isClaim=msg.includes('TYPE "claim"')||msg.includes('claimed the reward');
  if(isClaim){addMessage(`<span class="msg-claim-event">*** ${msg} ***</span>`);if(msg.includes('TYPE "claim"'))soundClaim();else if(msg.includes('claimed the reward')&&msg.includes(myUsername))soundWin();}
  else{addMessage(`<span class="msg-system">*** ${msg} ***</span>`);if(/has joined/.test(msg))soundJoin();else if(/has left/.test(msg))soundLeave();}
});

socket.on('announcement',({from,message})=>{
  document.getElementById('announcement-content').textContent=message;
  if(from&&from.toLowerCase()==='mce')document.getElementById('announcement-content').textContent=`Admin: ${message}`;
  document.getElementById('announcement-modal').classList.add('open');
  soundClaim();
});

socket.on('dm',data=>addDmMessage(data));
socket.on('coins update',({coins})=>{myCoins=coins;updateCoinDisplay();updateGameBalances()});

socket.on('reaction update',({messageId,reactions})=>{
  const li=document.querySelector(`[data-msg-id="${messageId}"]`);
  if(!li)return;updateReactions(li,reactions,li.dataset.myReaction||null);
});

socket.on('link preview',({url,title,image,description})=>{
  const messages=document.getElementById('messages');
  const rows=messages.querySelectorAll('.msg-row');let target=null;
  for(let i=rows.length-1;i>=0;i--){if(rows[i].textContent.includes(url.slice(8,40))){target=rows[i];break}}
  const previewEl=document.createElement('div');previewEl.className='link-preview';
  let html='';if(image)html+=`<img src="${image}" alt="" onerror="this.style.display='none'">`;if(title)html+=`<div class="lp-title">${title}</div>`;if(description)html+=`<div class="lp-desc">${description}</div>`;
  previewEl.innerHTML=html;
  const atBottom=messages.scrollHeight-messages.scrollTop-messages.clientHeight<40;
  if(target)target.appendChild(previewEl);else{const li=document.createElement('li');li.style.listStyle='none';li.appendChild(previewEl);messages.appendChild(li)}
  if(atBottom)messages.scrollTop=messages.scrollHeight;
});

socket.on('poll update',poll=>renderPoll(poll));
socket.on('poll concluded',({pollId})=>{if(polls[pollId]){polls[pollId].concluded=true;const el=document.getElementById(`poll-${pollId}`);if(el)el.innerHTML=buildPollHtml(polls[pollId]);soundPollEnd()}});

socket.on('user list',list=>{
  document.getElementById('user-count-text').textContent=list.length;
  const panel=document.getElementById('users-panel');panel.innerHTML='';
  list.forEach(({username,color,joinedAt,idle})=>{
    const entry=document.createElement('span');entry.className='user-entry';entry.dataset.joinedAt=joinedAt;
    const colorInfo=SHOP_COLORS[color];const effectClass=colorInfo?` user-${colorInfo.effect}`:'';
    entry.innerHTML=`<span class="uname${effectClass}" style="color:${color}" data-username="${escHtml(username)}" onclick="openProfile('${escHtml(username)}')">${username}</span>${idle?'<span class="uidle">‚è∏</span>':''}<span class="utime">${formatDuration(Date.now()-joinedAt)}</span>`;
    panel.appendChild(entry);
    if(username===myUsername){myColor=color;const colorInfo=SHOP_COLORS[color];const effectClass=colorInfo?` user-${colorInfo.effect}`:'';document.getElementById('logged-in-as').innerHTML=`<span class="${effectClass}" style="color:${color};text-shadow:0 0 2px rgba(255,255,255,0.5)">${myUsername}</span>`;}
  });
});

socket.on('typing',({text})=>{const bar=document.getElementById('typing-bar');bar.innerHTML=text?text+' <span class="dots"><span></span><span></span><span></span></span>':''});
socket.on('kicked',reason=>{
  addMessage(`<span class="msg-kicked">‚ö† ${reason||'You were signed in from another device.'}</span>`);
  document.getElementById('input').disabled=true;
  document.getElementById('send-btn').disabled=true;
  // Prevent auto-reconnect when explicitly kicked
  socket.disconnect();
});

// ‚îÄ‚îÄ DAILY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showDailyModal(){document.getElementById('daily-modal').classList.add('open')}
function closeDailyModal(){document.getElementById('daily-modal').classList.remove('open')}
async function claimDaily(){
  try{const res=await fetch('/daily',{method:'POST',credentials:'include'});const data=await res.json();if(!res.ok){closeDailyModal();return}
  myCoins=data.coins;updateCoinDisplay();soundCoin();soundWin();closeDailyModal();addMessage(`<span class="msg-system">Daily reward claimed! +${formatNumber(data.reward)} coins. Balance: ${formatNumber(data.coins)} ü™ô</span>`)}catch{closeDailyModal()}
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openProfile(username){
  document.getElementById('profile-modal-title').textContent=username+"'s Profile";
  document.getElementById('profile-modal-body').innerHTML='<div style="text-align:center;padding:20px;color:var(--text-system);">Loading...</div>';
  document.getElementById('profile-modal').classList.add('open');
  try{
    const res=await fetch(`/profile/${encodeURIComponent(username)}`,{credentials:'include'});
    const d=await res.json();if(!res.ok){document.getElementById('profile-modal-body').textContent=d.error;return}
    const badge=d.activeBadge?`<span title="${d.activeBadge.name}">${d.activeBadge.emoji} ${d.activeBadge.name}</span>`:'<span style="color:var(--text-system)">No badge</span>';
    const badgesHtml=d.earnedBadges.length?d.earnedBadges.map(b=>`<span title="${b.description}" style="font-size:20px;cursor:help">${b.emoji}</span>`).join(' '):'<span style="color:var(--text-system);font-size:14px">No badges yet</span>';
    const colorInfo=SHOP_COLORS[d.color];const effectClass=colorInfo?` user-${colorInfo.effect}`:'';
    document.getElementById('profile-modal-body').innerHTML=`
      <div class="profile-header"><div class="profile-avatar">üë§</div><div><div class="profile-name${effectClass}" style="color:${d.color||'var(--text-main)'}">${escHtml(d.username)}</div><div class="profile-badge-display">${badge}</div></div></div>
      <div class="profile-stats">
          <div class="stat-row"><span class="stat-label">Joined</span><span class="stat-value">${formatDate(d.createdAt)}</span></div>
          <div class="stat-row"><span class="stat-label">Coins</span><span class="stat-value">ü™ô ${formatNumber(d.coins)}</span></div>
          <div class="stat-row"><span class="stat-label">Messages sent</span><span class="stat-value">${d.messagesSent}</span></div>
          <div class="stat-row"><span class="stat-label">Time online</span><span class="stat-value">${formatSeconds(d.timeOnlineSeconds)}</span></div>
        </div>
      <div style="font-size:15px;margin-bottom:4px;">Badges earned:</div>
      <div style="padding:4px 0">${badgesHtml}</div>`;
  }catch{document.getElementById('profile-modal-body').textContent='Error loading profile.'}
}
function closeProfile(){document.getElementById('profile-modal').classList.remove('open')}
document.getElementById('profile-modal').addEventListener('click',e=>{if(e.target===document.getElementById('profile-modal'))closeProfile()});

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchSettingsTab(tab){
  document.querySelectorAll('.stab').forEach((t,i)=>{const tabs=['appearance','badges','stats','account','help'];t.classList.toggle('active',tabs[i]===tab)});
  document.querySelectorAll('.stab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('stab-'+tab).classList.add('active');
  if(tab==='stats')loadStats();if(tab==='badges')loadBadges();
}
async function openSettings(){
  document.getElementById('settings-overlay').classList.add('open');
  document.getElementById('settings-status').textContent='';
  selectedSettingsColor=myColor;selectedSettingsTheme=selectedTheme;
  if(shopItems.length===0)await loadShopItems();
  renderSettingsThemes();renderSettingsColors();
}
function closeSettings(){document.getElementById('settings-overlay').classList.remove('open')}
document.getElementById('settings-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('settings-overlay'))closeSettings()});

function renderSettingsThemes(){
  const ownedThemes=shopItems.filter(i=>i.type==='theme'&&i.owned);
  const wrap=document.getElementById('settings-theme-options');wrap.innerHTML='';
  ownedThemes.forEach(item=>{
    const btn=document.createElement('button');btn.className=`theme-btn theme-opt-${item.value}${item.value===selectedSettingsTheme?' selected':''}`;btn.textContent=item.name;
    btn.onclick=()=>{selectedSettingsTheme=item.value;wrap.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');applyTheme(item.value)};
    wrap.appendChild(btn);
  });
  if(!ownedThemes.length)wrap.innerHTML='<span style="font-size:14px;color:var(--text-system)">No themes owned. Visit üõí Shop!</span>';
}
function renderSettingsColors(){
  const ownedColors=shopItems.filter(i=>i.type==='color'&&i.owned);
  const wrap=document.getElementById('settings-color-swatches');wrap.innerHTML='';
  ownedColors.forEach(item=>{
    const div=document.createElement('div');div.className='color-swatch'+(item.value===selectedSettingsColor?' selected':'');
    const preview=document.createElement('div');preview.className='color-preview';preview.style.background=item.value;
    const name=document.createElement('div');name.className='color-name';name.textContent=item.name;
    const check=document.createElement('div');check.className='color-checkmark';check.textContent=item.value===selectedSettingsColor?'‚úì':'';
    div.appendChild(preview);div.appendChild(name);div.appendChild(check);
    div.onclick=()=>{selectedSettingsColor=item.value;wrap.querySelectorAll('.color-swatch').forEach(s=>{s.classList.remove('selected');s.querySelector('.color-checkmark').textContent=''});div.classList.add('selected');div.querySelector('.color-checkmark').textContent='‚úì'};
    wrap.appendChild(div);
  });
}
async function saveSettings(){
  const statusEl=document.getElementById('settings-status');statusEl.textContent='Saving...';statusEl.style.color='inherit';
  try{const res=await fetch('/settings',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({color:selectedSettingsColor,theme:selectedSettingsTheme})});
  const data=await res.json();if(!res.ok){statusEl.textContent=data.error;statusEl.style.color='#cc0000';return}
  myColor=selectedSettingsColor;const colorInfo=SHOP_COLORS[myColor];const effectClass=colorInfo?` user-${colorInfo.effect}`:'';document.getElementById('logged-in-as').innerHTML=`<span class="${effectClass}" style="color:${myColor};text-shadow:0 0 2px rgba(255,255,255,0.5)">${myUsername}</span>`;
  socket.emit('color update',myColor);
  statusEl.textContent='Saved!';statusEl.style.color='#007700';setTimeout(()=>{statusEl.textContent=''},2000)}catch{statusEl.textContent='Error saving.';statusEl.style.color='#cc0000'}
}

async function changePassword(){
  const statusEl = document.getElementById('pw-status');
  const oldP = document.getElementById('pw-old').value;
  const newP = document.getElementById('pw-new').value;
  const newP2 = document.getElementById('pw-new2').value;
  statusEl.textContent = 'Changing...'; statusEl.style.color = 'inherit';
  try{
    const res = await fetch('/settings/password', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ oldPassword: oldP, newPassword: newP, newPassword2: newP2 }) });
    const data = await res.json();
    if (!res.ok) { statusEl.textContent = data.error || 'Error'; statusEl.style.color = '#cc0000'; return; }
    statusEl.textContent = 'Password changed!'; statusEl.style.color = '#007700';
    document.getElementById('pw-old').value='';document.getElementById('pw-new').value='';document.getElementById('pw-new2').value='';
    setTimeout(()=>{ statusEl.textContent=''; }, 2500);
  } catch (err) { statusEl.textContent='Server error'; statusEl.style.color='#cc0000'; }
}

// ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadBadges(){
  const grid=document.getElementById('badge-grid');grid.innerHTML='<div style="color:var(--text-system);font-size:14px">Loading...</div>';
  try{
    const res=await fetch('/stats',{credentials:'include'});const data=await res.json();if(!res.ok)return;
    const earnedIds=new Set(data.earnedBadges.map(b=>b.id));const activeBadgeId=data.activeBadge?.id||null;
    const allBadges=[
      {id:'lurker_no_more',emoji:'üí¨',name:'Lurker No More',description:'Send 10 messages'},
      {id:'regular',emoji:'üó£Ô∏è',name:'Regular',description:'Send 50 messages'},
      {id:'chatterbox',emoji:'üì¢',name:'Chatterbox',description:'Send 100 messages'},
      {id:'motormouth',emoji:'üîä',name:'Motormouth',description:'Send 500 messages'},
      {id:'legendary',emoji:'üëë',name:'Legendary',description:'Send 1,000 messages'},
      {id:'feeling_lucky',emoji:'üé≤',name:'Feeling Lucky',description:'Place your first gamble'},
      {id:'high_roller',emoji:'üí∞',name:'High Roller',description:'Win over 1,000 coins at once'},
      {id:'loaded',emoji:'ü§ë',name:'Loaded',description:'Earn 5,000 coins total'},
      {id:'whale',emoji:'üêã',name:'Whale',description:'Earn 10,000 coins total'},
      {id:'tycoon',emoji:'üíé',name:'Tycoon',description:'Earn 50,000 coins total'},
      {id:'mogul',emoji:'üèÜ',name:'Mogul',description:'Earn 100,000 coins total'},
    ];
    grid.innerHTML='';
    allBadges.forEach(b=>{
      const earned=earnedIds.has(b.id),isActive=b.id===activeBadgeId;
      const div=document.createElement('div');div.className='badge-item'+(earned?' earned':'  locked')+(isActive?' active-badge':'');
      div.innerHTML=`<span class="badge-emoji">${b.emoji}</span><div class="badge-name">${b.name}</div><div class="badge-desc">${b.description}</div>${isActive?'<div class="badge-active-label">‚òÖ Active showcase</div>':''}`;
      if(earned){div.onclick=()=>setActiveBadge(b.id,data.activeBadge?.id)}
      grid.appendChild(div);
    });
  }catch{document.getElementById('badge-grid').innerHTML='<div style="color:#cc0000">Error loading badges.</div>'}
}
async function setActiveBadge(badgeId,currentActiveId){
  const newId=badgeId===currentActiveId?null:badgeId;
  try{
    const res=await fetch('/badge/set',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({badgeId:newId})});
    const data=await res.json();const statusEl=document.getElementById('badge-status');
    if(!res.ok){statusEl.textContent=data.error;statusEl.style.color='#cc0000';return}
    statusEl.textContent=newId?'Badge set as showcase!':'Badge removed.';statusEl.style.color='#007700';
    setTimeout(()=>{statusEl.textContent=''},2000);loadBadges();
  }catch{}
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStats(){
  const el=document.getElementById('stats-content');el.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-system);">Loading...</div>';
  try{
    const res=await fetch('/stats',{credentials:'include'});const d=await res.json();if(!res.ok){el.textContent=d.error;return}
    el.innerHTML=`
      <div class="stat-row"><span class="stat-label">Username</span><span class="stat-value" style="color:${myColor}">${escHtml(d.username)}</span></div>
      <div class="stat-row"><span class="stat-label">Member since</span><span class="stat-value">${formatDate(d.createdAt)}</span></div>
      <div class="stat-row"><span class="stat-label">Current coins</span><span class="stat-value">ü™ô ${formatNumber(d.coins)}</span></div>
      <div class="stat-row"><span class="stat-label">Total earned</span><span class="stat-value">ü™ô ${formatNumber(d.coinsEarned)}</span></div>
      <div class="stat-row"><span class="stat-label">Total spent</span><span class="stat-value">ü™ô ${formatNumber(d.coinsSpent)}</span></div>
      <div class="stat-row"><span class="stat-label">Messages sent</span><span class="stat-value">${d.messagesSent}</span></div>
      <div class="stat-row"><span class="stat-label">Time online</span><span class="stat-value">${formatSeconds(d.timeOnlineSeconds)}</span></div>
      <div class="stat-row"><span class="stat-label">Badges earned</span><span class="stat-value">${d.earnedBadges.length}</span></div>
      <div style="font-size:12px;color:var(--text-system);margin-top:8px;text-align:center;">Stats tracked from Feb 2026</div>`;
  }catch{el.textContent='Error loading stats.'}
}

// ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openShop(){document.getElementById('shop-overlay').classList.add('open');document.getElementById('shop-balance').textContent=`Balance: ü™ô ${formatNumber(myCoins)}`;document.getElementById('shop-status').textContent='';await loadShopItems()}
function closeShop(){document.getElementById('shop-overlay').classList.remove('open')}
function switchShopTab(tab){document.querySelectorAll('.shop-tab').forEach(t=>t.classList.toggle('active',t.textContent.toLowerCase().includes(tab==='themes'?'theme':'colour')));document.getElementById('shop-themes').classList.toggle('active',tab==='themes');document.getElementById('shop-colors').classList.toggle('active',tab==='colors')}
async function loadShopItems(){try{const res=await fetch('/shop',{credentials:'include'});shopItems=await res.json();renderShopThemes();renderShopColors()}catch{document.getElementById('shop-status').textContent='Error loading shop.';document.getElementById('shop-status').className='shop-status err'}}
function renderShopThemes(){document.getElementById('shop-themes').innerHTML=`<div class="shop-grid">${shopItems.filter(i=>i.type==='theme').map(shopItemHtml).join('')}</div>`}
function renderShopColors(){document.getElementById('shop-colors').innerHTML=`<div class="shop-grid">${shopItems.filter(i=>i.type==='color').map(shopItemHtml).join('')}</div>`}
function shopItemHtml(item){
  const priceLabel=item.price===0?`<span class="shop-item-price free">FREE</span>`:`<span class="shop-item-price">ü™ô ${formatNumber(item.price)}</span>`;
  const badge=item.owned?`<span class="shop-item-owned-badge">‚úì OWNED</span>`:'';
  const btn=item.owned?`<button class="shop-buy-btn" disabled>Owned</button>`:`<button class="shop-buy-btn" onclick="buyItem('${item.id}')">Buy ${item.price===0?'(Free)':`ü™ô ${formatNumber(item.price)}`}</button>`;
  return `<div class="shop-item${item.owned?' owned':''}" id="shop-item-${item.id}">${badge}<div class="shop-item-swatch" style="background:${item.preview}"></div><div class="shop-item-name">${escHtml(item.name)}</div><div class="shop-item-desc">${escHtml(item.description||'')}</div>${priceLabel}${btn}</div>`;
}
async function buyItem(itemId){
  const statusEl=document.getElementById('shop-status');statusEl.textContent='Purchasing...';statusEl.className='shop-status';
  try{const res=await fetch('/shop/buy',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({itemId})});
  const data=await res.json();if(!res.ok){statusEl.textContent=data.error;statusEl.className='shop-status err';return}
  myCoins=data.coins;updateCoinDisplay();document.getElementById('shop-balance').textContent=`Balance: ü™ô ${formatNumber(myCoins)}`;
  const idx=shopItems.findIndex(i=>i.id===itemId);if(idx>=0)shopItems[idx].owned=true;
  renderShopThemes();renderShopColors();statusEl.textContent=`‚úì Purchased ${data.item.name}!`;statusEl.className='shop-status';soundCoin()}catch{statusEl.textContent='Purchase failed.';statusEl.className='shop-status err'}
}
document.getElementById('shop-overlay').addEventListener('click',e=>{if(e.target===document.getElementById('shop-overlay'))closeShop()});

// ‚îÄ‚îÄ GAMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openGames(){updateGameBalances();document.getElementById('games-overlay').classList.add('open');loadLeaderboard()}
function closeGames(){document.getElementById('games-overlay').classList.remove('open')}
function openPatchNotes(){document.getElementById('patchnotes-modal').classList.add('open')}
function closePatchNotes(){document.getElementById('patchnotes-modal').classList.remove('open')}
function closeAnnouncement(){document.getElementById('announcement-modal').classList.remove('open')}
function switchGame(name){document.querySelectorAll('.game-panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.games-tab').forEach(t=>t.classList.remove('active'));document.getElementById('game-'+name).classList.add('active');document.querySelectorAll('.games-tab').forEach(t=>{if(t.textContent.toLowerCase().includes(name==='leaderboard'?'board':name))t.classList.add('active')});if(name==='leaderboard')loadLeaderboard();if(name==='roulette')initRouletteNumbers();updateGameBalances()}
function updateGameBalances(){['slots','dice','roulette'].forEach(g=>{const el=document.getElementById(g+'-balance');if(el)el.textContent=`Balance: ü™ô ${formatNumber(myCoins)}`})}
function setBet(game,amount){document.getElementById(game+'-bet').value=amount}

let slotsSpinning=false;
async function playSlots(){
  if(slotsSpinning)return;const bet=parseInt(document.getElementById('slots-bet').value,10);
  if(!bet||bet<1||bet>50000){document.getElementById('slots-result').innerHTML='<span class="result-lose">Bet must be 1-50000</span>';return}
  slotsSpinning=true;const btn=document.getElementById('slots-spin-btn');btn.disabled=true;document.getElementById('slots-result').textContent='';
  [0,1,2].forEach(i=>document.getElementById('reel-'+i).classList.add('spinning'));await new Promise(r=>setTimeout(r,600));
  try{const res=await fetch('/game/slots',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({bet})});const data=await res.json();
  [0,1,2].forEach(i=>{const el=document.getElementById('reel-'+i);el.classList.remove('spinning');el.textContent=data.reels?data.reels[i]:'?'});
  if(!res.ok)document.getElementById('slots-result').innerHTML=`<span class="result-lose">${data.error}</span>`;
  else{myCoins=data.coins;updateCoinDisplay();updateGameBalances();if(data.winAmount>0){document.getElementById('slots-result').innerHTML=`<span class="result-win">üéâ WIN! ${data.multiplier}x = +${formatNumber(data.winAmount)} coins!</span>`;soundWin()}else{document.getElementById('slots-result').innerHTML=`<span class="result-lose">No match. Better luck next time!</span>`;soundLose()}}}
  catch{document.getElementById('slots-result').innerHTML='<span class="result-lose">Error. Try again.</span>';[0,1,2].forEach(i=>document.getElementById('reel-'+i).classList.remove('spinning'))}
  slotsSpinning=false;btn.disabled=false;
}
let diceRolling=false;
async function playDice(){
  if(diceRolling)return;const bet=parseInt(document.getElementById('dice-bet').value,10);
  if(!bet||bet<1||bet>50000){document.getElementById('dice-result').innerHTML='<span class="result-lose">Bet must be 1-50000</span>';return}
  diceRolling=true;const btn=document.getElementById('dice-roll-btn');btn.disabled=true;
  document.getElementById('dice-player').textContent='üé≤';document.getElementById('dice-house').textContent='üé≤';document.getElementById('dice-result').textContent='';
  await new Promise(r=>setTimeout(r,500));
  try{const res=await fetch('/game/dice',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({bet})});const data=await res.json();
  if(!res.ok)document.getElementById('dice-result').innerHTML=`<span class="result-lose">${data.error}</span>`;
  else{document.getElementById('dice-player').textContent=data.playerRoll;document.getElementById('dice-house').textContent=data.houseRoll;myCoins=data.coins;updateCoinDisplay();updateGameBalances();
  if(data.result==='win'){document.getElementById('dice-result').innerHTML=`<span class="result-win">üéâ You win! +${formatNumber(data.winAmount)} coins!</span>`;soundWin()}
  else if(data.result==='tie')document.getElementById('dice-result').innerHTML=`<span class="result-tie">ü§ù Tie! Bet returned.</span>`;
  else{document.getElementById('dice-result').innerHTML=`<span class="result-lose">House wins. Better luck next time!</span>`;soundLose()}}}
  catch{document.getElementById('dice-result').innerHTML='<span class="result-lose">Error. Try again.</span>'}
  diceRolling=false;btn.disabled=false;
}
let rouletteSpinning=false;let selectedRouletteNumber=null;
async function playRoulette(betType){
  if(rouletteSpinning)return;const bet=parseInt(document.getElementById('roulette-bet').value,10);
  if(!bet||bet<1||bet>50000){document.getElementById('roulette-result').innerHTML='<span class="result-lose">Bet must be 1-50000</span>';return}
  if(betType==='number'&&selectedRouletteNumber===null){document.getElementById('roulette-result').innerHTML='<span class="result-lose">Select a number first!</span>';return}
  
  rouletteSpinning=true;const spinEl=document.getElementById('roulette-spin');spinEl.style.animation='none';document.getElementById('roulette-result').textContent='';
  await new Promise(r=>setTimeout(r,50));spinEl.style.animation='spin 2s linear 1';
  await new Promise(r=>setTimeout(r,2000));
  try{const res=await fetch('/game/roulette',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify({bet,betType:betType==='number'?selectedRouletteNumber:betType})});const data=await res.json();
  if(!res.ok)document.getElementById('roulette-result').innerHTML=`<span class="result-lose">${data.error}</span>`;
  else{spinEl.innerHTML=`<div style="font-size:28px;">${data.spinColor}</div><div>${data.spin}</div>`;myCoins=data.coins;updateCoinDisplay();updateGameBalances();
  if(data.result==='win'){const label=betType==='number'?`#${selectedRouletteNumber}`:betType;document.getElementById('roulette-result').innerHTML=`<span class="result-win">üéâ ${label} hits! +${formatNumber(data.winAmount)} coins!</span>`;soundWin()}
  else{document.getElementById('roulette-result').innerHTML=`<span class="result-lose">House wins. Better luck next time!</span>`;soundLose()}}}
  catch{document.getElementById('roulette-result').innerHTML='<span class="result-lose">Error. Try again.</span>'}
  rouletteSpinning=false;
}
function initRouletteNumbers(){
  const redNumbers=[1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
  const grid=document.getElementById('roulette-number-grid');grid.innerHTML='';
  for(let i=1;i<=36;i++){
    const btn=document.createElement('button');btn.className='roulette-num-btn '+(redNumbers.includes(i)?'red':'black');btn.innerHTML=`<div style="font-size:20px;">${redNumbers.includes(i)?'üî¥':'‚ö´'}</div><div>${i}</div>`;
    btn.onclick=()=>{selectedRouletteNumber=i;playRoulette('number')};
    grid.appendChild(btn);
  }
}
function playNumber(num){selectedRouletteNumber=num;playRoulette('number');}
async function loadLeaderboard(){
  const container=document.getElementById('leaderboard-rows');container.innerHTML='<div style="text-align:center;color:var(--text-system);padding:20px;">Loading...</div>';
  try{const res=await fetch('/leaderboard',{credentials:'include'});const data=await res.json();
  if(!res.ok){container.innerHTML='<div style="color:#cc0000;text-align:center;padding:12px;">Error loading.</div>';return}
  container.innerHTML=data.map((row,i)=>`<div class="lb-row"><span class="lb-rank">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':`#${i+1}`}</span><span class="lb-name">${escHtml(row.username)}</span><span class="lb-coins">ü™ô ${formatNumber(row.coins)}</span></div>`).join('')}
  catch{container.innerHTML='<div style="color:#cc0000;text-align:center;padding:12px;">Error loading.</div>'}
}


// ‚îÄ‚îÄ TICKERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(()=>{document.querySelectorAll('.user-entry').forEach(entry=>{const span=entry.querySelector('.utime');if(span)span.textContent=formatDuration(Date.now()-parseInt(entry.dataset.joinedAt,10))})},1000);
setInterval(()=>{document.querySelectorAll('.poll-timer').forEach(el=>{const left=Math.max(0,Math.ceil((parseInt(el.dataset.ends,10)-Date.now())/1000));if(left===0){el.textContent='ending...';el.classList.add('urgent')}else{const m=Math.floor(left/60),s=left%60;el.textContent=m>0?`${m}m ${s}s left`:`${s}s left`;el.classList.toggle('urgent',left<=30)}})},1000);

let activityThrottle=0;
document.addEventListener('keydown',e=>{
  const now=Date.now();if(now-activityThrottle>30000){activityThrottle=now;socket.emit('activity')}
  if(e.key==='Escape'){closeSettings();closeGames();closeShop();closeProfile();closeKeypad();closeRoomCreated();closeChangepass();}
});
document.getElementById('input').addEventListener('keydown',e=>{if(e.key==='Enter')send()});
['login-username','login-password'].forEach(id=>document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()}));
['reg-username','reg-password','reg-password2'].forEach(id=>document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')doRegister()}));

// ‚îÄ‚îÄ AUTO-LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
fetch('/me').then(async res=>{if(res.ok){const data=await res.json();enterChat(data.username,data.color,data.theme||'classic',data.coins||0,data.token,data.dailyAvailable)}});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <title>chatroom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: #000080;
      font-family: 'VT323', monospace;
      font-size: 18px;
      color: white;
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* â”€â”€ AUTH SCREEN â”€â”€ */
    #auth-screen {
      background: #c0c0c0;
      color: black;
      border: 3px solid;
      border-color: white #808080 #808080 white;
      width: 90%;
      max-width: 360px;
    }

    .auth-tabs {
      display: flex;
      border-bottom: 2px solid #808080;
    }

    .auth-tab {
      flex: 1;
      padding: 8px;
      background: #a0a0a0;
      border: none;
      font-family: 'VT323', monospace;
      font-size: 18px;
      cursor: pointer;
      border-right: 1px solid #808080;
      color: #444;
    }

    .auth-tab:last-child { border-right: none; }

    .auth-tab.active {
      background: #000080;
      color: white;
    }

    .auth-titlebar {
      background: #000080;
      color: white;
      padding: 6px 10px;
      font-size: 18px;
      letter-spacing: 1px;
    }

    .auth-body {
      padding: 20px;
    }

    .auth-panel { display: none; }
    .auth-panel.active { display: block; }

    .auth-panel p {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .auth-panel input {
      width: 100%;
      padding: 6px 8px;
      margin: 6px 0;
      font-family: 'VT323', monospace;
      font-size: 20px;
      border: 2px inset #808080;
      background: white;
    }

    .auth-panel button.primary {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      background: #000080;
      color: white;
      border: 2px solid;
      border-color: #6060c0 #000040 #000040 #6060c0;
      cursor: pointer;
      letter-spacing: 1px;
    }

    .auth-panel button.primary:active {
      border-color: #000040 #6060c0 #6060c0 #000040;
    }

    .auth-error {
      margin-top: 10px;
      color: #cc0000;
      font-size: 16px;
      min-height: 20px;
    }

    /* â”€â”€ CHAT SCREEN â”€â”€ */
    #chat-screen {
      display: none;
      flex-direction: column;
      width: 100%;
      height: 100vh;
      height: 100dvh;
      background: #c0c0c0;
      border: none;
    }

    @media (min-width: 600px) {
      #chat-screen {
        width: 700px;
        height: 90vh;
        border: 3px solid;
        border-color: white #808080 #808080 white;
      }
    }

    #titlebar {
      background: #000080;
      color: white;
      padding: 6px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      letter-spacing: 1px;
      flex-shrink: 0;
      gap: 8px;
    }

    #titlebar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    #logged-in-as {
      font-size: 14px;
      color: #aad4ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #user-count {
      font-size: 15px;
      background: #008080;
      padding: 2px 8px;
      border: 1px solid;
      border-color: #808080 white white #808080;
      white-space: nowrap;
      flex-shrink: 0;
    }

    #logout-btn {
      font-family: 'VT323', monospace;
      font-size: 14px;
      background: #800000;
      color: white;
      border: 1px solid;
      border-color: #ff8080 #400000 #400000 #ff8080;
      padding: 2px 8px;
      cursor: pointer;
      flex-shrink: 0;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: white;
      border: 2px inset #808080;
      margin: 8px 8px 4px 8px;
      font-size: 18px;
      line-height: 1.6;
      -webkit-overflow-scrolling: touch;
      color: black;
    }

    .msg-user { color: #000080; font-weight: bold; }
    .msg-system { color: #808080; font-style: italic; }
    .msg-text { color: black; }
    .msg-own .msg-user { color: #800000; }

    #bottom {
      display: flex;
      gap: 6px;
      padding: 8px;
      flex-shrink: 0;
    }

    #input {
      flex: 1;
      padding: 8px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      border: 2px inset #808080;
      min-width: 0;
      color: black;
    }

    #send-btn {
      padding: 8px 16px;
      font-family: 'VT323', monospace;
      font-size: 20px;
      background: #c0c0c0;
      border: 2px solid;
      border-color: white #808080 #808080 white;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }

    #send-btn:active {
      border-color: #808080 white white #808080;
    }
  </style>
</head>
<body>

  <!-- Auth Screen -->
  <div id="auth-screen">
    <div class="auth-titlebar">chatroom</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">Login</button>
      <button class="auth-tab" onclick="switchTab('register')">Register</button>
    </div>
    <div class="auth-body">

      <!-- Login -->
      <div id="login-panel" class="auth-panel active">
        <p>Sign in to your account:</p>
        <input id="login-username" type="text" placeholder="Username..." maxlength="20" autocomplete="username" />
        <input id="login-password" type="password" placeholder="Password..." autocomplete="current-password" />
        <button class="primary" onclick="doLogin()">Login</button>
        <div class="auth-error" id="login-error"></div>
      </div>

      <!-- Register -->
      <div id="register-panel" class="auth-panel">
        <p>Create a new account:</p>
        <input id="reg-username" type="text" placeholder="Username (3-20 chars)..." maxlength="20" autocomplete="username" />
        <input id="reg-password" type="password" placeholder="Password (min 6 chars)..." autocomplete="new-password" />
        <input id="reg-password2" type="password" placeholder="Confirm password..." autocomplete="new-password" />
        <button class="primary" onclick="doRegister()">Create Account</button>
        <div class="auth-error" id="register-error"></div>
      </div>

    </div>
  </div>

  <!-- Chat Screen -->
  <div id="chat-screen">
    <div id="titlebar">
      <div id="titlebar-left">
        <span>chatroom</span>
        <span id="logged-in-as"></span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;">
        <span id="user-count">ðŸ‘¤ 0 online</span>
        <button id="logout-btn" onclick="doLogout()">exit</button>
      </div>
    </div>
    <ul id="messages"></ul>
    <div id="bottom">
      <input id="input" placeholder="Type a message..." autocomplete="off" />
      <button id="send-btn" onclick="send()">Send</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io({ autoConnect: false });
    let myUsername = null;

    // â”€â”€ TAB SWITCHING â”€â”€
    function switchTab(tab) {
      document.querySelectorAll('.auth-tab').forEach((t, i) => {
        t.classList.toggle('active', (i === 0) === (tab === 'login'));
      });
      document.getElementById('login-panel').classList.toggle('active', tab === 'login');
      document.getElementById('register-panel').classList.toggle('active', tab === 'register');
    }

    // â”€â”€ AUTH â”€â”€
    async function doLogin() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errEl = document.getElementById('login-error');
      errEl.textContent = '';

      if (!username || !password) { errEl.textContent = 'Please fill in all fields.'; return; }

      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();

      if (!res.ok) { errEl.textContent = data.error; return; }
      enterChat(data.username);
    }

    async function doRegister() {
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value;
      const password2 = document.getElementById('reg-password2').value;
      const errEl = document.getElementById('register-error');
      errEl.textContent = '';

      if (!username || !password || !password2) { errEl.textContent = 'Please fill in all fields.'; return; }
      if (password !== password2) { errEl.textContent = 'Passwords do not match.'; return; }

      const res = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();

      if (!res.ok) { errEl.textContent = data.error; return; }
      enterChat(data.username);
    }

    async function doLogout() {
      await fetch('/logout', { method: 'POST' });
      socket.disconnect();
      location.reload();
    }

    // â”€â”€ CHAT â”€â”€
    function enterChat(username) {
      myUsername = username;
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'flex';
      document.getElementById('logged-in-as').textContent = `[${username}]`;
      document.getElementById('input').focus();

      socket.connect();
      socket.emit('join', username);
    }

    function send() {
      const input = document.getElementById('input');
      const text = input.value.trim();
      if (!text) return;
      socket.emit('chat message', text);
      input.value = '';
    }

    document.getElementById('input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') send();
    });

    // Enter key on auth inputs
    ['login-username','login-password'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
    });
    ['reg-username','reg-password','reg-password2'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') doRegister(); });
    });

    // â”€â”€ SOCKET EVENTS â”€â”€
    socket.on('chat message', ({ user, text }) => {
      const isOwn = user === myUsername;
      addMessage(
        `<span class="msg-user">${user}:</span> <span class="msg-text">${text}</span>`,
        isOwn ? 'msg-own' : ''
      );
    });

    socket.on('system message', (msg) => {
      addMessage(`<span class="msg-system">*** ${msg} ***</span>`);
    });

    socket.on('user count', (count) => {
      document.getElementById('user-count').textContent = `ðŸ‘¤ ${count} online`;
    });

    function addMessage(html, extraClass = '') {
      const messages = document.getElementById('messages');
      const li = document.createElement('li');
      li.style.listStyle = 'none';
      li.style.padding = '2px 0';
      if (extraClass) li.classList.add(extraClass);
      li.innerHTML = html; // safe â€” server-side escaped before broadcast
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    // â”€â”€ CHECK IF ALREADY LOGGED IN (session persists on refresh) â”€â”€
    fetch('/me').then(async res => {
      if (res.ok) {
        const data = await res.json();
        enterChat(data.username);
      }
    });
  </script>
</body>
</html>